---
dg-publish: true
dg-permalink: /å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /Attentionæ³¨æ„åŠ›æœºåˆ¶/KV-CacheæŠ€æœ¯è¯¦è§£ï¼šä¼˜åŒ–Transformerè‡ªå›å½’ç”Ÿæˆæ•ˆç‡
dg-home: false
dg-description: åœ¨æ­¤è¾“å…¥ç¬”è®°çš„æè¿°
dg-hide: false
dg-hide-title: false
dg-show-backlinks: true
dg-show-local-graph: true
dg-show-inline-title: true
dg-pinned: false
dg-passphrase: åœ¨æ­¤è¾“å…¥è®¿é—®å¯†ç 
dg-enable-mathjax: false
dg-enable-mermaid: false
dg-enable-uml: false
dg-note-icon: 0
dg-enable-dataview: false
tags:
  - NLP
permalink: /å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /Attentionæ³¨æ„åŠ›æœºåˆ¶/KV-CacheæŠ€æœ¯è¯¦è§£ï¼šä¼˜åŒ–Transformerè‡ªå›å½’ç”Ÿæˆæ•ˆç‡/
dgShowBacklinks: true
dgShowLocalGraph: true
dgShowInlineTitle: true
dgPassFrontmatter: true
noteIcon: 0
created: 2025-04-04T11:10:49.000+08:00
updated: 2025-04-13T13:06:02.000+08:00
title: KV CacheæŠ€æœ¯è¯¦è§£ï¼šä¼˜åŒ–Transformerè‡ªå›å½’ç”Ÿæˆæ•ˆç‡
createTime: 2025/05/13 17:33:53
---



### åšå®¢æ ‡é¢˜ï¼šKV CacheæŠ€æœ¯è¯¦è§£ï¼šä¼˜åŒ–Transformerè‡ªå›å½’ç”Ÿæˆæ•ˆç‡  
---


### å…ƒæ•°æ®  
**åˆ†ç±»**ï¼šæ·±åº¦å­¦ä¹ æŠ€æœ¯  
**æ ‡ç­¾**ï¼šKV Cacheã€Transformerã€Attentionæœºåˆ¶ã€è‡ªå›å½’ç”Ÿæˆ  
**æ—¥æœŸ**ï¼š2024å¹´10æœˆ2æ—¥    

---



## KV CacheæŠ€æœ¯ç®€ä»‹  
KV Cacheï¼ˆé”®å€¼ç¼“å­˜ï¼‰æ˜¯ä¸€ç§ç”¨äºä¼˜åŒ–Transformerç»“æ„ä¸­è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹çš„æŠ€æœ¯ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ç¼“å­˜Attentionæœºåˆ¶ä¸­çš„Keyï¼ˆKï¼‰å’ŒValueï¼ˆVï¼‰çŠ¶æ€å€¼ï¼Œä»è€Œé¿å…é‡å¤è®¡ç®—ï¼Œæå‡æ¨¡å‹æ¨ç†æ•ˆç‡ã€‚  

åœ¨è‡ªå›å½’ç”Ÿæˆä¸­ï¼Œæ¨¡å‹éœ€è¦é€ä¸ªç”ŸæˆTokenï¼Œæ¯æ¬¡ç”Ÿæˆæ–°çš„Tokenæ—¶éƒ½éœ€è¦è®¡ç®—ä¹‹å‰æ‰€æœ‰Tokençš„Attentionå€¼ã€‚KV Cacheé€šè¿‡å°†è¿™äº›è®¡ç®—ç»“æœç¼“å­˜ä¸‹æ¥ï¼Œä½¿å¾—åç»­ç”Ÿæˆè¿‡ç¨‹å¯ä»¥ç›´æ¥å¤ç”¨ä¹‹å‰çš„è®¡ç®—ç»“æœã€‚  

---



## KV Cacheå·¥ä½œåŸç†  
ğŸ’¡ **æ ¸å¿ƒæ¦‚å¿µ**ï¼š  
KV CacheæŠ€æœ¯ä¸»è¦åº”ç”¨äºCausal Attentionï¼Œå³å› æœæ³¨æ„åŠ›æœºåˆ¶ã€‚åœ¨é€’å½’ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªæ–°Tokençš„ç”Ÿæˆéƒ½ä¼šä¾èµ–äºä¹‹å‰æ‰€æœ‰Tokençš„Keyå’ŒValueå‘é‡ã€‚ä»¥ä¸‹æ˜¯å…·ä½“åŸç†ï¼š  

âœ… **æ­¥éª¤è§£æ**ï¼š
1. **ç¼“å­˜åˆå§‹åŒ–**ï¼šåœ¨ç”Ÿæˆç¬¬ä¸€ä¸ªTokenæ—¶ï¼Œæ¨¡å‹è®¡ç®—å…¶å¯¹åº”çš„Keyå’ŒValueå‘é‡å¹¶å­˜å‚¨ã€‚
2. **é€’å½’å¤ç”¨**ï¼šå½“ç”Ÿæˆåç»­Tokenæ—¶ï¼Œæ¨¡å‹ç›´æ¥å¤ç”¨å‰é¢å·²ç¼“å­˜çš„Keyå’ŒValueï¼Œæ— éœ€é‡æ–°è®¡ç®—ã€‚
3. **çŸ©é˜µæ‹¼æ¥**ï¼šé€šè¿‡åˆ†å—çŸ©é˜µæ‹¼æ¥ï¼Œç¡®ä¿è®¡ç®—ç»“æœä¸ä¸ä½¿ç”¨ç¼“å­˜æ—¶ä¿æŒä¸€è‡´ã€‚

---



## KV Cache vs ä¸ä½¿ç”¨ç¼“å­˜  
ä»¥ä¸‹æ˜¯å¯¹æ¯”ä¸¤ç§ç”Ÿæˆæµç¨‹çš„ç¤ºä¾‹ï¼š

### ä¸ä½¿ç”¨KV Cacheçš„æµç¨‹  
å‡è®¾ç›®æ ‡è¾“å‡ºä¸ºâ€œå”±è·³ç¯®çƒâ€ï¼Œæˆ‘ä»¬åˆ†æ­¥éª¤åˆ†æï¼š  

| **æ­¥éª¤**        | **è¾“å…¥åºåˆ—** | **è®¡ç®—å†…å®¹**                                                                 |
|------------------|--------------|------------------------------------------------------------------------------|
| ç¬¬ä¸€ä¸ªTokenç”Ÿæˆ | `<s>`        | è®¡ç®—å½“å‰Tokençš„Qã€Kã€Vå‘é‡å¹¶å®ŒæˆAttention                                   |
| ç¬¬äºŒä¸ªTokenç”Ÿæˆ | `<s>å”±`      | é‡æ–°è®¡ç®—æ‰€æœ‰å‰åºTokençš„Kã€Vå‘é‡ï¼Œå¹¶å®ŒæˆAttention                             |


### ä½¿ç”¨KV Cacheçš„æµç¨‹  
| **æ­¥éª¤**        | **è¾“å…¥åºåˆ—** | **è®¡ç®—å†…å®¹**                                                                 |
|------------------|--------------|------------------------------------------------------------------------------|
| ç¬¬ä¸€ä¸ªTokenç”Ÿæˆ | `<s>`        | è®¡ç®—å½“å‰Tokençš„Qã€Kã€Vå‘é‡å¹¶ç¼“å­˜                                             |
| ç¬¬äºŒä¸ªTokenç”Ÿæˆ | `<s>å”±`      | ç›´æ¥å¤ç”¨å‰åºTokençš„Kã€Vç¼“å­˜ï¼Œä»…è®¡ç®—å½“å‰Tokençš„Qå‘é‡ä¸ç¼“å­˜çš„Kã€Väº¤äº’          |

ğŸ“ˆ **è¶‹åŠ¿é¢„æµ‹**ï¼šéšç€æ¨¡å‹å¤æ‚åº¦å’Œåºåˆ—é•¿åº¦å¢åŠ ï¼ŒKV CacheæŠ€æœ¯çš„ä¼˜åŠ¿å°†æ›´åŠ æ˜¾è‘—ã€‚

---



## æŠ€æœ¯å®ç°ç¤ºä¾‹  
ä»¥ä¸‹æ˜¯Attentionæœºåˆ¶çš„ç®€åŒ–å…¬å¼ï¼Œç”¨äºå±•ç¤ºKV Cacheå¦‚ä½•ä¼˜åŒ–è®¡ç®—ï¼š

```python
# ä¸ä½¿ç”¨KV Cache
Att(Q, K, V) = softmax(Q @ K.T) @ V

# ä½¿ç”¨KV Cache
# å‡è®¾K_cacheå’ŒV_cacheä¸ºä¹‹å‰å­˜å‚¨çš„Keyå’ŒValue
Att(Q_new, K_cache, V_cache) = softmax(Q_new @ K_cache.T) @ V_cache
```

---



## å¸¸è§é”™è¯¯åŠè­¦å‘Š  
âš ï¸ **é”™è¯¯1ï¼šæœªæ­£ç¡®åˆå§‹åŒ–ç¼“å­˜**  
è‹¥åœ¨åˆå§‹é˜¶æ®µæœªå­˜å‚¨Keyå’ŒValueå‘é‡ï¼Œä¼šå¯¼è‡´åç»­ç”Ÿæˆæ— æ³•å¤ç”¨ç¼“å­˜ã€‚  

âš ï¸ **é”™è¯¯2ï¼šç¼“å­˜æº¢å‡ºé—®é¢˜**  
å½“åºåˆ—é•¿åº¦è¿‡é•¿æ—¶ï¼Œç¼“å­˜å ç”¨å†…å­˜å¯èƒ½è¿‡é«˜ï¼Œéœ€è¦è®¾è®¡é«˜æ•ˆçš„æ¸…ç†ç­–ç•¥ã€‚  

---



## ğŸ’¡å¯å‘ç‚¹  
- KV CacheæŠ€æœ¯ä¸ä»…æå‡äº†æ¨ç†æ•ˆç‡ï¼Œè¿˜ä¸ºé•¿åºåˆ—ç”Ÿæˆæä¾›äº†å¯èƒ½æ€§ã€‚  
- åœ¨åº”ç”¨åœºæ™¯ä¸­ï¼Œå¦‚å®æ—¶å¯¹è¯ç”Ÿæˆæˆ–ä»£ç è¡¥å…¨ï¼ŒKV Cacheèƒ½å¤Ÿæ˜¾è‘—é™ä½å»¶è¿Ÿã€‚  

---



## [æ€è€ƒ]æ¿å—  
1. å¦‚ä½•è®¾è®¡åŠ¨æ€æ¸…ç†ç­–ç•¥ä»¥åº”å¯¹è¶…é•¿åºåˆ—ç¼“å­˜é—®é¢˜ï¼Ÿ  
2. KV Cacheèƒ½å¦åº”ç”¨äºéè‡ªå›å½’ä»»åŠ¡ï¼Œå¦‚æ–‡æœ¬åˆ†ç±»æˆ–æ‘˜è¦ç”Ÿæˆï¼Ÿ  
3. æ˜¯å¦å¯ä»¥ç»“åˆå…¶ä»–ä¼˜åŒ–æŠ€æœ¯ï¼ˆå¦‚Sparse Attentionï¼‰è¿›ä¸€æ­¥æå‡æ•ˆç‡ï¼Ÿ  

---



## è¡ŒåŠ¨æ¸…å•  
âœ… å­¦ä¹ Transformerä¸­Attentionæœºåˆ¶çš„æ•°å­¦åŸç†  
âœ… å®ç°ä¸€ä¸ªç®€å•çš„KV CacheåŠŸèƒ½æ¨¡å—ï¼Œæµ‹è¯•æ€§èƒ½æå‡æƒ…å†µ  
âœ… æ¢ç´¢KV Cacheåœ¨å¤šæ¨¡æ€ä»»åŠ¡ä¸­çš„åº”ç”¨å¯èƒ½æ€§  

---

> åŸå§‹å‡ºå¤„ï¼šã€ŠKV Cache é”®å€¼ç¼“å­˜æŠ€æœ¯è¯¦è§£ã€‹
