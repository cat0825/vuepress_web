{"content":"<h2 id=\"å…ƒæ•°æ®\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å…ƒæ•°æ®\"><span>å…ƒæ•°æ®</span></a></h2>\n<ul>\n<li>åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ </li>\n<li>æ ‡ç­¾ï¼šX-Lora, é¢„è®­ç»ƒæ¨¡å‹, åŠ¨æ€ç¼©æ”¾, ä½ç§©é€‚åº”</li>\n<li>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</li>\n</ul>\n<h2 id=\"æ ¸å¿ƒè§‚ç‚¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒè§‚ç‚¹\"><span>æ ¸å¿ƒè§‚ç‚¹</span></a></h2>\n<p>X-Loraé€šè¿‡ç»“åˆå¤šä¸ªä¸åŒé¢†åŸŸçš„é¢„è®­ç»ƒçš„Loraæ¨¡å‹ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå¯è®­ç»ƒçš„ç¼©æ”¾å¤´æ¥åŠ¨æ€è°ƒæ•´æ¯ä¸ªLoraæ¨¡å‹çš„è´¡çŒ®ã€‚è¿™ç§æ–¹æ³•å…è®¸åœ¨ä¸åŒä»»åŠ¡ä¸­çµæ´»åº”ç”¨å¤šä¸ªä½ç§©é€‚åº”æŠ€æœ¯ï¼Œä»¥æé«˜æ¨¡å‹çš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</p>\n<p><img src=\"/img/user/é™„ä»¶/Pasted image 20250424111942.png\" alt=\"Pasted image 20250424111942.png\"></p>\n<h2 id=\"é‡ç‚¹å†…å®¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#é‡ç‚¹å†…å®¹\"><span>é‡ç‚¹å†…å®¹</span></a></h2>\n<h3 id=\"åŠ¨æ€ç¼©æ”¾æœºåˆ¶\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#åŠ¨æ€ç¼©æ”¾æœºåˆ¶\"><span>åŠ¨æ€ç¼©æ”¾æœºåˆ¶</span></a></h3>\n<p>X-Loraä½¿ç”¨ä¸€ä¸ªåŠ¨æ€ç¼©æ”¾æœºåˆ¶æ¥è°ƒæ•´æ¯ä¸ªLoraæ¨¡å‹åœ¨æœ€ç»ˆè¾“å‡ºä¸­çš„è´¡çŒ®ã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬ï¼š</p>\n<ol>\n<li><strong>è·å–ç¼©æ”¾å€¼</strong>ï¼šä»ç»™å®šçš„ç¼©æ”¾çŸ©é˜µä¸­æå–ç‰¹å®šå±‚çš„ç¼©æ”¾å€¼ã€‚</li>\n<li><strong>é€‰æ‹©Top-Kç¼©æ”¾</strong>ï¼šæ ¹æ®é…ç½®ï¼Œé€‰æ‹©è´¡çŒ®æœ€å¤§çš„Top-Kä¸ªç¼©æ”¾å€¼ã€‚</li>\n<li><strong>åº”ç”¨Softmax</strong>ï¼šå¦‚æœå¯ç”¨ï¼Œä½¿ç”¨Softmaxå‡½æ•°å¯¹éé›¶ç¼©æ”¾å€¼è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ã€‚</li>\n</ol>\n<h3 id=\"xloralinearlayerçš„å‰å‘ä¼ æ’­\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#xloralinearlayerçš„å‰å‘ä¼ æ’­\"><span>XLoraLinearLayerçš„å‰å‘ä¼ æ’­</span></a></h3>\n<p>åœ¨XLoraLinearLayerç±»ä¸­ï¼Œå‰å‘ä¼ æ’­è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>æ£€æŸ¥ç›®æ ‡æ˜¯å¦å·²åˆå¹¶ã€‚</li>\n<li>éå†æ¯ä¸ªæ´»è·ƒçš„é€‚é…å™¨ï¼Œè·å–ç›¸åº”çš„Loraæƒé‡å’Œç¼©æ”¾å‚æ•°ã€‚</li>\n<li>æ ¹æ®éœ€è¦åº”ç”¨ç¼©æ”¾è°ƒæ•´ã€‚</li>\n<li>è®¡ç®—ç»“æœå¹¶è¿”å›ã€‚</li>\n</ol>\n<h3 id=\"ä»£ç ç¤ºä¾‹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ä»£ç ç¤ºä¾‹\"><span>ä»£ç ç¤ºä¾‹</span></a></h3>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> get_maybe_topk_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> -></span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    xlora_scalings </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[:,</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :,</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">layer_number</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :]</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">top_k_lora </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">is</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> not</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> None</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        _</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> topk_indices </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">topk</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> k</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">top_k_lora</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dim</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        mask </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">zeros_like</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">bool</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        mask</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">scatter_</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> topk_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> True</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        xlora_scalings </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> xlora_scalings </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> mask</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">to</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">enable_softmax_topk</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        nonzero_mask </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> xlora_scalings </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">!=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 0</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        softmax_res_nonzero </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">softmax</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nonzero_mask</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">],</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dim</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nonzero_mask</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> softmax_res_nonzero</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> xlora_scalings</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3 id=\"ğŸ’¡-å¯å‘ç‚¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ğŸ’¡-å¯å‘ç‚¹\"><span>ğŸ’¡ å¯å‘ç‚¹</span></a></h3>\n<p>è¿™ç§æ–¹æ³•ä¸ä»…æé«˜äº†æ¨¡å‹åœ¨ç‰¹å®šä»»åŠ¡ä¸Šçš„é€‚åº”èƒ½åŠ›ï¼Œè¿˜å¯ä»¥åœ¨ä¸æ˜¾è‘—å¢åŠ è®¡ç®—æˆæœ¬çš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨å¤šä¸ªé¢†åŸŸçš„çŸ¥è¯†ã€‚</p>\n<h2 id=\"è­¦å‘ŠåŒºå—\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è­¦å‘ŠåŒºå—\"><span>è­¦å‘ŠåŒºå—</span></a></h2>\n<p>âš ï¸ å¸¸è§é”™è¯¯ï¼šç¡®ä¿åœ¨åº”ç”¨ç¼©æ”¾æ—¶ï¼Œéé›¶æ©ç å’ŒSoftmaxå‡½æ•°æ­£ç¡®é…ç½®ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´ç¼©æ”¾ä¸å‡†ç¡®ã€‚</p>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ul>\n<li>æ¢ç´¢æ›´å¤šçš„ä½ç§©é€‚åº”æŠ€æœ¯ä¸X-Loraç»“åˆçš„å¯èƒ½æ€§ã€‚</li>\n<li>è¯„ä¼°X-Loraåœ¨ä¸åŒé¢†åŸŸä»»åŠ¡ä¸­çš„æ€§èƒ½è¡¨ç°ã€‚</li>\n<li>ä¼˜åŒ–åŠ¨æ€ç¼©æ”¾å¤´çš„è®­ç»ƒç­–ç•¥ä»¥æé«˜æ¨¡å‹æ•ˆç‡ã€‚</li>\n</ul>\n<blockquote>\n<p>åŸå§‹å‡ºå¤„ï¼š<a href=\"https://example.com\" target=\"_blank\" rel=\"noopener noreferrer\">LoRA: Low-Rank Adaptation of Large Language Models</a></p>\n</blockquote>\n","env":{"base":"/","filePath":"/Users/qianyuhe/Desktop/my-project/docs/notes_bak/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/LoRAåŠå…¶å˜ä½“/X-LoRA.md","filePathRelative":"notes_bak/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/LoRAåŠå…¶å˜ä½“/X-LoRA.md","frontmatter":{"dg-publish":true,"dg-permalink":"/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/LoRAåŠå…¶å˜ä½“/X-LoRA","dg-home":false,"dg-description":"åœ¨æ­¤è¾“å…¥ç¬”è®°çš„æè¿°","dg-hide":false,"dg-hide-title":false,"dg-show-backlinks":true,"dg-show-local-graph":true,"dg-show-inline-title":true,"dg-pinned":false,"dg-passphrase":"åœ¨æ­¤è¾“å…¥è®¿é—®å¯†ç ","dg-enable-mathjax":false,"dg-enable-mermaid":false,"dg-enable-uml":false,"dg-note-icon":0,"dg-enable-dataview":false,"tags":["NLP"],"permalink":"/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/LoRAåŠå…¶å˜ä½“/X-LoRA/","dgShowBacklinks":true,"dgShowLocalGraph":true,"dgShowInlineTitle":true,"dgPassFrontmatter":true,"noteIcon":0,"created":"2025-04-24T03:19:18.000Z","updated":"2025-04-24T03:21:31.000Z","title":"X-LoRA","createTime":"2025/05/13 17:33:52"},"sfcBlocks":{"template":{"type":"template","content":"<template><h2 id=\"å…ƒæ•°æ®\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å…ƒæ•°æ®\"><span>å…ƒæ•°æ®</span></a></h2>\n<ul>\n<li>åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ </li>\n<li>æ ‡ç­¾ï¼šX-Lora, é¢„è®­ç»ƒæ¨¡å‹, åŠ¨æ€ç¼©æ”¾, ä½ç§©é€‚åº”</li>\n<li>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</li>\n</ul>\n<h2 id=\"æ ¸å¿ƒè§‚ç‚¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒè§‚ç‚¹\"><span>æ ¸å¿ƒè§‚ç‚¹</span></a></h2>\n<p>X-Loraé€šè¿‡ç»“åˆå¤šä¸ªä¸åŒé¢†åŸŸçš„é¢„è®­ç»ƒçš„Loraæ¨¡å‹ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå¯è®­ç»ƒçš„ç¼©æ”¾å¤´æ¥åŠ¨æ€è°ƒæ•´æ¯ä¸ªLoraæ¨¡å‹çš„è´¡çŒ®ã€‚è¿™ç§æ–¹æ³•å…è®¸åœ¨ä¸åŒä»»åŠ¡ä¸­çµæ´»åº”ç”¨å¤šä¸ªä½ç§©é€‚åº”æŠ€æœ¯ï¼Œä»¥æé«˜æ¨¡å‹çš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</p>\n<p><img src=\"/img/user/é™„ä»¶/Pasted image 20250424111942.png\" alt=\"Pasted image 20250424111942.png\"></p>\n<h2 id=\"é‡ç‚¹å†…å®¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#é‡ç‚¹å†…å®¹\"><span>é‡ç‚¹å†…å®¹</span></a></h2>\n<h3 id=\"åŠ¨æ€ç¼©æ”¾æœºåˆ¶\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#åŠ¨æ€ç¼©æ”¾æœºåˆ¶\"><span>åŠ¨æ€ç¼©æ”¾æœºåˆ¶</span></a></h3>\n<p>X-Loraä½¿ç”¨ä¸€ä¸ªåŠ¨æ€ç¼©æ”¾æœºåˆ¶æ¥è°ƒæ•´æ¯ä¸ªLoraæ¨¡å‹åœ¨æœ€ç»ˆè¾“å‡ºä¸­çš„è´¡çŒ®ã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬ï¼š</p>\n<ol>\n<li><strong>è·å–ç¼©æ”¾å€¼</strong>ï¼šä»ç»™å®šçš„ç¼©æ”¾çŸ©é˜µä¸­æå–ç‰¹å®šå±‚çš„ç¼©æ”¾å€¼ã€‚</li>\n<li><strong>é€‰æ‹©Top-Kç¼©æ”¾</strong>ï¼šæ ¹æ®é…ç½®ï¼Œé€‰æ‹©è´¡çŒ®æœ€å¤§çš„Top-Kä¸ªç¼©æ”¾å€¼ã€‚</li>\n<li><strong>åº”ç”¨Softmax</strong>ï¼šå¦‚æœå¯ç”¨ï¼Œä½¿ç”¨Softmaxå‡½æ•°å¯¹éé›¶ç¼©æ”¾å€¼è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ã€‚</li>\n</ol>\n<h3 id=\"xloralinearlayerçš„å‰å‘ä¼ æ’­\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#xloralinearlayerçš„å‰å‘ä¼ æ’­\"><span>XLoraLinearLayerçš„å‰å‘ä¼ æ’­</span></a></h3>\n<p>åœ¨XLoraLinearLayerç±»ä¸­ï¼Œå‰å‘ä¼ æ’­è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>æ£€æŸ¥ç›®æ ‡æ˜¯å¦å·²åˆå¹¶ã€‚</li>\n<li>éå†æ¯ä¸ªæ´»è·ƒçš„é€‚é…å™¨ï¼Œè·å–ç›¸åº”çš„Loraæƒé‡å’Œç¼©æ”¾å‚æ•°ã€‚</li>\n<li>æ ¹æ®éœ€è¦åº”ç”¨ç¼©æ”¾è°ƒæ•´ã€‚</li>\n<li>è®¡ç®—ç»“æœå¹¶è¿”å›ã€‚</li>\n</ol>\n<h3 id=\"ä»£ç ç¤ºä¾‹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ä»£ç ç¤ºä¾‹\"><span>ä»£ç ç¤ºä¾‹</span></a></h3>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> get_maybe_topk_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> -></span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    xlora_scalings </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[:,</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :,</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">layer_number</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :]</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">top_k_lora </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">is</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> not</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> None</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        _</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> topk_indices </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">topk</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> k</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">top_k_lora</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dim</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        mask </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">zeros_like</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">bool</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        mask</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">scatter_</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> topk_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> True</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        xlora_scalings </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> xlora_scalings </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> mask</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">to</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">enable_softmax_topk</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        nonzero_mask </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> xlora_scalings </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">!=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 0</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        softmax_res_nonzero </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">softmax</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nonzero_mask</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">],</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dim</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nonzero_mask</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> softmax_res_nonzero</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> xlora_scalings</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3 id=\"ğŸ’¡-å¯å‘ç‚¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ğŸ’¡-å¯å‘ç‚¹\"><span>ğŸ’¡ å¯å‘ç‚¹</span></a></h3>\n<p>è¿™ç§æ–¹æ³•ä¸ä»…æé«˜äº†æ¨¡å‹åœ¨ç‰¹å®šä»»åŠ¡ä¸Šçš„é€‚åº”èƒ½åŠ›ï¼Œè¿˜å¯ä»¥åœ¨ä¸æ˜¾è‘—å¢åŠ è®¡ç®—æˆæœ¬çš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨å¤šä¸ªé¢†åŸŸçš„çŸ¥è¯†ã€‚</p>\n<h2 id=\"è­¦å‘ŠåŒºå—\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è­¦å‘ŠåŒºå—\"><span>è­¦å‘ŠåŒºå—</span></a></h2>\n<p>âš ï¸ å¸¸è§é”™è¯¯ï¼šç¡®ä¿åœ¨åº”ç”¨ç¼©æ”¾æ—¶ï¼Œéé›¶æ©ç å’ŒSoftmaxå‡½æ•°æ­£ç¡®é…ç½®ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´ç¼©æ”¾ä¸å‡†ç¡®ã€‚</p>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ul>\n<li>æ¢ç´¢æ›´å¤šçš„ä½ç§©é€‚åº”æŠ€æœ¯ä¸X-Loraç»“åˆçš„å¯èƒ½æ€§ã€‚</li>\n<li>è¯„ä¼°X-Loraåœ¨ä¸åŒé¢†åŸŸä»»åŠ¡ä¸­çš„æ€§èƒ½è¡¨ç°ã€‚</li>\n<li>ä¼˜åŒ–åŠ¨æ€ç¼©æ”¾å¤´çš„è®­ç»ƒç­–ç•¥ä»¥æé«˜æ¨¡å‹æ•ˆç‡ã€‚</li>\n</ul>\n<blockquote>\n<p>åŸå§‹å‡ºå¤„ï¼š<a href=\"https://example.com\" target=\"_blank\" rel=\"noopener noreferrer\">LoRA: Low-Rank Adaptation of Large Language Models</a></p>\n</blockquote>\n</template>","contentStripped":"<h2 id=\"å…ƒæ•°æ®\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å…ƒæ•°æ®\"><span>å…ƒæ•°æ®</span></a></h2>\n<ul>\n<li>åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ </li>\n<li>æ ‡ç­¾ï¼šX-Lora, é¢„è®­ç»ƒæ¨¡å‹, åŠ¨æ€ç¼©æ”¾, ä½ç§©é€‚åº”</li>\n<li>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</li>\n</ul>\n<h2 id=\"æ ¸å¿ƒè§‚ç‚¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒè§‚ç‚¹\"><span>æ ¸å¿ƒè§‚ç‚¹</span></a></h2>\n<p>X-Loraé€šè¿‡ç»“åˆå¤šä¸ªä¸åŒé¢†åŸŸçš„é¢„è®­ç»ƒçš„Loraæ¨¡å‹ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå¯è®­ç»ƒçš„ç¼©æ”¾å¤´æ¥åŠ¨æ€è°ƒæ•´æ¯ä¸ªLoraæ¨¡å‹çš„è´¡çŒ®ã€‚è¿™ç§æ–¹æ³•å…è®¸åœ¨ä¸åŒä»»åŠ¡ä¸­çµæ´»åº”ç”¨å¤šä¸ªä½ç§©é€‚åº”æŠ€æœ¯ï¼Œä»¥æé«˜æ¨¡å‹çš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</p>\n<p><img src=\"/img/user/é™„ä»¶/Pasted image 20250424111942.png\" alt=\"Pasted image 20250424111942.png\"></p>\n<h2 id=\"é‡ç‚¹å†…å®¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#é‡ç‚¹å†…å®¹\"><span>é‡ç‚¹å†…å®¹</span></a></h2>\n<h3 id=\"åŠ¨æ€ç¼©æ”¾æœºåˆ¶\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#åŠ¨æ€ç¼©æ”¾æœºåˆ¶\"><span>åŠ¨æ€ç¼©æ”¾æœºåˆ¶</span></a></h3>\n<p>X-Loraä½¿ç”¨ä¸€ä¸ªåŠ¨æ€ç¼©æ”¾æœºåˆ¶æ¥è°ƒæ•´æ¯ä¸ªLoraæ¨¡å‹åœ¨æœ€ç»ˆè¾“å‡ºä¸­çš„è´¡çŒ®ã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬ï¼š</p>\n<ol>\n<li><strong>è·å–ç¼©æ”¾å€¼</strong>ï¼šä»ç»™å®šçš„ç¼©æ”¾çŸ©é˜µä¸­æå–ç‰¹å®šå±‚çš„ç¼©æ”¾å€¼ã€‚</li>\n<li><strong>é€‰æ‹©Top-Kç¼©æ”¾</strong>ï¼šæ ¹æ®é…ç½®ï¼Œé€‰æ‹©è´¡çŒ®æœ€å¤§çš„Top-Kä¸ªç¼©æ”¾å€¼ã€‚</li>\n<li><strong>åº”ç”¨Softmax</strong>ï¼šå¦‚æœå¯ç”¨ï¼Œä½¿ç”¨Softmaxå‡½æ•°å¯¹éé›¶ç¼©æ”¾å€¼è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ã€‚</li>\n</ol>\n<h3 id=\"xloralinearlayerçš„å‰å‘ä¼ æ’­\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#xloralinearlayerçš„å‰å‘ä¼ æ’­\"><span>XLoraLinearLayerçš„å‰å‘ä¼ æ’­</span></a></h3>\n<p>åœ¨XLoraLinearLayerç±»ä¸­ï¼Œå‰å‘ä¼ æ’­è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>æ£€æŸ¥ç›®æ ‡æ˜¯å¦å·²åˆå¹¶ã€‚</li>\n<li>éå†æ¯ä¸ªæ´»è·ƒçš„é€‚é…å™¨ï¼Œè·å–ç›¸åº”çš„Loraæƒé‡å’Œç¼©æ”¾å‚æ•°ã€‚</li>\n<li>æ ¹æ®éœ€è¦åº”ç”¨ç¼©æ”¾è°ƒæ•´ã€‚</li>\n<li>è®¡ç®—ç»“æœå¹¶è¿”å›ã€‚</li>\n</ol>\n<h3 id=\"ä»£ç ç¤ºä¾‹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ä»£ç ç¤ºä¾‹\"><span>ä»£ç ç¤ºä¾‹</span></a></h3>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> get_maybe_topk_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> -></span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    xlora_scalings </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[:,</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :,</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">layer_number</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :]</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">top_k_lora </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">is</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> not</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> None</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        _</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> topk_indices </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">topk</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> k</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">top_k_lora</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dim</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        mask </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">zeros_like</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">bool</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        mask</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">scatter_</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> topk_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> True</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        xlora_scalings </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> xlora_scalings </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> mask</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">to</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">enable_softmax_topk</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        nonzero_mask </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> xlora_scalings </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">!=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 0</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        softmax_res_nonzero </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">softmax</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nonzero_mask</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">],</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dim</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        xlora_scalings</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nonzero_mask</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> softmax_res_nonzero</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> xlora_scalings</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3 id=\"ğŸ’¡-å¯å‘ç‚¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ğŸ’¡-å¯å‘ç‚¹\"><span>ğŸ’¡ å¯å‘ç‚¹</span></a></h3>\n<p>è¿™ç§æ–¹æ³•ä¸ä»…æé«˜äº†æ¨¡å‹åœ¨ç‰¹å®šä»»åŠ¡ä¸Šçš„é€‚åº”èƒ½åŠ›ï¼Œè¿˜å¯ä»¥åœ¨ä¸æ˜¾è‘—å¢åŠ è®¡ç®—æˆæœ¬çš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨å¤šä¸ªé¢†åŸŸçš„çŸ¥è¯†ã€‚</p>\n<h2 id=\"è­¦å‘ŠåŒºå—\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è­¦å‘ŠåŒºå—\"><span>è­¦å‘ŠåŒºå—</span></a></h2>\n<p>âš ï¸ å¸¸è§é”™è¯¯ï¼šç¡®ä¿åœ¨åº”ç”¨ç¼©æ”¾æ—¶ï¼Œéé›¶æ©ç å’ŒSoftmaxå‡½æ•°æ­£ç¡®é…ç½®ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´ç¼©æ”¾ä¸å‡†ç¡®ã€‚</p>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ul>\n<li>æ¢ç´¢æ›´å¤šçš„ä½ç§©é€‚åº”æŠ€æœ¯ä¸X-Loraç»“åˆçš„å¯èƒ½æ€§ã€‚</li>\n<li>è¯„ä¼°X-Loraåœ¨ä¸åŒé¢†åŸŸä»»åŠ¡ä¸­çš„æ€§èƒ½è¡¨ç°ã€‚</li>\n<li>ä¼˜åŒ–åŠ¨æ€ç¼©æ”¾å¤´çš„è®­ç»ƒç­–ç•¥ä»¥æé«˜æ¨¡å‹æ•ˆç‡ã€‚</li>\n</ul>\n<blockquote>\n<p>åŸå§‹å‡ºå¤„ï¼š<a href=\"https://example.com\" target=\"_blank\" rel=\"noopener noreferrer\">LoRA: Low-Rank Adaptation of Large Language Models</a></p>\n</blockquote>\n","tagOpen":"<template>","tagClose":"</template>"},"script":null,"scriptSetup":null,"scripts":[],"styles":[],"customBlocks":[]},"content":"\n## å…ƒæ•°æ®\n- åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ \n- æ ‡ç­¾ï¼šX-Lora, é¢„è®­ç»ƒæ¨¡å‹, åŠ¨æ€ç¼©æ”¾, ä½ç§©é€‚åº”\n- æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥\n\n\n## æ ¸å¿ƒè§‚ç‚¹\nX-Loraé€šè¿‡ç»“åˆå¤šä¸ªä¸åŒé¢†åŸŸçš„é¢„è®­ç»ƒçš„Loraæ¨¡å‹ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå¯è®­ç»ƒçš„ç¼©æ”¾å¤´æ¥åŠ¨æ€è°ƒæ•´æ¯ä¸ªLoraæ¨¡å‹çš„è´¡çŒ®ã€‚è¿™ç§æ–¹æ³•å…è®¸åœ¨ä¸åŒä»»åŠ¡ä¸­çµæ´»åº”ç”¨å¤šä¸ªä½ç§©é€‚åº”æŠ€æœ¯ï¼Œä»¥æé«˜æ¨¡å‹çš„æ•ˆç‡å’Œæ€§èƒ½ã€‚\n\n![Pasted image 20250424111942.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250424111942.png)\n\n\n## é‡ç‚¹å†…å®¹\n\n### åŠ¨æ€ç¼©æ”¾æœºåˆ¶\nX-Loraä½¿ç”¨ä¸€ä¸ªåŠ¨æ€ç¼©æ”¾æœºåˆ¶æ¥è°ƒæ•´æ¯ä¸ªLoraæ¨¡å‹åœ¨æœ€ç»ˆè¾“å‡ºä¸­çš„è´¡çŒ®ã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬ï¼š\n\n1. **è·å–ç¼©æ”¾å€¼**ï¼šä»ç»™å®šçš„ç¼©æ”¾çŸ©é˜µä¸­æå–ç‰¹å®šå±‚çš„ç¼©æ”¾å€¼ã€‚\n2. **é€‰æ‹©Top-Kç¼©æ”¾**ï¼šæ ¹æ®é…ç½®ï¼Œé€‰æ‹©è´¡çŒ®æœ€å¤§çš„Top-Kä¸ªç¼©æ”¾å€¼ã€‚\n3. **åº”ç”¨Softmax**ï¼šå¦‚æœå¯ç”¨ï¼Œä½¿ç”¨Softmaxå‡½æ•°å¯¹éé›¶ç¼©æ”¾å€¼è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ã€‚\n\n\n### XLoraLinearLayerçš„å‰å‘ä¼ æ’­\nåœ¨XLoraLinearLayerç±»ä¸­ï¼Œå‰å‘ä¼ æ’­è¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n1. æ£€æŸ¥ç›®æ ‡æ˜¯å¦å·²åˆå¹¶ã€‚\n2. éå†æ¯ä¸ªæ´»è·ƒçš„é€‚é…å™¨ï¼Œè·å–ç›¸åº”çš„Loraæƒé‡å’Œç¼©æ”¾å‚æ•°ã€‚\n3. æ ¹æ®éœ€è¦åº”ç”¨ç¼©æ”¾è°ƒæ•´ã€‚\n4. è®¡ç®—ç»“æœå¹¶è¿”å›ã€‚\n\n\n### ä»£ç ç¤ºä¾‹\n```python\ndef get_maybe_topk_scalings(self, scalings) -> torch.Tensor:\n    xlora_scalings = scalings[:, :, self.layer_number, :]\n    if self.config.top_k_lora is not None:\n        _, topk_indices = torch.topk(xlora_scalings, k=self.config.top_k_lora, dim=-1)\n        mask = torch.zeros_like(xlora_scalings, dtype=torch.bool)\n        mask.scatter_(-1, topk_indices, True)\n        xlora_scalings = xlora_scalings * mask.to(xlora_scalings.dtype)\n\n    if self.config.enable_softmax_topk:\n        nonzero_mask = xlora_scalings != 0\n        softmax_res_nonzero = torch.softmax(xlora_scalings[nonzero_mask], dim=-1)\n        xlora_scalings[nonzero_mask] = softmax_res_nonzero\n\n    return xlora_scalings\n```\n\n\n### ğŸ’¡ å¯å‘ç‚¹\nè¿™ç§æ–¹æ³•ä¸ä»…æé«˜äº†æ¨¡å‹åœ¨ç‰¹å®šä»»åŠ¡ä¸Šçš„é€‚åº”èƒ½åŠ›ï¼Œè¿˜å¯ä»¥åœ¨ä¸æ˜¾è‘—å¢åŠ è®¡ç®—æˆæœ¬çš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨å¤šä¸ªé¢†åŸŸçš„çŸ¥è¯†ã€‚\n\n\n## è­¦å‘ŠåŒºå—\nâš ï¸ å¸¸è§é”™è¯¯ï¼šç¡®ä¿åœ¨åº”ç”¨ç¼©æ”¾æ—¶ï¼Œéé›¶æ©ç å’ŒSoftmaxå‡½æ•°æ­£ç¡®é…ç½®ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´ç¼©æ”¾ä¸å‡†ç¡®ã€‚\n\n\n## è¡ŒåŠ¨æ¸…å•\n- æ¢ç´¢æ›´å¤šçš„ä½ç§©é€‚åº”æŠ€æœ¯ä¸X-Loraç»“åˆçš„å¯èƒ½æ€§ã€‚\n- è¯„ä¼°X-Loraåœ¨ä¸åŒé¢†åŸŸä»»åŠ¡ä¸­çš„æ€§èƒ½è¡¨ç°ã€‚\n- ä¼˜åŒ–åŠ¨æ€ç¼©æ”¾å¤´çš„è®­ç»ƒç­–ç•¥ä»¥æé«˜æ¨¡å‹æ•ˆç‡ã€‚\n\n> åŸå§‹å‡ºå¤„ï¼š[LoRA: Low-Rank Adaptation of Large Language Models](https://example.com)","excerpt":"","includedFiles":[],"tasklistId":0,"title":"","headers":[{"level":2,"title":"å…ƒæ•°æ®","slug":"å…ƒæ•°æ®","link":"#å…ƒæ•°æ®","children":[]},{"level":2,"title":"æ ¸å¿ƒè§‚ç‚¹","slug":"æ ¸å¿ƒè§‚ç‚¹","link":"#æ ¸å¿ƒè§‚ç‚¹","children":[]},{"level":2,"title":"é‡ç‚¹å†…å®¹","slug":"é‡ç‚¹å†…å®¹","link":"#é‡ç‚¹å†…å®¹","children":[{"level":3,"title":"åŠ¨æ€ç¼©æ”¾æœºåˆ¶","slug":"åŠ¨æ€ç¼©æ”¾æœºåˆ¶","link":"#åŠ¨æ€ç¼©æ”¾æœºåˆ¶","children":[]},{"level":3,"title":"XLoraLinearLayerçš„å‰å‘ä¼ æ’­","slug":"xloralinearlayerçš„å‰å‘ä¼ æ’­","link":"#xloralinearlayerçš„å‰å‘ä¼ æ’­","children":[]},{"level":3,"title":"ä»£ç ç¤ºä¾‹","slug":"ä»£ç ç¤ºä¾‹","link":"#ä»£ç ç¤ºä¾‹","children":[]},{"level":3,"title":"ğŸ’¡ å¯å‘ç‚¹","slug":"ğŸ’¡-å¯å‘ç‚¹","link":"#ğŸ’¡-å¯å‘ç‚¹","children":[]}]},{"level":2,"title":"è­¦å‘ŠåŒºå—","slug":"è­¦å‘ŠåŒºå—","link":"#è­¦å‘ŠåŒºå—","children":[]},{"level":2,"title":"è¡ŒåŠ¨æ¸…å•","slug":"è¡ŒåŠ¨æ¸…å•","link":"#è¡ŒåŠ¨æ¸…å•","children":[]}]}}
