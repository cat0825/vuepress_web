---
dg-publish: true
dg-permalink: /å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/LoRAåŠå…¶å˜ä½“/LoRA
dg-home: false
dg-description: åœ¨æ­¤è¾“å…¥ç¬”è®°çš„æè¿°
dg-hide: false
dg-hide-title: false
dg-show-backlinks: true
dg-show-local-graph: true
dg-show-inline-title: true
dg-pinned: false
dg-passphrase: åœ¨æ­¤è¾“å…¥è®¿é—®å¯†ç 
dg-enable-mathjax: false
dg-enable-mermaid: false
dg-enable-uml: false
dg-note-icon: 0
dg-enable-dataview: false
tags:
  - NLP
permalink: /å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/LoRAåŠå…¶å˜ä½“/LoRA/
dgShowBacklinks: true
dgShowLocalGraph: true
dgShowInlineTitle: true
dgPassFrontmatter: true
noteIcon: 0
created: 2025-04-24T11:02:06.000+08:00
updated: 2025-04-24T11:17:35.000+08:00
title: LoRA
createTime: 2025/05/13 17:33:52
---



# LoRA: é«˜æ•ˆå¾®è°ƒå¤§æ¨¡å‹çš„ä½ç§©é€‚åº”æ–¹æ³•

## åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ 


## æ ‡ç­¾ï¼šLoRA, å¾®è°ƒ, ä½ç§©çŸ©é˜µ, å¤§è¯­è¨€æ¨¡å‹


## æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥


## æ–‡ç« æ¦‚è¿°
LoRAï¼ˆLow-rank Adaptionï¼‰æ˜¯ä¸€ç§é«˜æ•ˆçš„å¾®è°ƒå¤§æ¨¡å‹æ–¹æ³•ï¼Œé€šè¿‡ä½¿ç”¨ä½ç§©çŸ©é˜µæ¥ç¼–ç å‚æ•°å¢é‡ï¼Œå®ç°äº†åœ¨å‡å°‘èµ„æºæ¶ˆè€—çš„æƒ…å†µä¸‹å¯¹å¤§æ¨¡å‹çš„æœ‰æ•ˆå¾®è°ƒã€‚LoRAçš„æ ¸å¿ƒæ€æƒ³æ˜¯åˆ©ç”¨é¢„è®­ç»ƒæ¨¡å‹çš„å†…åœ¨ä½ç»´åº¦ç‰¹æ€§ï¼Œé€šè¿‡ä½ç§©åˆ†è§£æ¥æ›´æ–°å‚æ•°çŸ©é˜µï¼Œä»è€Œé™ä½æ˜¾å­˜ä½¿ç”¨å’Œè®­ç»ƒè€—æ—¶ã€‚

![Pasted-image-20250424111325.png](../../.vuepress/public/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250424111325.png)


## æ ¸å¿ƒè§‚ç‚¹
- **é«˜æ•ˆå¾®è°ƒåŸç†**ï¼šLoRAé€šè¿‡åŠ è½½é¢„è®­ç»ƒå‚æ•°è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä»…å¾®è°ƒä¸€éƒ¨åˆ†å‚æ•°ï¼Œå‡å°‘äº†èµ„æºæ¶ˆè€—ã€‚
  
- **ä½ç§©çŸ©é˜µç¼–ç **ï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼ŒLoRAä½¿ç”¨ä½ç§©çŸ©é˜µæ¥è¡¨ç¤ºå‚æ•°å¢é‡ï¼Œè¿™äº›çŸ©é˜µä»…æ”¾å¤§å¯¹ä¸‹æ¸¸ä»»åŠ¡æœ‰ç”¨çš„ç‰¹å¾ã€‚

- **å†…åœ¨ç»´åº¦ä¸ä½ç§©**ï¼šå¤§è¯­è¨€æ¨¡å‹æ‹¥æœ‰æå°çš„å†…åœ¨ç»´åº¦ï¼ŒLoRAé€šè¿‡ä½ç§©åˆ†è§£æ¥æ›´æ–°å‚æ•°ï¼Œå……åˆ†åˆ©ç”¨äº†è¿™ä¸€ç‰¹æ€§ã€‚


## é‡ç‚¹æ®µè½

### 1. LoRAçš„å®ç°
LoRAé€šè¿‡ä½¿ç”¨ä½ç§©çŸ©é˜µæ¥ç¼–ç å‚æ•°å¢é‡ $\Delta \phi$ï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œè¿™äº›çŸ©é˜µä»…æ”¾å¤§äº†å¯¹ä¸‹æ¸¸ä»»åŠ¡æœ‰ç”¨çš„ç‰¹å¾ï¼Œè€Œä¸æ˜¯é¢„è®­ç»ƒæ¨¡å‹ä¸­çš„ä¸»è¦ç‰¹å¾ã€‚
![Pasted-image-20250424111336.png](../../.vuepress/public/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250424111336.png)


### 2. å‚æ•°æ›´æ–°ä¸å†…åœ¨ç§©
LoRAè®¤ä¸ºåœ¨å‚æ•°æ›´æ–°è¿‡ç¨‹ä¸­å­˜åœ¨ä¸€ä¸ªå†…åœ¨ç§©ï¼Œå¯¹äºé¢„è®­ç»ƒæƒé‡çŸ©é˜µå¯ä»¥ç”¨ä¸€ä¸ªä½ç§©åˆ†è§£æ¥è¡¨ç¤ºå‚æ•°æ›´æ–°ï¼š

$$
W_0 + \Delta W = W_0 + BA
$$

å…¶ä¸­ï¼Œ$W_0 \in \mathbb{R}^{d \times k}$, $B \in \mathbb{R}^{d \times r}$, $A \in \mathbb{R}^{r \times k}$ ä¸” $r \ll \min(d, k)$ã€‚


### 3. çŸ©é˜µåˆå§‹åŒ–ç­–ç•¥
ä¸‹é‡‡æ ·çŸ©é˜µ $A$ ä½¿ç”¨éšæœºé«˜æ–¯åˆå§‹åŒ–ï¼Œè€Œä¸Šé‡‡æ ·çŸ©é˜µ $B$ åˆ™åˆå§‹åŒ–ä¸ºå…¨0ã€‚è¿™ç§åˆå§‹åŒ–ç¡®ä¿äº†è®­ç»ƒå¼€å§‹æ—¶æ—è·¯çŸ©é˜µä¾ç„¶æ˜¯0çŸ©é˜µï¼Œå¯¹é¢„è®­ç»ƒçš„å‚æ•°æ²¡æœ‰å½±å“ã€‚


## æ“ä½œæ­¥éª¤
1. âœ… **åˆå§‹åŒ–é¢„è®­ç»ƒå‚æ•°**ï¼šåŠ è½½å¹¶åˆå§‹åŒ–é¢„è®­ç»ƒæ¨¡å‹å‚æ•°ã€‚
2. âš  **è®¾ç½®ä½ç§©çŸ©é˜µ**ï¼šå®šä¹‰å¹¶åˆå§‹åŒ–ä½ç§©çŸ©é˜µ $A$ å’Œ $B$ã€‚
3. â— **å†»ç»“ä¸»å‚æ•°**ï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å†»ç»“ä¸»å‚æ•° $W_0$ï¼Œä»…è®­ç»ƒ $A$ å’Œ $B$ã€‚
4. âœ… **å¹¶è¡Œæ¨ç†**ï¼šåœ¨å‰å‘è¿‡ç¨‹åŒæ—¶è®¡ç®— $W_0x$ å’Œ $BAx$ï¼Œæé«˜æ¨ç†æ•ˆç‡ã€‚


## å¸¸è§é”™è¯¯
> åœ¨å¾®è°ƒè¿‡ç¨‹ä¸­ï¼Œå°†æ‰€æœ‰å¯å¾®è°ƒå‚æ•°é›†ä¸­åˆ°attentionçš„æŸä¸€ä¸ªå‚æ•°çŸ©é˜µå¯èƒ½å¯¼è‡´æ•ˆæœä¸ä½³ã€‚å»ºè®®å°†å¯å¾®è°ƒå‚æ•°å¹³å‡åˆ†é…åˆ° $W_q$ å’Œ $W_v$ã€‚


## ğŸ’¡ å¯å‘ç‚¹
LoRAå±•ç¤ºäº†å¦‚ä½•é€šè¿‡ä½ç§©åˆ†è§£å’Œå†…åœ¨ç»´åº¦çš„åˆ©ç”¨ï¼Œå‡å°‘å¤§æ¨¡å‹å¾®è°ƒæ‰€éœ€çš„èµ„æºæ¶ˆè€—ï¼ŒåŒæ—¶ä¿æŒè‰¯å¥½çš„æ€§èƒ½ã€‚
![Pasted-image-20250424111347.png](../../.vuepress/public/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250424111347.png)


## è¡ŒåŠ¨æ¸…å•
- æ¢ç´¢ä¸åŒä»»åŠ¡ä¸‹LoRAçš„é€‚ç”¨æ€§å’Œæ€§èƒ½è¡¨ç°ã€‚
- å®éªŒä¸åŒçš„çŸ©é˜µåˆå§‹åŒ–ç­–ç•¥å¯¹å¾®è°ƒæ•ˆæœçš„å½±å“ã€‚
- ç ”ç©¶LoRAä¸å…¶ä»–å¾®è°ƒæ–¹æ³•ï¼ˆå¦‚Adapterï¼‰çš„ç»„åˆä½¿ç”¨æ•ˆæœã€‚

> åŸå§‹å‡ºå¤„ï¼š[åŸæ–‡é“¾æ¥æˆ–å‡ºå¤„ä¿¡æ¯]



# LoRA å¾®è°ƒçš„åˆå§‹åŒ–å½±å“ä¸æ ¸å¿ƒä»£ç åˆ†æ
å…ƒæ•°æ®ï¼š

- åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ 
- æ ‡ç­¾ï¼šLoRAå¾®è°ƒã€åˆå§‹åŒ–ã€ç‰¹å¾å­¦ä¹ ã€ä»£ç åˆ†æ
- æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥

## æ ¸å¿ƒè§‚ç‚¹æ€»ç»“
åœ¨LoRAå¾®è°ƒè¿‡ç¨‹ä¸­ï¼Œåˆå§‹åŒ–ç­–ç•¥å¯¹æ¨¡å‹çš„è®­ç»ƒåŠ¨æ€æœ‰æ˜¾è‘—å½±å“ã€‚é€šè¿‡å®éªŒå¯¹æ¯”ï¼Œå‘ç°ä¸åŒçš„åˆå§‹åŒ–ç­–ç•¥ä¼šå½±å“ç‰¹å¾å­¦ä¹ æ•ˆç‡å’Œè®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æLoRAå¾®è°ƒä¸­çš„åˆå§‹åŒ–å½±å“ï¼Œå¹¶æ¢è®¨å…¶æ ¸å¿ƒä»£ç å®ç°ã€‚


## é‡ç‚¹åˆ†æ

### åˆå§‹åŒ–ç­–ç•¥å¯¹æ¯”
1. **Init[A]**ï¼šå…·æœ‰æ›´é«˜çš„ç‰¹å¾å­¦ä¹ æ•ˆç‡ï¼Œä½†å¯èƒ½å¯¼è‡´è®­ç»ƒä¸ç¨³å®šã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¡¨ç°ä¼˜äºInit[B]ã€‚
2. **Init[B]**ï¼šæä¾›ç¨³å®šçš„è®­ç»ƒè¿‡ç¨‹ï¼Œä½†ç‰¹å¾å­¦ä¹ æ•ˆæœç¨é€Šã€‚

ğŸ’¡å¯å‘ç‚¹ï¼šé€‰æ‹©ä½•ç§åˆå§‹åŒ–ç­–ç•¥éœ€æƒè¡¡ç‰¹å¾å­¦ä¹ æ•ˆç‡ä¸è®­ç»ƒç¨³å®šæ€§ã€‚


### LoRA å¾®è°ƒæ ¸å¿ƒä»£ç 
LoRAçš„æ ¸å¿ƒåœ¨äº`LoraModel`ç±»ï¼Œè¯¥ç±»é€šè¿‡æ‹·è´åŸå§‹çš„`nn.Linear`çš„å±æ€§ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„`Linear`ç±»ã€‚

```python
class Linear(nn.Linear, LoraLayer):
    def __init__(
        self,
        adapter_name: str,
        in_features: int,
        out_features: int,
        r: int = 0,
        lora_alpha: int = 1,
        lora_dropout: float = 0.0,
        fan_in_fan_out: bool = False,
        is_target_conv_1d_layer: bool = False,
        **kwargs,
    ):
        init_lora_weights = kwargs.pop("init_lora_weights", True)
        nn.Linear.__init__(self, in_features, out_features, **kwargs)
        LoraLayer.__init__(self, in_features=in_features, out_features=out_features)
        self.weight.requires_grad = False
        nn.Linear.reset_parameters(self)
        self.update_layer(adapter_name, r, lora_alpha, lora_dropout, init_lora_weights)
```


### LoRA è®¾ç½®é™ç»´å’Œå‡ç»´çŸ©é˜µ
åœ¨`LoraLayer`ç±»ä¸­ï¼Œä½¿ç”¨`update_layer`å‡½æ•°è®¾ç½®é™ç»´çŸ©é˜µ $A$ å’Œå‡ç»´çŸ©é˜µ $B$ï¼Œå¹¶é…ç½®æ”¾ç¼©å› å­ã€‚

```python
self.lora_A[adapter_name] = nn.Linear(self.in_features, r, bias=False)
self.lora_B[adapter_name] = nn.Linear(r, self.out_features, bias=lora_bias)
```


## å¸¸è§é”™è¯¯
> âš ï¸ åœ¨å®ç°LoRAå¾®è°ƒæ—¶ï¼Œéœ€æ³¨æ„åˆå§‹åŒ–ç­–ç•¥çš„é€‰æ‹©ï¼Œä»¥é¿å…ä¸å¿…è¦çš„è®­ç»ƒä¸ç¨³å®šæ€§ã€‚


## è¡ŒåŠ¨æ¸…å•
- [ ] è¿›ä¸€æ­¥ç ”ç©¶ä¸åŒåˆå§‹åŒ–ç­–ç•¥å¯¹å…¶ä»–æ¨¡å‹ç»“æ„çš„å½±å“ã€‚
- [ ] å®éªŒéªŒè¯ä¸åŒæ”¾ç¼©å› å­å¯¹è®­ç»ƒæ•ˆæœçš„å½±å“ã€‚
- [ ] ä¼˜åŒ–ä»£ç å®ç°ï¼Œæé«˜ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§ã€‚

> æ¥æºï¼šæœ¬æ–‡å†…å®¹åŸºäºå®éªŒæ–‡çŒ®ã€ŠThe Impact of Initialization on LoRA Finetuning Dynamicsã€‹å’Œç›¸å…³ä»£ç åˆ†æã€‚
