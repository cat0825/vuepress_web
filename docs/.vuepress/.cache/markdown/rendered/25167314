{"content":"<h2 id=\"元数据\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#元数据\"><span>元数据</span></a></h2>\n<ul>\n<li>分类：深度学习</li>\n<li>标签：预训练策略，学习率调度，模型优化</li>\n<li>日期：2023年10月25日</li>\n</ul>\n<hr>\n<h2 id=\"核心观点总结\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#核心观点总结\"><span>核心观点总结</span></a></h2>\n<p>在深度学习模型的预训练过程中，优化策略至关重要。本文探讨了如何通过调整 <strong>batch_size</strong>、采用 <strong>WSD调度器</strong> 和 <strong>预训练Trick</strong> 来提升模型训练效率，同时总结了四阶段预训练设置的具体流程。</p>\n<hr>\n<h2 id=\"重点内容\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#重点内容\"><span>重点内容</span></a></h2>\n<h3 id=\"最优-batch-size-的选择\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#最优-batch-size-的选择\"><span>最优 Batch Size 的选择</span></a></h3>\n<ul>\n<li><strong>关键点</strong>：Batch size 影响模型收敛速度与资源消耗的平衡。</li>\n<li>数据实验表明：\n<ul>\n<li>Batch size 过大，数据和计算量增加。</li>\n<li>Batch size 过小，训练步数增多且损失函数下降受限。</li>\n</ul>\n</li>\n<li>C4 Loss 的规律公式：<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>B</mi><mi>S</mi><mo>=</mo><mi>L</mi><mo>⋅</mo><mn>6.2393</mn><mi mathvariant=\"normal\">/</mi><mo stretchy=\"false\">(</mo><mn>1.2110</mn><mo>×</mo><msup><mn>10</mn><mn>9</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">BS = L \\cdot 6.2393 / (1.2110 \\times 10^9)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">BS</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">6.2393/</span><span class=\"mopen\">(</span><span class=\"mord\">1.2110</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1141em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">9</span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n</li>\n<li><img src=\"/img/user/附件/Pasted image 20250409220613.png\" alt=\"Pasted image 20250409220613.png\"></li>\n</ul>\n<h3 id=\"wsd-调度器的三阶段学习率策略\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#wsd-调度器的三阶段学习率策略\"><span>WSD 调度器的三阶段学习率策略</span></a></h3>\n<ul>\n<li><strong>分阶段特点</strong>：\n<ol>\n<li><strong>快速收敛阶段</strong>（Warmup）：学习率线性上升。</li>\n<li><strong>稳定阶段</strong>（Stable）：保持最大学习率。</li>\n<li><strong>退火阶段</strong>（Decay）：采用余弦退火算法逐步降低学习率。</li>\n</ol>\n</li>\n<li>学习率公式：<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>l</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>s</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mrow><mo fence=\"true\">{</mo><mtable rowspacing=\"0.36em\" columnalign=\"left left\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mfrac><mi>s</mi><mi>W</mi></mfrac><mo>⋅</mo><mi>η</mi><mo separator=\"true\">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>s</mi><mo>&lt;</mo><mi>W</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>η</mi><mo separator=\"true\">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>W</mi><mo>≤</mo><mi>s</mi><mo>&lt;</mo><mi>S</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>f</mi><mo stretchy=\"false\">(</mo><mi>s</mi><mo>−</mo><mi>S</mi><mo stretchy=\"false\">)</mo><mo>⋅</mo><mi>η</mi><mo separator=\"true\">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>S</mi><mo>≤</mo><mi>s</mi><mo>&lt;</mo><mi>S</mi><mo>+</mo><mi>D</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding=\"application/x-tex\">lr(s) =\n\\begin{cases} \n  \\frac{s}{W} \\cdot \\eta, &amp; s &lt; W \\\\ \n  \\eta, &amp; W \\leq s &lt; S \\\\ \n  f(s - S) \\cdot \\eta, &amp; S \\leq s &lt; S + D\n\\end{cases}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">s</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:4.32em;vertical-align:-1.91em;\"></span><span class=\"minner\"><span class=\"mopen\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.35em;\"><span style=\"top:-2.2em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎩</span></span></span><span style=\"top:-2.192em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span style=\"height:0.316em;width:0.8889em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"0.8889em\" height=\"0.316em\" style=\"width:0.8889em\" viewBox=\"0 0 888.89 316\" preserveAspectRatio=\"xMinYMin\"><path d=\"M384 0 H504 V316 H384z M384 0 H504 V316 H384z\"/></svg></span></span><span style=\"top:-3.15em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎨</span></span></span><span style=\"top:-4.292em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span style=\"height:0.316em;width:0.8889em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"0.8889em\" height=\"0.316em\" style=\"width:0.8889em\" viewBox=\"0 0 888.89 316\" preserveAspectRatio=\"xMinYMin\"><path d=\"M384 0 H504 V316 H384z M384 0 H504 V316 H384z\"/></svg></span></span><span style=\"top:-4.6em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎧</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.85em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.41em;\"><span style=\"top:-4.41em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6954em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">W</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"mpunct\">,</span></span></span><span style=\"top:-2.97em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"mpunct\">,</span></span></span><span style=\"top:-1.53em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"mpunct\">,</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.91em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:1em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.41em;\"><span style=\"top:-4.41em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span></span></span><span style=\"top:-2.97em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span><span style=\"top:-1.53em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.91em;\"><span></span></span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<ul>\n<li>\n<p v-pre class='katex-block'><span class=\"katex-error\" title=\"ParseError: KaTeX parse error: Can&#x27;t use function &#x27;$&#x27; in math mode at position 5: \\eta$̲$：最大学习率\n\" style=\"color:#cc0000\">\\eta$$：最大学习率\n</span></p>\n</li>\n<li>\n<p v-pre class='katex-block'><span class=\"katex-error\" title=\"ParseError: KaTeX parse error: Can&#x27;t use function &#x27;$&#x27; in math mode at position 9: f(s - S)$̲$：关于 $$s$$ 的减函数…\" style=\"color:#cc0000\">f(s - S)$$：关于 $$s$$ 的减函数，范围 $$0 &lt; f(s - S) \\leq 1\n</span></p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"提高效率的预训练技巧\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#提高效率的预训练技巧\"><span>提高效率的预训练技巧</span></a></h3>\n<ul>\n<li><strong>显存优化</strong>：\n<ul>\n<li>若显存充足，尽量避免引入复杂并行技术（如 tensor_parallel）。</li>\n<li>不开启 <strong>offload</strong> 和 <strong>重算</strong> 可节省时间。</li>\n</ul>\n</li>\n<li><strong>指令数据</strong>：\n<ul>\n<li>加入更多指令数据有助于提升模型性能。</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"✅-四阶段预训练设置流程\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#✅-四阶段预训练设置流程\"><span>✅ 四阶段预训练设置流程</span></a></h2>\n<ol>\n<li><strong>Warmup 阶段</strong>：\n<ul>\n<li>学习率缓慢上升到最大值。</li>\n</ul>\n</li>\n<li><strong>中期稳定阶段</strong>：\n<ul>\n<li>使用较大的学习率，是否引入衰减需视实验而定。</li>\n</ul>\n</li>\n<li><strong>后期适应阶段</strong>：\n<ul>\n<li>改变 RoPE 的 base 频率，增加文本长度，让模型适应长文本任务。</li>\n</ul>\n</li>\n<li><strong>收尾退火阶段</strong>：\n<ul>\n<li>使用高质量数据（如 IFT 数据）强化模型能力，为 benchmark 测试做准备。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2 id=\"⚠-常见错误与注意事项\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#⚠-常见错误与注意事项\"><span>⚠ 常见错误与注意事项</span></a></h2>\n<blockquote>\n<p><strong>警告区块</strong></p>\n</blockquote>\n<ul>\n<li>忽视 batch size 对训练效率的影响，可能导致资源浪费或性能不足。</li>\n<li>在显存不足时强行引入复杂并行技术，可能引发调试困难和性能下降。</li>\n</ul>\n<hr>\n<h2 id=\"📈-趋势预测\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#📈-趋势预测\"><span>📈 趋势预测</span></a></h2>\n<p>未来预训练策略可能会更加注重以下方向：</p>\n<ol>\n<li>自动化调参工具的普及，减少人工调整成本。</li>\n<li>更智能的数据采样方法，提升高质量数据使用比例。</li>\n<li>多模型协同训练策略（如多任务联合训练）的进一步发展。</li>\n</ol>\n<hr>\n<h2 id=\"思考-延伸问题\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#思考-延伸问题\"><span>[思考] 延伸问题</span></a></h2>\n<ol>\n<li>如何在不同硬件条件下灵活调整 batch size 和学习率？</li>\n<li>是否存在更高效的调度器替代 WSD 调度器？</li>\n<li>长文本适应性优化是否能迁移至多模态任务中？</li>\n</ol>\n<hr>\n<blockquote>\n<p>原文出处：深度学习预训练策略文档</p>\n</blockquote>\n<hr>\n<h2 id=\"行动清单\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#行动清单\"><span>行动清单</span></a></h2>\n<ul class=\"task-list-container\">\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-0\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-0\"> 实验不同 batch size 对小模型的影响。</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-1\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-1\"> 测试 WSD 调度器与余弦退火算法在大规模任务中的性能差异。</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-2\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-2\"> 探索高效的显存管理技术以支持更大规模的预训练。</label></li>\n</ul>\n","env":{"base":"/","filePath":"/Users/qianyuhe/Desktop/my-project/docs/notes_bak/大语言模型学习/Pre-training 预训练/预训练过程/预训练策略.md","filePathRelative":"notes_bak/大语言模型学习/Pre-training 预训练/预训练过程/预训练策略.md","frontmatter":{"dg-publish":true,"dg-permalink":"/大语言模型学习/Pre-training-预训练/预训练过程/预训练策略","dg-home":false,"dg-description":"在此输入笔记的描述","dg-hide":false,"dg-hide-title":false,"dg-show-backlinks":true,"dg-show-local-graph":true,"dg-show-inline-title":true,"dg-pinned":false,"dg-passphrase":"在此输入访问密码","dg-enable-mathjax":false,"dg-enable-mermaid":false,"dg-enable-uml":false,"dg-note-icon":0,"dg-enable-dataview":false,"tags":["NLP"],"permalink":"/大语言模型学习/Pre-training-预训练/预训练过程/预训练策略/","dgShowBacklinks":true,"dgShowLocalGraph":true,"dgShowInlineTitle":true,"dgPassFrontmatter":true,"noteIcon":0,"created":"2025-04-09T14:02:28.000Z","updated":"2025-04-13T05:06:02.000Z","title":"预训练策略","createTime":"2025/05/13 17:33:53"},"sfcBlocks":{"template":{"type":"template","content":"<template><h2 id=\"元数据\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#元数据\"><span>元数据</span></a></h2>\n<ul>\n<li>分类：深度学习</li>\n<li>标签：预训练策略，学习率调度，模型优化</li>\n<li>日期：2023年10月25日</li>\n</ul>\n<hr>\n<h2 id=\"核心观点总结\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#核心观点总结\"><span>核心观点总结</span></a></h2>\n<p>在深度学习模型的预训练过程中，优化策略至关重要。本文探讨了如何通过调整 <strong>batch_size</strong>、采用 <strong>WSD调度器</strong> 和 <strong>预训练Trick</strong> 来提升模型训练效率，同时总结了四阶段预训练设置的具体流程。</p>\n<hr>\n<h2 id=\"重点内容\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#重点内容\"><span>重点内容</span></a></h2>\n<h3 id=\"最优-batch-size-的选择\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#最优-batch-size-的选择\"><span>最优 Batch Size 的选择</span></a></h3>\n<ul>\n<li><strong>关键点</strong>：Batch size 影响模型收敛速度与资源消耗的平衡。</li>\n<li>数据实验表明：\n<ul>\n<li>Batch size 过大，数据和计算量增加。</li>\n<li>Batch size 过小，训练步数增多且损失函数下降受限。</li>\n</ul>\n</li>\n<li>C4 Loss 的规律公式：<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>B</mi><mi>S</mi><mo>=</mo><mi>L</mi><mo>⋅</mo><mn>6.2393</mn><mi mathvariant=\"normal\">/</mi><mo stretchy=\"false\">(</mo><mn>1.2110</mn><mo>×</mo><msup><mn>10</mn><mn>9</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">BS = L \\cdot 6.2393 / (1.2110 \\times 10^9)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">BS</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">6.2393/</span><span class=\"mopen\">(</span><span class=\"mord\">1.2110</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1141em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">9</span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n</li>\n<li><img src=\"/img/user/附件/Pasted image 20250409220613.png\" alt=\"Pasted image 20250409220613.png\"></li>\n</ul>\n<h3 id=\"wsd-调度器的三阶段学习率策略\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#wsd-调度器的三阶段学习率策略\"><span>WSD 调度器的三阶段学习率策略</span></a></h3>\n<ul>\n<li><strong>分阶段特点</strong>：\n<ol>\n<li><strong>快速收敛阶段</strong>（Warmup）：学习率线性上升。</li>\n<li><strong>稳定阶段</strong>（Stable）：保持最大学习率。</li>\n<li><strong>退火阶段</strong>（Decay）：采用余弦退火算法逐步降低学习率。</li>\n</ol>\n</li>\n<li>学习率公式：<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>l</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>s</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mrow><mo fence=\"true\">{</mo><mtable rowspacing=\"0.36em\" columnalign=\"left left\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mfrac><mi>s</mi><mi>W</mi></mfrac><mo>⋅</mo><mi>η</mi><mo separator=\"true\">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>s</mi><mo>&lt;</mo><mi>W</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>η</mi><mo separator=\"true\">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>W</mi><mo>≤</mo><mi>s</mi><mo>&lt;</mo><mi>S</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>f</mi><mo stretchy=\"false\">(</mo><mi>s</mi><mo>−</mo><mi>S</mi><mo stretchy=\"false\">)</mo><mo>⋅</mo><mi>η</mi><mo separator=\"true\">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>S</mi><mo>≤</mo><mi>s</mi><mo>&lt;</mo><mi>S</mi><mo>+</mo><mi>D</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding=\"application/x-tex\">lr(s) =\n\\begin{cases} \n  \\frac{s}{W} \\cdot \\eta, &amp; s &lt; W \\\\ \n  \\eta, &amp; W \\leq s &lt; S \\\\ \n  f(s - S) \\cdot \\eta, &amp; S \\leq s &lt; S + D\n\\end{cases}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">s</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:4.32em;vertical-align:-1.91em;\"></span><span class=\"minner\"><span class=\"mopen\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.35em;\"><span style=\"top:-2.2em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎩</span></span></span><span style=\"top:-2.192em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span style=\"height:0.316em;width:0.8889em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"0.8889em\" height=\"0.316em\" style=\"width:0.8889em\" viewBox=\"0 0 888.89 316\" preserveAspectRatio=\"xMinYMin\"><path d=\"M384 0 H504 V316 H384z M384 0 H504 V316 H384z\"/></svg></span></span><span style=\"top:-3.15em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎨</span></span></span><span style=\"top:-4.292em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span style=\"height:0.316em;width:0.8889em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"0.8889em\" height=\"0.316em\" style=\"width:0.8889em\" viewBox=\"0 0 888.89 316\" preserveAspectRatio=\"xMinYMin\"><path d=\"M384 0 H504 V316 H384z M384 0 H504 V316 H384z\"/></svg></span></span><span style=\"top:-4.6em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎧</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.85em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.41em;\"><span style=\"top:-4.41em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6954em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">W</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"mpunct\">,</span></span></span><span style=\"top:-2.97em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"mpunct\">,</span></span></span><span style=\"top:-1.53em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"mpunct\">,</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.91em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:1em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.41em;\"><span style=\"top:-4.41em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span></span></span><span style=\"top:-2.97em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span><span style=\"top:-1.53em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.91em;\"><span></span></span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<ul>\n<li>\n<p v-pre class='katex-block'><span class=\"katex-error\" title=\"ParseError: KaTeX parse error: Can&#x27;t use function &#x27;$&#x27; in math mode at position 5: \\eta$̲$：最大学习率\n\" style=\"color:#cc0000\">\\eta$$：最大学习率\n</span></p>\n</li>\n<li>\n<p v-pre class='katex-block'><span class=\"katex-error\" title=\"ParseError: KaTeX parse error: Can&#x27;t use function &#x27;$&#x27; in math mode at position 9: f(s - S)$̲$：关于 $$s$$ 的减函数…\" style=\"color:#cc0000\">f(s - S)$$：关于 $$s$$ 的减函数，范围 $$0 &lt; f(s - S) \\leq 1\n</span></p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"提高效率的预训练技巧\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#提高效率的预训练技巧\"><span>提高效率的预训练技巧</span></a></h3>\n<ul>\n<li><strong>显存优化</strong>：\n<ul>\n<li>若显存充足，尽量避免引入复杂并行技术（如 tensor_parallel）。</li>\n<li>不开启 <strong>offload</strong> 和 <strong>重算</strong> 可节省时间。</li>\n</ul>\n</li>\n<li><strong>指令数据</strong>：\n<ul>\n<li>加入更多指令数据有助于提升模型性能。</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"✅-四阶段预训练设置流程\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#✅-四阶段预训练设置流程\"><span>✅ 四阶段预训练设置流程</span></a></h2>\n<ol>\n<li><strong>Warmup 阶段</strong>：\n<ul>\n<li>学习率缓慢上升到最大值。</li>\n</ul>\n</li>\n<li><strong>中期稳定阶段</strong>：\n<ul>\n<li>使用较大的学习率，是否引入衰减需视实验而定。</li>\n</ul>\n</li>\n<li><strong>后期适应阶段</strong>：\n<ul>\n<li>改变 RoPE 的 base 频率，增加文本长度，让模型适应长文本任务。</li>\n</ul>\n</li>\n<li><strong>收尾退火阶段</strong>：\n<ul>\n<li>使用高质量数据（如 IFT 数据）强化模型能力，为 benchmark 测试做准备。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2 id=\"⚠-常见错误与注意事项\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#⚠-常见错误与注意事项\"><span>⚠ 常见错误与注意事项</span></a></h2>\n<blockquote>\n<p><strong>警告区块</strong></p>\n</blockquote>\n<ul>\n<li>忽视 batch size 对训练效率的影响，可能导致资源浪费或性能不足。</li>\n<li>在显存不足时强行引入复杂并行技术，可能引发调试困难和性能下降。</li>\n</ul>\n<hr>\n<h2 id=\"📈-趋势预测\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#📈-趋势预测\"><span>📈 趋势预测</span></a></h2>\n<p>未来预训练策略可能会更加注重以下方向：</p>\n<ol>\n<li>自动化调参工具的普及，减少人工调整成本。</li>\n<li>更智能的数据采样方法，提升高质量数据使用比例。</li>\n<li>多模型协同训练策略（如多任务联合训练）的进一步发展。</li>\n</ol>\n<hr>\n<h2 id=\"思考-延伸问题\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#思考-延伸问题\"><span>[思考] 延伸问题</span></a></h2>\n<ol>\n<li>如何在不同硬件条件下灵活调整 batch size 和学习率？</li>\n<li>是否存在更高效的调度器替代 WSD 调度器？</li>\n<li>长文本适应性优化是否能迁移至多模态任务中？</li>\n</ol>\n<hr>\n<blockquote>\n<p>原文出处：深度学习预训练策略文档</p>\n</blockquote>\n<hr>\n<h2 id=\"行动清单\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#行动清单\"><span>行动清单</span></a></h2>\n<ul class=\"task-list-container\">\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-0\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-0\"> 实验不同 batch size 对小模型的影响。</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-1\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-1\"> 测试 WSD 调度器与余弦退火算法在大规模任务中的性能差异。</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-2\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-2\"> 探索高效的显存管理技术以支持更大规模的预训练。</label></li>\n</ul>\n</template>","contentStripped":"<h2 id=\"元数据\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#元数据\"><span>元数据</span></a></h2>\n<ul>\n<li>分类：深度学习</li>\n<li>标签：预训练策略，学习率调度，模型优化</li>\n<li>日期：2023年10月25日</li>\n</ul>\n<hr>\n<h2 id=\"核心观点总结\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#核心观点总结\"><span>核心观点总结</span></a></h2>\n<p>在深度学习模型的预训练过程中，优化策略至关重要。本文探讨了如何通过调整 <strong>batch_size</strong>、采用 <strong>WSD调度器</strong> 和 <strong>预训练Trick</strong> 来提升模型训练效率，同时总结了四阶段预训练设置的具体流程。</p>\n<hr>\n<h2 id=\"重点内容\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#重点内容\"><span>重点内容</span></a></h2>\n<h3 id=\"最优-batch-size-的选择\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#最优-batch-size-的选择\"><span>最优 Batch Size 的选择</span></a></h3>\n<ul>\n<li><strong>关键点</strong>：Batch size 影响模型收敛速度与资源消耗的平衡。</li>\n<li>数据实验表明：\n<ul>\n<li>Batch size 过大，数据和计算量增加。</li>\n<li>Batch size 过小，训练步数增多且损失函数下降受限。</li>\n</ul>\n</li>\n<li>C4 Loss 的规律公式：<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>B</mi><mi>S</mi><mo>=</mo><mi>L</mi><mo>⋅</mo><mn>6.2393</mn><mi mathvariant=\"normal\">/</mi><mo stretchy=\"false\">(</mo><mn>1.2110</mn><mo>×</mo><msup><mn>10</mn><mn>9</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">BS = L \\cdot 6.2393 / (1.2110 \\times 10^9)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">BS</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">6.2393/</span><span class=\"mopen\">(</span><span class=\"mord\">1.2110</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1141em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">9</span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n</li>\n<li><img src=\"/img/user/附件/Pasted image 20250409220613.png\" alt=\"Pasted image 20250409220613.png\"></li>\n</ul>\n<h3 id=\"wsd-调度器的三阶段学习率策略\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#wsd-调度器的三阶段学习率策略\"><span>WSD 调度器的三阶段学习率策略</span></a></h3>\n<ul>\n<li><strong>分阶段特点</strong>：\n<ol>\n<li><strong>快速收敛阶段</strong>（Warmup）：学习率线性上升。</li>\n<li><strong>稳定阶段</strong>（Stable）：保持最大学习率。</li>\n<li><strong>退火阶段</strong>（Decay）：采用余弦退火算法逐步降低学习率。</li>\n</ol>\n</li>\n<li>学习率公式：<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>l</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>s</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mrow><mo fence=\"true\">{</mo><mtable rowspacing=\"0.36em\" columnalign=\"left left\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mfrac><mi>s</mi><mi>W</mi></mfrac><mo>⋅</mo><mi>η</mi><mo separator=\"true\">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>s</mi><mo>&lt;</mo><mi>W</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>η</mi><mo separator=\"true\">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>W</mi><mo>≤</mo><mi>s</mi><mo>&lt;</mo><mi>S</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>f</mi><mo stretchy=\"false\">(</mo><mi>s</mi><mo>−</mo><mi>S</mi><mo stretchy=\"false\">)</mo><mo>⋅</mo><mi>η</mi><mo separator=\"true\">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>S</mi><mo>≤</mo><mi>s</mi><mo>&lt;</mo><mi>S</mi><mo>+</mo><mi>D</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding=\"application/x-tex\">lr(s) =\n\\begin{cases} \n  \\frac{s}{W} \\cdot \\eta, &amp; s &lt; W \\\\ \n  \\eta, &amp; W \\leq s &lt; S \\\\ \n  f(s - S) \\cdot \\eta, &amp; S \\leq s &lt; S + D\n\\end{cases}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">s</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:4.32em;vertical-align:-1.91em;\"></span><span class=\"minner\"><span class=\"mopen\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.35em;\"><span style=\"top:-2.2em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎩</span></span></span><span style=\"top:-2.192em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span style=\"height:0.316em;width:0.8889em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"0.8889em\" height=\"0.316em\" style=\"width:0.8889em\" viewBox=\"0 0 888.89 316\" preserveAspectRatio=\"xMinYMin\"><path d=\"M384 0 H504 V316 H384z M384 0 H504 V316 H384z\"/></svg></span></span><span style=\"top:-3.15em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎨</span></span></span><span style=\"top:-4.292em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span style=\"height:0.316em;width:0.8889em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"0.8889em\" height=\"0.316em\" style=\"width:0.8889em\" viewBox=\"0 0 888.89 316\" preserveAspectRatio=\"xMinYMin\"><path d=\"M384 0 H504 V316 H384z M384 0 H504 V316 H384z\"/></svg></span></span><span style=\"top:-4.6em;\"><span class=\"pstrut\" style=\"height:3.15em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎧</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.85em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.41em;\"><span style=\"top:-4.41em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6954em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">W</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"mpunct\">,</span></span></span><span style=\"top:-2.97em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"mpunct\">,</span></span></span><span style=\"top:-1.53em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"mpunct\">,</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.91em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:1em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.41em;\"><span style=\"top:-4.41em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span></span></span><span style=\"top:-2.97em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span><span style=\"top:-1.53em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.91em;\"><span></span></span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<ul>\n<li>\n<p v-pre class='katex-block'><span class=\"katex-error\" title=\"ParseError: KaTeX parse error: Can&#x27;t use function &#x27;$&#x27; in math mode at position 5: \\eta$̲$：最大学习率\n\" style=\"color:#cc0000\">\\eta$$：最大学习率\n</span></p>\n</li>\n<li>\n<p v-pre class='katex-block'><span class=\"katex-error\" title=\"ParseError: KaTeX parse error: Can&#x27;t use function &#x27;$&#x27; in math mode at position 9: f(s - S)$̲$：关于 $$s$$ 的减函数…\" style=\"color:#cc0000\">f(s - S)$$：关于 $$s$$ 的减函数，范围 $$0 &lt; f(s - S) \\leq 1\n</span></p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"提高效率的预训练技巧\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#提高效率的预训练技巧\"><span>提高效率的预训练技巧</span></a></h3>\n<ul>\n<li><strong>显存优化</strong>：\n<ul>\n<li>若显存充足，尽量避免引入复杂并行技术（如 tensor_parallel）。</li>\n<li>不开启 <strong>offload</strong> 和 <strong>重算</strong> 可节省时间。</li>\n</ul>\n</li>\n<li><strong>指令数据</strong>：\n<ul>\n<li>加入更多指令数据有助于提升模型性能。</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"✅-四阶段预训练设置流程\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#✅-四阶段预训练设置流程\"><span>✅ 四阶段预训练设置流程</span></a></h2>\n<ol>\n<li><strong>Warmup 阶段</strong>：\n<ul>\n<li>学习率缓慢上升到最大值。</li>\n</ul>\n</li>\n<li><strong>中期稳定阶段</strong>：\n<ul>\n<li>使用较大的学习率，是否引入衰减需视实验而定。</li>\n</ul>\n</li>\n<li><strong>后期适应阶段</strong>：\n<ul>\n<li>改变 RoPE 的 base 频率，增加文本长度，让模型适应长文本任务。</li>\n</ul>\n</li>\n<li><strong>收尾退火阶段</strong>：\n<ul>\n<li>使用高质量数据（如 IFT 数据）强化模型能力，为 benchmark 测试做准备。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2 id=\"⚠-常见错误与注意事项\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#⚠-常见错误与注意事项\"><span>⚠ 常见错误与注意事项</span></a></h2>\n<blockquote>\n<p><strong>警告区块</strong></p>\n</blockquote>\n<ul>\n<li>忽视 batch size 对训练效率的影响，可能导致资源浪费或性能不足。</li>\n<li>在显存不足时强行引入复杂并行技术，可能引发调试困难和性能下降。</li>\n</ul>\n<hr>\n<h2 id=\"📈-趋势预测\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#📈-趋势预测\"><span>📈 趋势预测</span></a></h2>\n<p>未来预训练策略可能会更加注重以下方向：</p>\n<ol>\n<li>自动化调参工具的普及，减少人工调整成本。</li>\n<li>更智能的数据采样方法，提升高质量数据使用比例。</li>\n<li>多模型协同训练策略（如多任务联合训练）的进一步发展。</li>\n</ol>\n<hr>\n<h2 id=\"思考-延伸问题\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#思考-延伸问题\"><span>[思考] 延伸问题</span></a></h2>\n<ol>\n<li>如何在不同硬件条件下灵活调整 batch size 和学习率？</li>\n<li>是否存在更高效的调度器替代 WSD 调度器？</li>\n<li>长文本适应性优化是否能迁移至多模态任务中？</li>\n</ol>\n<hr>\n<blockquote>\n<p>原文出处：深度学习预训练策略文档</p>\n</blockquote>\n<hr>\n<h2 id=\"行动清单\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#行动清单\"><span>行动清单</span></a></h2>\n<ul class=\"task-list-container\">\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-0\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-0\"> 实验不同 batch size 对小模型的影响。</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-1\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-1\"> 测试 WSD 调度器与余弦退火算法在大规模任务中的性能差异。</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-2\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-2\"> 探索高效的显存管理技术以支持更大规模的预训练。</label></li>\n</ul>\n","tagOpen":"<template>","tagClose":"</template>"},"script":null,"scriptSetup":null,"scripts":[],"styles":[],"customBlocks":[]},"content":"## 元数据\n- 分类：深度学习\n- 标签：预训练策略，学习率调度，模型优化\n- 日期：2023年10月25日\n\n---\n\n\n\n## 核心观点总结\n在深度学习模型的预训练过程中，优化策略至关重要。本文探讨了如何通过调整 **batch_size**、采用 **WSD调度器** 和 **预训练Trick** 来提升模型训练效率，同时总结了四阶段预训练设置的具体流程。\n\n---\n\n\n\n## 重点内容\n\n### 最优 Batch Size 的选择\n- **关键点**：Batch size 影响模型收敛速度与资源消耗的平衡。\n- 数据实验表明：\n  - Batch size 过大，数据和计算量增加。\n  - Batch size 过小，训练步数增多且损失函数下降受限。\n- C4 Loss 的规律公式：\n  $$\n  BS = L \\cdot 6.2393 / (1.2110 \\times 10^9)\n  $$\n- ![Pasted image 20250409220613.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250409220613.png)\n\n\n### WSD 调度器的三阶段学习率策略\n- **分阶段特点**：\n  1. **快速收敛阶段**（Warmup）：学习率线性上升。\n  2. **稳定阶段**（Stable）：保持最大学习率。\n  3. **退火阶段**（Decay）：采用余弦退火算法逐步降低学习率。\n- 学习率公式：\n  $$\n  lr(s) =\n  \\begin{cases} \n    \\frac{s}{W} \\cdot \\eta, & s < W \\\\ \n    \\eta, & W \\leq s < S \\\\ \n    f(s - S) \\cdot \\eta, & S \\leq s < S + D\n  \\end{cases}\n  $$\n  - $$\\eta$$：最大学习率  \n  - $$f(s - S)$$：关于 $$s$$ 的减函数，范围 $$0 < f(s - S) \\leq 1$$\n\n\n### 提高效率的预训练技巧\n- **显存优化**：\n  - 若显存充足，尽量避免引入复杂并行技术（如 tensor_parallel）。\n  - 不开启 **offload** 和 **重算** 可节省时间。\n- **指令数据**：\n  - 加入更多指令数据有助于提升模型性能。\n\n---\n\n\n\n## ✅ 四阶段预训练设置流程\n1. **Warmup 阶段**：\n   - 学习率缓慢上升到最大值。\n2. **中期稳定阶段**：\n   - 使用较大的学习率，是否引入衰减需视实验而定。\n3. **后期适应阶段**：\n   - 改变 RoPE 的 base 频率，增加文本长度，让模型适应长文本任务。\n4. **收尾退火阶段**：\n   - 使用高质量数据（如 IFT 数据）强化模型能力，为 benchmark 测试做准备。\n\n---\n\n\n\n## ⚠ 常见错误与注意事项\n> **警告区块**  \n- 忽视 batch size 对训练效率的影响，可能导致资源浪费或性能不足。  \n- 在显存不足时强行引入复杂并行技术，可能引发调试困难和性能下降。\n\n---\n\n\n\n## 📈 趋势预测\n未来预训练策略可能会更加注重以下方向：\n1. 自动化调参工具的普及，减少人工调整成本。\n2. 更智能的数据采样方法，提升高质量数据使用比例。\n3. 多模型协同训练策略（如多任务联合训练）的进一步发展。\n\n---\n\n\n\n## [思考] 延伸问题\n1. 如何在不同硬件条件下灵活调整 batch size 和学习率？\n2. 是否存在更高效的调度器替代 WSD 调度器？\n3. 长文本适应性优化是否能迁移至多模态任务中？\n\n---\n\n> 原文出处：深度学习预训练策略文档\n\n---\n\n\n\n## 行动清单\n- [ ] 实验不同 batch size 对小模型的影响。\n- [ ] 测试 WSD 调度器与余弦退火算法在大规模任务中的性能差异。\n- [ ] 探索高效的显存管理技术以支持更大规模的预训练。","excerpt":"","includedFiles":[],"tasklistId":3,"title":"","headers":[{"level":2,"title":"元数据","slug":"元数据","link":"#元数据","children":[]},{"level":2,"title":"核心观点总结","slug":"核心观点总结","link":"#核心观点总结","children":[]},{"level":2,"title":"重点内容","slug":"重点内容","link":"#重点内容","children":[{"level":3,"title":"最优 Batch Size 的选择","slug":"最优-batch-size-的选择","link":"#最优-batch-size-的选择","children":[]},{"level":3,"title":"WSD 调度器的三阶段学习率策略","slug":"wsd-调度器的三阶段学习率策略","link":"#wsd-调度器的三阶段学习率策略","children":[]},{"level":3,"title":"提高效率的预训练技巧","slug":"提高效率的预训练技巧","link":"#提高效率的预训练技巧","children":[]}]},{"level":2,"title":"✅ 四阶段预训练设置流程","slug":"✅-四阶段预训练设置流程","link":"#✅-四阶段预训练设置流程","children":[]},{"level":2,"title":"⚠ 常见错误与注意事项","slug":"⚠-常见错误与注意事项","link":"#⚠-常见错误与注意事项","children":[]},{"level":2,"title":"📈 趋势预测","slug":"📈-趋势预测","link":"#📈-趋势预测","children":[]},{"level":2,"title":"[思考] 延伸问题","slug":"思考-延伸问题","link":"#思考-延伸问题","children":[]},{"level":2,"title":"行动清单","slug":"行动清单","link":"#行动清单","children":[]}]}}
