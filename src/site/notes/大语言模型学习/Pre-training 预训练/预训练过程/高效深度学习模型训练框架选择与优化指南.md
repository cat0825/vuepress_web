---
{"dg-publish":true,"dg-permalink":"/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /Pre-training-é¢„è®­ç»ƒ/é¢„è®­ç»ƒè¿‡ç¨‹/é«˜æ•ˆæ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒæ¡†æ¶é€‰æ‹©ä¸ä¼˜åŒ–æŒ‡å—","dg-home":false,"dg-description":"åœ¨æ­¤è¾“å…¥ç¬”è®°çš„æè¿°","dg-hide":false,"dg-hide-title":false,"dg-show-backlinks":true,"dg-show-local-graph":true,"dg-show-inline-title":true,"dg-pinned":false,"dg-passphrase":"åœ¨æ­¤è¾“å…¥è®¿é—®å¯†ç ","dg-enable-mathjax":false,"dg-enable-mermaid":false,"dg-enable-uml":false,"dg-note-icon":0,"dg-enable-dataview":false,"tags":["NLP"],"permalink":"/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /Pre-training-é¢„è®­ç»ƒ/é¢„è®­ç»ƒè¿‡ç¨‹/é«˜æ•ˆæ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒæ¡†æ¶é€‰æ‹©ä¸ä¼˜åŒ–æŒ‡å—/","dgShowBacklinks":true,"dgShowLocalGraph":true,"dgShowInlineTitle":true,"dgPassFrontmatter":true,"noteIcon":0,"created":"2025-04-09T22:01:47.000+08:00","updated":"2025-04-13T13:06:02.000+08:00"}
---



## å…ƒæ•°æ®
**åˆ†ç±»**ï¼šæ·±åº¦å­¦ä¹ /æ¨¡å‹è®­ç»ƒ  
**æ ‡ç­¾**ï¼šLlamaæ¶æ„ã€Megatron-LMã€é¢„è®­ç»ƒã€æ¨¡å‹ä¼˜åŒ–ã€æ·±åº¦å­¦ä¹ æ¡†æ¶  
**æ—¥æœŸ**ï¼š2023å¹´10æœˆXXæ—¥  
---



## æ ¸å¿ƒå†…å®¹æ€»ç»“
æœ¬æ–‡è®¨è®ºäº†å¦‚ä½•é€‰æ‹©åˆé€‚çš„æ·±åº¦å­¦ä¹ æ¨¡å‹ç»“æ„å’Œè®­ç»ƒæ¡†æ¶ï¼Œä»¥å®ç°é«˜æ•ˆé¢„è®­ç»ƒã€‚æ¨èä½¿ç”¨Llamaæ¶æ„ï¼ˆRoPE + GQA + RMS_Norm + SwiGLUï¼‰ä½œä¸ºæ¨¡å‹ç»“æ„ï¼Œå¹¶ä¼˜å…ˆé€‰æ‹©Megatron-LMä½œä¸ºé¢„è®­ç»ƒæ¡†æ¶ï¼ŒåŒæ—¶åˆ†æäº†å…¶é€Ÿåº¦ã€å‚æ•°æ¸…æ™°åº¦å’ŒåŠ è½½æ•ˆç‡çš„ä¼˜åŠ¿ã€‚  

---



## ä¸»è¦å†…å®¹

### æ¨¡å‹ç»“æ„ä¸å‚æ•°é€‰æ‹©
- æ¨èé‡‡ç”¨ **Llamaæ¶æ„**ï¼Œå…¶æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ï¼š
  - **RoPEï¼ˆæ—‹è½¬ä½ç½®ç¼–ç ï¼‰**
  - **GQAï¼ˆGrouped Query Attentionï¼‰**
  - **RMS_Normï¼ˆå‡æ–¹æ ¹å½’ä¸€åŒ–ï¼‰**
  - **SwiGLUï¼ˆæ¿€æ´»å‡½æ•°ï¼‰**
- æ¨¡å‹å‚æ•°çš„é€‰æ‹©éœ€æ ¹æ®è®­ç»ƒèµ„æºè¿›è¡Œçµæ´»è°ƒæ•´ã€‚


### è®­ç»ƒæ¡†æ¶æ¨è
- **ä¼˜é€‰æ¡†æ¶**ï¼šMegatron-LM  
  - å¦‚æœä½¿ç”¨ Qwen æ¨¡å‹ï¼Œå»ºè®®é‡‡ç”¨ **Pai-Megatron-Patch** é¡¹ç›®ï¼ˆ[é¡¹ç›®åœ°å€](https://github.com/alibaba/Pai-Megatron-Patch)ï¼‰ã€‚
- **ä¸æ¨èæ¡†æ¶**ï¼š
  - DeepSpeedï¼ˆåŒ…æ‹¬ OpenRLHF å’Œ DeepSpeed-Chatï¼‰ï¼ŒåŸå› æ˜¯æ€§èƒ½ä¼˜åŒ–ä¸è¶³ã€‚


### é€‰æ‹©Megatron-LMçš„åŸå› 
1. **è®­ç»ƒé€Ÿåº¦å¿«**ï¼š
   - æ”¯æŒé«˜æ•ˆçš„ **tensor_parallel** å’Œ **pipeline_parallel**ã€‚
   - RoPE å·²è¢«ä¼˜åŒ–ä¸º apex ç®—å­ï¼Œæ€§èƒ½æ˜¾è‘—ä¼˜äº Llama çš„å®ç°ã€‚
   - MLP å±‚çš„ apex ç®—å­ä¹Ÿåœ¨å¼€å‘ä¸­ï¼Œæœªæ¥é€Ÿåº¦å°†è¿›ä¸€æ­¥æå‡ã€‚  
   ğŸ’¡*å¯å‘ç‚¹*ï¼šé’ˆå¯¹ RoPE çš„ä¼˜åŒ–æ˜¯æå‡æ€§èƒ½çš„å…³é”®ã€‚
   
2. **å‚æ•°æ¸…æ™°å¯æ§**ï¼š
   - é…ç½®æ–‡ä»¶ `argument.py` æä¾›äº†ä¸Šç™¾ä¸ªå‚æ•°é€‰é¡¹ï¼Œå¦‚ dropout ä½¿ç”¨æƒ…å†µç­‰ï¼Œç”¨æˆ·å¯æ ¹æ®éœ€æ±‚çµæ´»è°ƒæ•´ã€‚

3. **åŠ è½½æ•ˆç‡é«˜**ï¼š
   - åƒäº¿çº§åˆ«æ¨¡å‹åœ¨ä¸€åˆ†é’Ÿå†…å³å¯å®ŒæˆåŠ è½½ï¼Œè°ƒè¯•æ•ˆç‡é«˜ã€‚

---



## æ“ä½œæ­¥éª¤

### å¦‚ä½•é€‰æ‹©ä¸é…ç½®è®­ç»ƒæ¡†æ¶
1. âœ… **ç¡®å®šæ¨¡å‹ç»“æ„**ï¼šä¼˜å…ˆé€‰æ‹© Llama æ¶æ„ï¼Œç¡®ä¿åŒ…å« RoPEã€GQA ç­‰ç»„ä»¶ã€‚
2. âœ… **é€‰æ‹©è®­ç»ƒæ¡†æ¶**ï¼šæ¨è Megatron-LM æˆ– Pai-Megatron-Patchï¼ˆé’ˆå¯¹ Qwen æ¨¡å‹ï¼‰ã€‚
3. âš  **é¿å…ä½¿ç”¨ DeepSpeed**ï¼šå°½é‡é¿å… DeepSpeed ç³»åˆ—æ¡†æ¶ä»¥ç¡®ä¿è®­ç»ƒæ•ˆç‡ã€‚
4. â— **ä¼˜åŒ–å‚æ•°é…ç½®**ï¼šå……åˆ†åˆ©ç”¨ `argument.py` æä¾›çš„çµæ´»é…ç½®é€‰é¡¹ã€‚

---



## å¸¸è§é”™è¯¯
> âš  **è¯¯ç”¨ DeepSpeed æ¡†æ¶**ï¼šDeepSpeed åœ¨ tensor_parallel å’Œ pipeline_parallel çš„ä¼˜åŒ–ä¸Šä¸å¦‚ Megatron-LMï¼Œå¯èƒ½å¯¼è‡´è®­ç»ƒé€Ÿåº¦æ…¢ã€‚  
> âš  **å¿½ç•¥ apex ç®—å­çš„ä¼˜åŠ¿**ï¼šRoPE å’Œ MLP å±‚çš„ apex ç®—å­æ˜¾è‘—æå‡äº†æ•ˆç‡ï¼Œåº”ä¼˜å…ˆåˆ©ç”¨ã€‚

---



## ç¤ºä¾‹ä»£ç 
ä»¥ä¸‹ä¸ºä½¿ç”¨ Megatron-LM æ¡†æ¶çš„åŸºæœ¬å¯åŠ¨ä»£ç ç¤ºä¾‹ï¼š

```python
from megatron import initialize_megatron, train

# åˆå§‹åŒ– Megatron-LM
initialize_megatron(
    tensor_model_parallel_size=4,
    pipeline_model_parallel_size=2,
    micro_batch_size=8,
)

# å¼€å§‹è®­ç»ƒ
train()
```

---



## ğŸ“ˆè¶‹åŠ¿é¢„æµ‹
1. éšç€ apex ç®—å­å¯¹æ›´å¤šå±‚ï¼ˆå¦‚ MLPï¼‰çš„æ”¯æŒï¼Œæœªæ¥ Megatron-LM çš„æ€§èƒ½å°†è¿›ä¸€æ­¥æå‡ã€‚  
2. æ·±åº¦å­¦ä¹ æ¡†æ¶å°†è¶Šæ¥è¶Šæ³¨é‡å¯¹å¤§è§„æ¨¡æ¨¡å‹åŠ è½½å’Œè°ƒè¯•æ•ˆç‡çš„ä¼˜åŒ–ã€‚

---



## [æ€è€ƒ] å»¶ä¼¸é—®é¢˜
1. å¦‚ä½•è¿›ä¸€æ­¥ä¼˜åŒ– Llama æ¶æ„ä»¥é€‚åº”æ›´å¤šä»»åŠ¡åœºæ™¯ï¼Ÿ  
2. é™¤ Megatron-LM å¤–ï¼Œè¿˜æœ‰å“ªäº›æ½œåœ¨çš„é«˜æ•ˆé¢„è®­ç»ƒæ¡†æ¶å€¼å¾—æ¢ç´¢ï¼Ÿ  
3. é’ˆå¯¹ä¸åŒè§„æ¨¡æ¨¡å‹ï¼Œæ˜¯å¦éœ€è¦ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥ï¼Ÿ

---



## è¡ŒåŠ¨æ¸…å•
- [ ] å°è¯•ä½¿ç”¨ Megatron-LM æ¡†æ¶è¿›è¡Œé¢„è®­ç»ƒå®éªŒã€‚
- [ ] å­¦ä¹ å¹¶æŒæ¡ apex ç®—å­çš„ä½¿ç”¨æ–¹æ³•ã€‚
- [ ] è°ƒç ”å…¶ä»–å¼€æºæ¡†æ¶çš„æ€§èƒ½è¡¨ç°å¹¶è¿›è¡Œå¯¹æ¯”åˆ†æã€‚

---



## åç»­è¿½è¸ª
- æŒç»­å…³æ³¨ apex ç®—å­å¯¹å…¶ä»–æ¨¡å‹å±‚çš„æ”¯æŒè¿›å±•ã€‚
- æµ‹è¯• Pai-Megatron-Patch åœ¨ Qwen æ¨¡å‹ä¸Šçš„è¿è¡Œæ•ˆæœã€‚

---

> æ¥æºï¼šæœ¬æ–‡å†…å®¹æ•´ç†è‡ªåŸæ–‡é“¾æ¥ï¼š[https://github.com/alibaba/Pai-Megatron-Patch](https://github.com/alibaba/Pai-Megatron-Patch)
