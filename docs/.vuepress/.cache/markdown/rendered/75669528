{"content":"<p>å…ƒæ•°æ®ï¼š</p>\n<ul>\n<li>åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ </li>\n<li>æ ‡ç­¾ï¼šå¼ºåŒ–å­¦ä¹ ï¼Œå¥–åŠ±æ¨¡å‹ï¼ŒPPOï¼ŒSFT</li>\n<li>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</li>\n</ul>\n<h2 id=\"æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\"><span>æ ¸å¿ƒè§‚ç‚¹æ€»ç»“</span></a></h2>\n<p>åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼Œå¥–åŠ±æ¨¡å‹ï¼ˆReward Modelï¼‰ç”¨äºè¯„ä¼°ç”Ÿæˆçš„å“åº”çš„è´¨é‡ã€‚åœ¨PPOï¼ˆProximal Policy Optimizationï¼‰è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¥–åŠ±æ¨¡å‹çš„å‚æ•°æ˜¯å†»ç»“çš„ï¼Œä»…ç”¨äºæä¾›å¥–åŠ±å€¼ã€‚æœ¬æ–‡ä»‹ç»äº†å¥–åŠ±æ¨¡å‹çš„è®­ç»ƒæµç¨‹åŠå…¶ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„åŒºåˆ«ã€‚\n<img src=\"/img/user/é™„ä»¶/Pasted image 20250416210854.png\" alt=\"Pasted image 20250416210854.png\"></p>\n<h2 id=\"å¥–åŠ±æ¨¡å‹è®­ç»ƒ\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¥–åŠ±æ¨¡å‹è®­ç»ƒ\"><span>å¥–åŠ±æ¨¡å‹è®­ç»ƒ</span></a></h2>\n<p>å¥–åŠ±æ¨¡å‹é€šå¸¸æ˜¯åœ¨SFTï¼ˆSupervised Fine-Tuningï¼‰æ¨¡å‹çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡æ·»åŠ ä»·å€¼å¤´ï¼ˆValue Headï¼‰è¿›è¡Œè®­ç»ƒã€‚ä»¥ä¸‹æ˜¯å¥–åŠ±æ¨¡å‹è®­ç»ƒçš„å…³é”®æ­¥éª¤ï¼š</p>\n<ul>\n<li><strong>å¥–åŠ±è®¡ç®—</strong>ï¼šåªåœ¨æœ€åä¸€ä¸ªtokenå¤„è®¡ç®—å¥–åŠ±å€¼ï¼Œä½œä¸ºæ•´ä¸ªå“åº”çš„å¥–åŠ±ã€‚</li>\n<li><strong>æŸå¤±å‡½æ•°</strong>ï¼š<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Reward_loss</mtext><mo>=</mo><mo>âˆ’</mo><msub><mi>E</mi><mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>l</mi></msub><mo stretchy=\"false\">)</mo><mo>âˆ¼</mo><mi>D</mi></mrow></msub><mrow><mo fence=\"true\">[</mo><mi>log</mi><mo>â¡</mo><mrow><mo fence=\"true\">(</mo><mfrac><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mi>r</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mi>r</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mo>+</mo><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mi>r</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>l</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow></mfrac><mo fence=\"true\">)</mo></mrow><mo fence=\"true\">]</mo></mrow></mrow><annotation encoding=\"application/x-tex\">\\text{Reward\\_loss} = - E_{(x, y_w, y_l) \\sim D} \\left[ \\log \\left( \\frac{\\exp(r(x, y_w))}{\\exp(r(x, y_w)) + \\exp(r(x, y_l))} \\right) \\right]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0044em;vertical-align:-0.31em;\"></span><span class=\"mord text\"><span class=\"mord\">Reward_loss</span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.4em;vertical-align:-0.95em;\"></span><span class=\"mord\">âˆ’</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\">x</span><span class=\"mpunct mtight\">,</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1645em;\"><span style=\"top:-2.357em;margin-left:-0.0359em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span><span class=\"mpunct mtight\">,</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1512em;\"><span></span></span></span></span></span></span><span class=\"mclose mtight\">)</span><span class=\"mrel mtight\">âˆ¼</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D</span></span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3552em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">[</span></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.427em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.936em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">]</span></span></span></span></span></span></span></p>\nå…¶ä¸­ <span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> è¡¨ç¤ºæç¤ºï¼ˆpromptï¼‰ï¼Œ<span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>w</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_w</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> è¡¨ç¤ºé€‰æ‹©çš„å“åº”ï¼ˆchosen responseï¼‰ï¼Œ<span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>l</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_l</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> è¡¨ç¤ºæ‹’ç»çš„å“åº”ï¼ˆrejected responseï¼‰ã€‚</li>\n</ul>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"--shiki-light:#2E8F82;--shiki-dark:#5DA994\"> PairWiseLoss</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">Module</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">    \"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">    Pairwise Loss for Reward Model</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">    \"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">    def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> forward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> chosen_reward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reject_reward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> margin</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        if</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> margin </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">is</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> not</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> None</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            loss </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">F</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logsigmoid</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">chosen_reward </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reject_reward </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> margin</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        else</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            loss </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">F</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logsigmoid</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">chosen_reward </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reject_reward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> loss</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">mean</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2 id=\"ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”\"><span>ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”</span></a></h2>\n<p>ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„RLHFï¼ˆReinforcement Learning with Human Feedbackï¼‰å¯¹ä¸€æ¡è½¨è¿¹ä¸­çš„æ‰€æœ‰çŠ¶æ€åŠ¨ä½œå¯¹è¿›è¡Œå¥–åŠ±åŠ å’Œï¼Œè€Œå¤§æ¨¡å‹å¥–åŠ±æ¨¡å‹ä»…é’ˆå¯¹æ•´ä¸ªå“åº”æä¾›ä¸€ä¸ªå¥–åŠ±å€¼ã€‚</p>\n<ul>\n<li><strong>ä¼ ç»ŸRLHFæŸå¤±å‡½æ•°</strong>ï¼š<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Reward_loss</mtext><mo>=</mo><mo>âˆ’</mo><msub><mi>E</mi><mrow><mo stretchy=\"false\">(</mo><msup><mi>Ïƒ</mi><mo>+</mo></msup><mo separator=\"true\">,</mo><msup><mi>Ïƒ</mi><mo>âˆ’</mo></msup><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo><mo>âˆˆ</mo><mi>D</mi></mrow></msub><mrow><mo fence=\"true\">[</mo><mi>log</mi><mo>â¡</mo><mrow><mo fence=\"true\">(</mo><mfrac><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mo>âˆ‘</mo><mi>r</mi><mo stretchy=\"false\">(</mo><msubsup><mi>s</mi><mi>t</mi><mo>+</mo></msubsup><mo separator=\"true\">,</mo><msubsup><mi>a</mi><mi>t</mi><mo>+</mo></msubsup><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mo>âˆ‘</mo><mi>r</mi><mo stretchy=\"false\">(</mo><msubsup><mi>s</mi><mi>t</mi><mo>+</mo></msubsup><mo separator=\"true\">,</mo><msubsup><mi>a</mi><mi>t</mi><mo>+</mo></msubsup><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mo>+</mo><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mo>âˆ‘</mo><mi>r</mi><mo stretchy=\"false\">(</mo><msubsup><mi>s</mi><mi>t</mi><mo>âˆ’</mo></msubsup><mo separator=\"true\">,</mo><msubsup><mi>a</mi><mi>t</mi><mo>âˆ’</mo></msubsup><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow></mfrac><mo fence=\"true\">)</mo></mrow><mo fence=\"true\">]</mo></mrow></mrow><annotation encoding=\"application/x-tex\">\\text{Reward\\_loss} = - E_{(\\sigma^+, \\sigma^-, y) \\in D} \\left[ \\log \\left( \\frac{\\exp(\\sum r(s_t^+, a_t^+))}{\\exp(\\sum r(s_t^+ , a_t^+)) + \\exp(\\sum r(s_t^-, a_t^-))} \\right) \\right]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0044em;vertical-align:-0.31em;\"></span><span class=\"mord text\"><span class=\"mord\">Reward_loss</span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.4399em;vertical-align:-0.9515em;\"></span><span class=\"mord\">âˆ’</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">Ïƒ</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7027em;\"><span style=\"top:-2.786em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mbin mtight\">+</span></span></span></span></span></span></span></span><span class=\"mpunct mtight\">,</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">Ïƒ</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7027em;\"><span style=\"top:-2.786em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mbin mtight\">âˆ’</span></span></span></span></span></span></span></span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose mtight\">)</span><span class=\"mrel mtight\">âˆˆ</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D</span></span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3552em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">[</span></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4885em;\"><span style=\"top:-2.2985em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">âˆ‘</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">+</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">+</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">âˆ‘</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">âˆ’</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">âˆ’</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">âˆ‘</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">+</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">+</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9515em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">]</span></span></span></span></span></span></span></p>\n</li>\n</ul>\n<p><img src=\"/img/user/é™„ä»¶/Pasted image 20250416210927.png\" alt=\"Pasted image 20250416210927.png\"></p>\n<h2 id=\"èšåˆæ“ä½œ\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#èšåˆæ“ä½œ\"><span>èšåˆæ“ä½œ</span></a></h2>\n<p>å¯ä»¥å°†ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ ä¸­çš„å¥–åŠ±åŠ å’Œæ›¿æ¢ä¸ºèšåˆæ“ä½œ <span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>AGG</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{AGG}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">AGG</span></span></span></span></span>ï¼Œå¦‚åŠ å’Œã€åŠ æƒå’Œã€å–æœ€åä¸€ä¸ªå€¼æˆ–ä½¿ç”¨Transformerèšåˆã€‚</p>\n<h2 id=\"æ“ä½œæ­¥éª¤\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ“ä½œæ­¥éª¤\"><span>æ“ä½œæ­¥éª¤</span></a></h2>\n<ol>\n<li>âœ… åœ¨SFTæ¨¡å‹ä¸Šæ·»åŠ Value Headã€‚</li>\n<li>âš ï¸ è®­ç»ƒè¿‡ç¨‹ä¸­å†»ç»“Reward Modelå‚æ•°ã€‚</li>\n<li>â— ä½¿ç”¨æœ€åä¸€ä¸ªtokençš„å€¼ä½œä¸ºæ•´ä¸ªå“åº”çš„å¥–åŠ±ã€‚</li>\n</ol>\n<h2 id=\"å¸¸è§é”™è¯¯\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¸¸è§é”™è¯¯\"><span>å¸¸è§é”™è¯¯</span></a></h2>\n<blockquote>\n<p>åœ¨å¥–åŠ±è®¡ç®—æ—¶ï¼Œè¯¯å°†ä¸­é—´tokençš„å€¼ä½œä¸ºæœ€ç»ˆå¥–åŠ±ã€‚</p>\n</blockquote>\n<h2 id=\"ğŸ’¡å¯å‘ç‚¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ğŸ’¡å¯å‘ç‚¹\"><span>ğŸ’¡å¯å‘ç‚¹</span></a></h2>\n<ul>\n<li>å°†promptåˆ°responseè§†ä¸ºå•æ­¥MDPï¼ˆMarkov Decision Processï¼‰ï¼Œè¿™ç®€åŒ–äº†æ¨¡å‹çš„å¤æ‚æ€§ã€‚</li>\n</ul>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ul>\n<li>æ¢ç´¢æ›´å¤šèšåˆæ“ä½œåœ¨å¥–åŠ±æ¨¡å‹ä¸­çš„åº”ç”¨ã€‚</li>\n<li>ç ”ç©¶ä¸åŒreward modelåœ¨PPOä¸­çš„è¡¨ç°å·®å¼‚ã€‚</li>\n</ul>\n<blockquote>\n<p>åŸå§‹å‡ºå¤„ï¼š[åŸæ–‡é“¾æ¥æˆ–ä¹¦åç« èŠ‚]</p>\n</blockquote>\n","env":{"base":"/","filePath":"/Users/qianyuhe/Desktop/my-project/docs/notes_bak/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/RLHFåŸºäºäººç±»åé¦ˆçš„å¼ºåŒ–å­¦ä¹ /Reward-Model.md","filePathRelative":"notes_bak/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/RLHFåŸºäºäººç±»åé¦ˆçš„å¼ºåŒ–å­¦ä¹ /Reward-Model.md","frontmatter":{"dg-publish":true,"dg-permalink":"/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/RLHFåŸºäºäººç±»åé¦ˆçš„å¼ºåŒ–å­¦ä¹ /Reward-Model","dg-home":false,"dg-description":"åœ¨æ­¤è¾“å…¥ç¬”è®°çš„æè¿°","dg-hide":false,"dg-hide-title":false,"dg-show-backlinks":true,"dg-show-local-graph":true,"dg-show-inline-title":true,"dg-pinned":false,"dg-passphrase":"åœ¨æ­¤è¾“å…¥è®¿é—®å¯†ç ","dg-enable-mathjax":false,"dg-enable-mermaid":false,"dg-enable-uml":false,"dg-note-icon":0,"dg-enable-dataview":false,"tags":["NLP"],"permalink":"/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/RLHFåŸºäºäººç±»åé¦ˆçš„å¼ºåŒ–å­¦ä¹ /Reward-Model/","dgShowBacklinks":true,"dgShowLocalGraph":true,"dgShowInlineTitle":true,"dgPassFrontmatter":true,"noteIcon":0,"created":"2025-04-16T13:01:20.000Z","updated":"2025-04-17T01:02:24.000Z","title":"Reward-Model","createTime":"2025/05/13 17:33:52"},"sfcBlocks":{"template":{"type":"template","content":"<template><p>å…ƒæ•°æ®ï¼š</p>\n<ul>\n<li>åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ </li>\n<li>æ ‡ç­¾ï¼šå¼ºåŒ–å­¦ä¹ ï¼Œå¥–åŠ±æ¨¡å‹ï¼ŒPPOï¼ŒSFT</li>\n<li>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</li>\n</ul>\n<h2 id=\"æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\"><span>æ ¸å¿ƒè§‚ç‚¹æ€»ç»“</span></a></h2>\n<p>åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼Œå¥–åŠ±æ¨¡å‹ï¼ˆReward Modelï¼‰ç”¨äºè¯„ä¼°ç”Ÿæˆçš„å“åº”çš„è´¨é‡ã€‚åœ¨PPOï¼ˆProximal Policy Optimizationï¼‰è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¥–åŠ±æ¨¡å‹çš„å‚æ•°æ˜¯å†»ç»“çš„ï¼Œä»…ç”¨äºæä¾›å¥–åŠ±å€¼ã€‚æœ¬æ–‡ä»‹ç»äº†å¥–åŠ±æ¨¡å‹çš„è®­ç»ƒæµç¨‹åŠå…¶ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„åŒºåˆ«ã€‚\n<img src=\"/img/user/é™„ä»¶/Pasted image 20250416210854.png\" alt=\"Pasted image 20250416210854.png\"></p>\n<h2 id=\"å¥–åŠ±æ¨¡å‹è®­ç»ƒ\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¥–åŠ±æ¨¡å‹è®­ç»ƒ\"><span>å¥–åŠ±æ¨¡å‹è®­ç»ƒ</span></a></h2>\n<p>å¥–åŠ±æ¨¡å‹é€šå¸¸æ˜¯åœ¨SFTï¼ˆSupervised Fine-Tuningï¼‰æ¨¡å‹çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡æ·»åŠ ä»·å€¼å¤´ï¼ˆValue Headï¼‰è¿›è¡Œè®­ç»ƒã€‚ä»¥ä¸‹æ˜¯å¥–åŠ±æ¨¡å‹è®­ç»ƒçš„å…³é”®æ­¥éª¤ï¼š</p>\n<ul>\n<li><strong>å¥–åŠ±è®¡ç®—</strong>ï¼šåªåœ¨æœ€åä¸€ä¸ªtokenå¤„è®¡ç®—å¥–åŠ±å€¼ï¼Œä½œä¸ºæ•´ä¸ªå“åº”çš„å¥–åŠ±ã€‚</li>\n<li><strong>æŸå¤±å‡½æ•°</strong>ï¼š<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Reward_loss</mtext><mo>=</mo><mo>âˆ’</mo><msub><mi>E</mi><mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>l</mi></msub><mo stretchy=\"false\">)</mo><mo>âˆ¼</mo><mi>D</mi></mrow></msub><mrow><mo fence=\"true\">[</mo><mi>log</mi><mo>â¡</mo><mrow><mo fence=\"true\">(</mo><mfrac><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mi>r</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mi>r</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mo>+</mo><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mi>r</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>l</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow></mfrac><mo fence=\"true\">)</mo></mrow><mo fence=\"true\">]</mo></mrow></mrow><annotation encoding=\"application/x-tex\">\\text{Reward\\_loss} = - E_{(x, y_w, y_l) \\sim D} \\left[ \\log \\left( \\frac{\\exp(r(x, y_w))}{\\exp(r(x, y_w)) + \\exp(r(x, y_l))} \\right) \\right]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0044em;vertical-align:-0.31em;\"></span><span class=\"mord text\"><span class=\"mord\">Reward_loss</span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.4em;vertical-align:-0.95em;\"></span><span class=\"mord\">âˆ’</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\">x</span><span class=\"mpunct mtight\">,</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1645em;\"><span style=\"top:-2.357em;margin-left:-0.0359em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span><span class=\"mpunct mtight\">,</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1512em;\"><span></span></span></span></span></span></span><span class=\"mclose mtight\">)</span><span class=\"mrel mtight\">âˆ¼</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D</span></span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3552em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">[</span></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.427em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.936em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">]</span></span></span></span></span></span></span></p>\nå…¶ä¸­ <span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> è¡¨ç¤ºæç¤ºï¼ˆpromptï¼‰ï¼Œ<span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>w</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_w</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> è¡¨ç¤ºé€‰æ‹©çš„å“åº”ï¼ˆchosen responseï¼‰ï¼Œ<span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>l</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_l</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> è¡¨ç¤ºæ‹’ç»çš„å“åº”ï¼ˆrejected responseï¼‰ã€‚</li>\n</ul>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"--shiki-light:#2E8F82;--shiki-dark:#5DA994\"> PairWiseLoss</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">Module</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">    \"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">    Pairwise Loss for Reward Model</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">    \"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">    def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> forward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> chosen_reward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reject_reward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> margin</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        if</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> margin </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">is</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> not</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> None</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            loss </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">F</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logsigmoid</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">chosen_reward </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reject_reward </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> margin</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        else</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            loss </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">F</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logsigmoid</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">chosen_reward </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reject_reward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> loss</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">mean</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2 id=\"ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”\"><span>ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”</span></a></h2>\n<p>ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„RLHFï¼ˆReinforcement Learning with Human Feedbackï¼‰å¯¹ä¸€æ¡è½¨è¿¹ä¸­çš„æ‰€æœ‰çŠ¶æ€åŠ¨ä½œå¯¹è¿›è¡Œå¥–åŠ±åŠ å’Œï¼Œè€Œå¤§æ¨¡å‹å¥–åŠ±æ¨¡å‹ä»…é’ˆå¯¹æ•´ä¸ªå“åº”æä¾›ä¸€ä¸ªå¥–åŠ±å€¼ã€‚</p>\n<ul>\n<li><strong>ä¼ ç»ŸRLHFæŸå¤±å‡½æ•°</strong>ï¼š<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Reward_loss</mtext><mo>=</mo><mo>âˆ’</mo><msub><mi>E</mi><mrow><mo stretchy=\"false\">(</mo><msup><mi>Ïƒ</mi><mo>+</mo></msup><mo separator=\"true\">,</mo><msup><mi>Ïƒ</mi><mo>âˆ’</mo></msup><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo><mo>âˆˆ</mo><mi>D</mi></mrow></msub><mrow><mo fence=\"true\">[</mo><mi>log</mi><mo>â¡</mo><mrow><mo fence=\"true\">(</mo><mfrac><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mo>âˆ‘</mo><mi>r</mi><mo stretchy=\"false\">(</mo><msubsup><mi>s</mi><mi>t</mi><mo>+</mo></msubsup><mo separator=\"true\">,</mo><msubsup><mi>a</mi><mi>t</mi><mo>+</mo></msubsup><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mo>âˆ‘</mo><mi>r</mi><mo stretchy=\"false\">(</mo><msubsup><mi>s</mi><mi>t</mi><mo>+</mo></msubsup><mo separator=\"true\">,</mo><msubsup><mi>a</mi><mi>t</mi><mo>+</mo></msubsup><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mo>+</mo><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mo>âˆ‘</mo><mi>r</mi><mo stretchy=\"false\">(</mo><msubsup><mi>s</mi><mi>t</mi><mo>âˆ’</mo></msubsup><mo separator=\"true\">,</mo><msubsup><mi>a</mi><mi>t</mi><mo>âˆ’</mo></msubsup><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow></mfrac><mo fence=\"true\">)</mo></mrow><mo fence=\"true\">]</mo></mrow></mrow><annotation encoding=\"application/x-tex\">\\text{Reward\\_loss} = - E_{(\\sigma^+, \\sigma^-, y) \\in D} \\left[ \\log \\left( \\frac{\\exp(\\sum r(s_t^+, a_t^+))}{\\exp(\\sum r(s_t^+ , a_t^+)) + \\exp(\\sum r(s_t^-, a_t^-))} \\right) \\right]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0044em;vertical-align:-0.31em;\"></span><span class=\"mord text\"><span class=\"mord\">Reward_loss</span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.4399em;vertical-align:-0.9515em;\"></span><span class=\"mord\">âˆ’</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">Ïƒ</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7027em;\"><span style=\"top:-2.786em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mbin mtight\">+</span></span></span></span></span></span></span></span><span class=\"mpunct mtight\">,</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">Ïƒ</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7027em;\"><span style=\"top:-2.786em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mbin mtight\">âˆ’</span></span></span></span></span></span></span></span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose mtight\">)</span><span class=\"mrel mtight\">âˆˆ</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D</span></span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3552em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">[</span></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4885em;\"><span style=\"top:-2.2985em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">âˆ‘</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">+</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">+</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">âˆ‘</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">âˆ’</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">âˆ’</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">âˆ‘</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">+</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">+</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9515em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">]</span></span></span></span></span></span></span></p>\n</li>\n</ul>\n<p><img src=\"/img/user/é™„ä»¶/Pasted image 20250416210927.png\" alt=\"Pasted image 20250416210927.png\"></p>\n<h2 id=\"èšåˆæ“ä½œ\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#èšåˆæ“ä½œ\"><span>èšåˆæ“ä½œ</span></a></h2>\n<p>å¯ä»¥å°†ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ ä¸­çš„å¥–åŠ±åŠ å’Œæ›¿æ¢ä¸ºèšåˆæ“ä½œ <span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>AGG</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{AGG}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">AGG</span></span></span></span></span>ï¼Œå¦‚åŠ å’Œã€åŠ æƒå’Œã€å–æœ€åä¸€ä¸ªå€¼æˆ–ä½¿ç”¨Transformerèšåˆã€‚</p>\n<h2 id=\"æ“ä½œæ­¥éª¤\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ“ä½œæ­¥éª¤\"><span>æ“ä½œæ­¥éª¤</span></a></h2>\n<ol>\n<li>âœ… åœ¨SFTæ¨¡å‹ä¸Šæ·»åŠ Value Headã€‚</li>\n<li>âš ï¸ è®­ç»ƒè¿‡ç¨‹ä¸­å†»ç»“Reward Modelå‚æ•°ã€‚</li>\n<li>â— ä½¿ç”¨æœ€åä¸€ä¸ªtokençš„å€¼ä½œä¸ºæ•´ä¸ªå“åº”çš„å¥–åŠ±ã€‚</li>\n</ol>\n<h2 id=\"å¸¸è§é”™è¯¯\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¸¸è§é”™è¯¯\"><span>å¸¸è§é”™è¯¯</span></a></h2>\n<blockquote>\n<p>åœ¨å¥–åŠ±è®¡ç®—æ—¶ï¼Œè¯¯å°†ä¸­é—´tokençš„å€¼ä½œä¸ºæœ€ç»ˆå¥–åŠ±ã€‚</p>\n</blockquote>\n<h2 id=\"ğŸ’¡å¯å‘ç‚¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ğŸ’¡å¯å‘ç‚¹\"><span>ğŸ’¡å¯å‘ç‚¹</span></a></h2>\n<ul>\n<li>å°†promptåˆ°responseè§†ä¸ºå•æ­¥MDPï¼ˆMarkov Decision Processï¼‰ï¼Œè¿™ç®€åŒ–äº†æ¨¡å‹çš„å¤æ‚æ€§ã€‚</li>\n</ul>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ul>\n<li>æ¢ç´¢æ›´å¤šèšåˆæ“ä½œåœ¨å¥–åŠ±æ¨¡å‹ä¸­çš„åº”ç”¨ã€‚</li>\n<li>ç ”ç©¶ä¸åŒreward modelåœ¨PPOä¸­çš„è¡¨ç°å·®å¼‚ã€‚</li>\n</ul>\n<blockquote>\n<p>åŸå§‹å‡ºå¤„ï¼š[åŸæ–‡é“¾æ¥æˆ–ä¹¦åç« èŠ‚]</p>\n</blockquote>\n</template>","contentStripped":"<p>å…ƒæ•°æ®ï¼š</p>\n<ul>\n<li>åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ </li>\n<li>æ ‡ç­¾ï¼šå¼ºåŒ–å­¦ä¹ ï¼Œå¥–åŠ±æ¨¡å‹ï¼ŒPPOï¼ŒSFT</li>\n<li>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</li>\n</ul>\n<h2 id=\"æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\"><span>æ ¸å¿ƒè§‚ç‚¹æ€»ç»“</span></a></h2>\n<p>åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼Œå¥–åŠ±æ¨¡å‹ï¼ˆReward Modelï¼‰ç”¨äºè¯„ä¼°ç”Ÿæˆçš„å“åº”çš„è´¨é‡ã€‚åœ¨PPOï¼ˆProximal Policy Optimizationï¼‰è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¥–åŠ±æ¨¡å‹çš„å‚æ•°æ˜¯å†»ç»“çš„ï¼Œä»…ç”¨äºæä¾›å¥–åŠ±å€¼ã€‚æœ¬æ–‡ä»‹ç»äº†å¥–åŠ±æ¨¡å‹çš„è®­ç»ƒæµç¨‹åŠå…¶ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„åŒºåˆ«ã€‚\n<img src=\"/img/user/é™„ä»¶/Pasted image 20250416210854.png\" alt=\"Pasted image 20250416210854.png\"></p>\n<h2 id=\"å¥–åŠ±æ¨¡å‹è®­ç»ƒ\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¥–åŠ±æ¨¡å‹è®­ç»ƒ\"><span>å¥–åŠ±æ¨¡å‹è®­ç»ƒ</span></a></h2>\n<p>å¥–åŠ±æ¨¡å‹é€šå¸¸æ˜¯åœ¨SFTï¼ˆSupervised Fine-Tuningï¼‰æ¨¡å‹çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡æ·»åŠ ä»·å€¼å¤´ï¼ˆValue Headï¼‰è¿›è¡Œè®­ç»ƒã€‚ä»¥ä¸‹æ˜¯å¥–åŠ±æ¨¡å‹è®­ç»ƒçš„å…³é”®æ­¥éª¤ï¼š</p>\n<ul>\n<li><strong>å¥–åŠ±è®¡ç®—</strong>ï¼šåªåœ¨æœ€åä¸€ä¸ªtokenå¤„è®¡ç®—å¥–åŠ±å€¼ï¼Œä½œä¸ºæ•´ä¸ªå“åº”çš„å¥–åŠ±ã€‚</li>\n<li><strong>æŸå¤±å‡½æ•°</strong>ï¼š<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Reward_loss</mtext><mo>=</mo><mo>âˆ’</mo><msub><mi>E</mi><mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>l</mi></msub><mo stretchy=\"false\">)</mo><mo>âˆ¼</mo><mi>D</mi></mrow></msub><mrow><mo fence=\"true\">[</mo><mi>log</mi><mo>â¡</mo><mrow><mo fence=\"true\">(</mo><mfrac><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mi>r</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mi>r</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mo>+</mo><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mi>r</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>l</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow></mfrac><mo fence=\"true\">)</mo></mrow><mo fence=\"true\">]</mo></mrow></mrow><annotation encoding=\"application/x-tex\">\\text{Reward\\_loss} = - E_{(x, y_w, y_l) \\sim D} \\left[ \\log \\left( \\frac{\\exp(r(x, y_w))}{\\exp(r(x, y_w)) + \\exp(r(x, y_l))} \\right) \\right]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0044em;vertical-align:-0.31em;\"></span><span class=\"mord text\"><span class=\"mord\">Reward_loss</span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.4em;vertical-align:-0.95em;\"></span><span class=\"mord\">âˆ’</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\">x</span><span class=\"mpunct mtight\">,</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1645em;\"><span style=\"top:-2.357em;margin-left:-0.0359em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span><span class=\"mpunct mtight\">,</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1512em;\"><span></span></span></span></span></span></span><span class=\"mclose mtight\">)</span><span class=\"mrel mtight\">âˆ¼</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D</span></span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3552em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">[</span></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.427em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.936em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">]</span></span></span></span></span></span></span></p>\nå…¶ä¸­ <span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> è¡¨ç¤ºæç¤ºï¼ˆpromptï¼‰ï¼Œ<span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>w</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_w</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> è¡¨ç¤ºé€‰æ‹©çš„å“åº”ï¼ˆchosen responseï¼‰ï¼Œ<span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>l</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_l</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> è¡¨ç¤ºæ‹’ç»çš„å“åº”ï¼ˆrejected responseï¼‰ã€‚</li>\n</ul>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"--shiki-light:#2E8F82;--shiki-dark:#5DA994\"> PairWiseLoss</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">Module</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">    \"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">    Pairwise Loss for Reward Model</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">    \"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">    def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> forward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> chosen_reward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reject_reward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> margin</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        if</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> margin </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">is</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> not</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> None</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            loss </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">F</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logsigmoid</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">chosen_reward </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reject_reward </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> margin</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        else</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            loss </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">F</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logsigmoid</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">chosen_reward </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reject_reward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> loss</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">mean</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2 id=\"ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”\"><span>ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”</span></a></h2>\n<p>ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„RLHFï¼ˆReinforcement Learning with Human Feedbackï¼‰å¯¹ä¸€æ¡è½¨è¿¹ä¸­çš„æ‰€æœ‰çŠ¶æ€åŠ¨ä½œå¯¹è¿›è¡Œå¥–åŠ±åŠ å’Œï¼Œè€Œå¤§æ¨¡å‹å¥–åŠ±æ¨¡å‹ä»…é’ˆå¯¹æ•´ä¸ªå“åº”æä¾›ä¸€ä¸ªå¥–åŠ±å€¼ã€‚</p>\n<ul>\n<li><strong>ä¼ ç»ŸRLHFæŸå¤±å‡½æ•°</strong>ï¼š<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Reward_loss</mtext><mo>=</mo><mo>âˆ’</mo><msub><mi>E</mi><mrow><mo stretchy=\"false\">(</mo><msup><mi>Ïƒ</mi><mo>+</mo></msup><mo separator=\"true\">,</mo><msup><mi>Ïƒ</mi><mo>âˆ’</mo></msup><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo><mo>âˆˆ</mo><mi>D</mi></mrow></msub><mrow><mo fence=\"true\">[</mo><mi>log</mi><mo>â¡</mo><mrow><mo fence=\"true\">(</mo><mfrac><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mo>âˆ‘</mo><mi>r</mi><mo stretchy=\"false\">(</mo><msubsup><mi>s</mi><mi>t</mi><mo>+</mo></msubsup><mo separator=\"true\">,</mo><msubsup><mi>a</mi><mi>t</mi><mo>+</mo></msubsup><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mo>âˆ‘</mo><mi>r</mi><mo stretchy=\"false\">(</mo><msubsup><mi>s</mi><mi>t</mi><mo>+</mo></msubsup><mo separator=\"true\">,</mo><msubsup><mi>a</mi><mi>t</mi><mo>+</mo></msubsup><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mo>+</mo><mi>exp</mi><mo>â¡</mo><mo stretchy=\"false\">(</mo><mo>âˆ‘</mo><mi>r</mi><mo stretchy=\"false\">(</mo><msubsup><mi>s</mi><mi>t</mi><mo>âˆ’</mo></msubsup><mo separator=\"true\">,</mo><msubsup><mi>a</mi><mi>t</mi><mo>âˆ’</mo></msubsup><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow></mfrac><mo fence=\"true\">)</mo></mrow><mo fence=\"true\">]</mo></mrow></mrow><annotation encoding=\"application/x-tex\">\\text{Reward\\_loss} = - E_{(\\sigma^+, \\sigma^-, y) \\in D} \\left[ \\log \\left( \\frac{\\exp(\\sum r(s_t^+, a_t^+))}{\\exp(\\sum r(s_t^+ , a_t^+)) + \\exp(\\sum r(s_t^-, a_t^-))} \\right) \\right]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0044em;vertical-align:-0.31em;\"></span><span class=\"mord text\"><span class=\"mord\">Reward_loss</span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.4399em;vertical-align:-0.9515em;\"></span><span class=\"mord\">âˆ’</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">Ïƒ</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7027em;\"><span style=\"top:-2.786em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mbin mtight\">+</span></span></span></span></span></span></span></span><span class=\"mpunct mtight\">,</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">Ïƒ</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7027em;\"><span style=\"top:-2.786em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mbin mtight\">âˆ’</span></span></span></span></span></span></span></span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose mtight\">)</span><span class=\"mrel mtight\">âˆˆ</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D</span></span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3552em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">[</span></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4885em;\"><span style=\"top:-2.2985em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">âˆ‘</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">+</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">+</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">âˆ‘</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">âˆ’</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">âˆ’</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">âˆ‘</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">+</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8115em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span><span style=\"top:-3.1031em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">+</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9515em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">]</span></span></span></span></span></span></span></p>\n</li>\n</ul>\n<p><img src=\"/img/user/é™„ä»¶/Pasted image 20250416210927.png\" alt=\"Pasted image 20250416210927.png\"></p>\n<h2 id=\"èšåˆæ“ä½œ\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#èšåˆæ“ä½œ\"><span>èšåˆæ“ä½œ</span></a></h2>\n<p>å¯ä»¥å°†ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ ä¸­çš„å¥–åŠ±åŠ å’Œæ›¿æ¢ä¸ºèšåˆæ“ä½œ <span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>AGG</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{AGG}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">AGG</span></span></span></span></span>ï¼Œå¦‚åŠ å’Œã€åŠ æƒå’Œã€å–æœ€åä¸€ä¸ªå€¼æˆ–ä½¿ç”¨Transformerèšåˆã€‚</p>\n<h2 id=\"æ“ä½œæ­¥éª¤\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ“ä½œæ­¥éª¤\"><span>æ“ä½œæ­¥éª¤</span></a></h2>\n<ol>\n<li>âœ… åœ¨SFTæ¨¡å‹ä¸Šæ·»åŠ Value Headã€‚</li>\n<li>âš ï¸ è®­ç»ƒè¿‡ç¨‹ä¸­å†»ç»“Reward Modelå‚æ•°ã€‚</li>\n<li>â— ä½¿ç”¨æœ€åä¸€ä¸ªtokençš„å€¼ä½œä¸ºæ•´ä¸ªå“åº”çš„å¥–åŠ±ã€‚</li>\n</ol>\n<h2 id=\"å¸¸è§é”™è¯¯\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¸¸è§é”™è¯¯\"><span>å¸¸è§é”™è¯¯</span></a></h2>\n<blockquote>\n<p>åœ¨å¥–åŠ±è®¡ç®—æ—¶ï¼Œè¯¯å°†ä¸­é—´tokençš„å€¼ä½œä¸ºæœ€ç»ˆå¥–åŠ±ã€‚</p>\n</blockquote>\n<h2 id=\"ğŸ’¡å¯å‘ç‚¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ğŸ’¡å¯å‘ç‚¹\"><span>ğŸ’¡å¯å‘ç‚¹</span></a></h2>\n<ul>\n<li>å°†promptåˆ°responseè§†ä¸ºå•æ­¥MDPï¼ˆMarkov Decision Processï¼‰ï¼Œè¿™ç®€åŒ–äº†æ¨¡å‹çš„å¤æ‚æ€§ã€‚</li>\n</ul>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ul>\n<li>æ¢ç´¢æ›´å¤šèšåˆæ“ä½œåœ¨å¥–åŠ±æ¨¡å‹ä¸­çš„åº”ç”¨ã€‚</li>\n<li>ç ”ç©¶ä¸åŒreward modelåœ¨PPOä¸­çš„è¡¨ç°å·®å¼‚ã€‚</li>\n</ul>\n<blockquote>\n<p>åŸå§‹å‡ºå¤„ï¼š[åŸæ–‡é“¾æ¥æˆ–ä¹¦åç« èŠ‚]</p>\n</blockquote>\n","tagOpen":"<template>","tagClose":"</template>"},"script":null,"scriptSetup":null,"scripts":[],"styles":[],"customBlocks":[]},"content":"å…ƒæ•°æ®ï¼š\n\n- åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ \n- æ ‡ç­¾ï¼šå¼ºåŒ–å­¦ä¹ ï¼Œå¥–åŠ±æ¨¡å‹ï¼ŒPPOï¼ŒSFT\n- æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥\n\n## æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\nåœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼Œå¥–åŠ±æ¨¡å‹ï¼ˆReward Modelï¼‰ç”¨äºè¯„ä¼°ç”Ÿæˆçš„å“åº”çš„è´¨é‡ã€‚åœ¨PPOï¼ˆProximal Policy Optimizationï¼‰è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¥–åŠ±æ¨¡å‹çš„å‚æ•°æ˜¯å†»ç»“çš„ï¼Œä»…ç”¨äºæä¾›å¥–åŠ±å€¼ã€‚æœ¬æ–‡ä»‹ç»äº†å¥–åŠ±æ¨¡å‹çš„è®­ç»ƒæµç¨‹åŠå…¶ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„åŒºåˆ«ã€‚\n![Pasted image 20250416210854.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250416210854.png)\n\n\n## å¥–åŠ±æ¨¡å‹è®­ç»ƒ\nå¥–åŠ±æ¨¡å‹é€šå¸¸æ˜¯åœ¨SFTï¼ˆSupervised Fine-Tuningï¼‰æ¨¡å‹çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡æ·»åŠ ä»·å€¼å¤´ï¼ˆValue Headï¼‰è¿›è¡Œè®­ç»ƒã€‚ä»¥ä¸‹æ˜¯å¥–åŠ±æ¨¡å‹è®­ç»ƒçš„å…³é”®æ­¥éª¤ï¼š\n\n- **å¥–åŠ±è®¡ç®—**ï¼šåªåœ¨æœ€åä¸€ä¸ªtokenå¤„è®¡ç®—å¥–åŠ±å€¼ï¼Œä½œä¸ºæ•´ä¸ªå“åº”çš„å¥–åŠ±ã€‚\n- **æŸå¤±å‡½æ•°**ï¼š\n  $$\n  \\text{Reward\\_loss} = - E_{(x, y_w, y_l) \\sim D} \\left[ \\log \\left( \\frac{\\exp(r(x, y_w))}{\\exp(r(x, y_w)) + \\exp(r(x, y_l))} \\right) \\right]\n  $$\n  å…¶ä¸­ $x$ è¡¨ç¤ºæç¤ºï¼ˆpromptï¼‰ï¼Œ$y_w$ è¡¨ç¤ºé€‰æ‹©çš„å“åº”ï¼ˆchosen responseï¼‰ï¼Œ$y_l$ è¡¨ç¤ºæ‹’ç»çš„å“åº”ï¼ˆrejected responseï¼‰ã€‚\n\n```Python\nclass PairWiseLoss(nn.Module):\n    \"\"\"\n    Pairwise Loss for Reward Model\n    \"\"\"\n    def forward(self, chosen_reward, reject_reward, margin):\n        if margin is not None:\n            loss = -F.logsigmoid(chosen_reward - reject_reward - margin)\n        else:\n            loss = -F.logsigmoid(chosen_reward - reject_reward)\n        return loss.mean()\n\n```\n\n\n## ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”\nä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„RLHFï¼ˆReinforcement Learning with Human Feedbackï¼‰å¯¹ä¸€æ¡è½¨è¿¹ä¸­çš„æ‰€æœ‰çŠ¶æ€åŠ¨ä½œå¯¹è¿›è¡Œå¥–åŠ±åŠ å’Œï¼Œè€Œå¤§æ¨¡å‹å¥–åŠ±æ¨¡å‹ä»…é’ˆå¯¹æ•´ä¸ªå“åº”æä¾›ä¸€ä¸ªå¥–åŠ±å€¼ã€‚\n\n- **ä¼ ç»ŸRLHFæŸå¤±å‡½æ•°**ï¼š\n  $$\n  \\text{Reward\\_loss} = - E_{(\\sigma^+, \\sigma^-, y) \\in D} \\left[ \\log \\left( \\frac{\\exp(\\sum r(s_t^+, a_t^+))}{\\exp(\\sum r(s_t^+ , a_t^+)) + \\exp(\\sum r(s_t^-, a_t^-))} \\right) \\right]\n  $$\n\n![Pasted image 20250416210927.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250416210927.png)\n\n\n## èšåˆæ“ä½œ\nå¯ä»¥å°†ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ ä¸­çš„å¥–åŠ±åŠ å’Œæ›¿æ¢ä¸ºèšåˆæ“ä½œ $\\text{AGG}$ï¼Œå¦‚åŠ å’Œã€åŠ æƒå’Œã€å–æœ€åä¸€ä¸ªå€¼æˆ–ä½¿ç”¨Transformerèšåˆã€‚\n\n\n## æ“ä½œæ­¥éª¤\n1. âœ… åœ¨SFTæ¨¡å‹ä¸Šæ·»åŠ Value Headã€‚\n2. âš ï¸ è®­ç»ƒè¿‡ç¨‹ä¸­å†»ç»“Reward Modelå‚æ•°ã€‚\n3. â— ä½¿ç”¨æœ€åä¸€ä¸ªtokençš„å€¼ä½œä¸ºæ•´ä¸ªå“åº”çš„å¥–åŠ±ã€‚\n\n\n## å¸¸è§é”™è¯¯\n> åœ¨å¥–åŠ±è®¡ç®—æ—¶ï¼Œè¯¯å°†ä¸­é—´tokençš„å€¼ä½œä¸ºæœ€ç»ˆå¥–åŠ±ã€‚\n\n\n## ğŸ’¡å¯å‘ç‚¹\n- å°†promptåˆ°responseè§†ä¸ºå•æ­¥MDPï¼ˆMarkov Decision Processï¼‰ï¼Œè¿™ç®€åŒ–äº†æ¨¡å‹çš„å¤æ‚æ€§ã€‚\n\n\n## è¡ŒåŠ¨æ¸…å•\n- æ¢ç´¢æ›´å¤šèšåˆæ“ä½œåœ¨å¥–åŠ±æ¨¡å‹ä¸­çš„åº”ç”¨ã€‚\n- ç ”ç©¶ä¸åŒreward modelåœ¨PPOä¸­çš„è¡¨ç°å·®å¼‚ã€‚\n\n> åŸå§‹å‡ºå¤„ï¼š[åŸæ–‡é“¾æ¥æˆ–ä¹¦åç« èŠ‚]","excerpt":"","includedFiles":[],"tasklistId":0,"title":"","headers":[{"level":2,"title":"æ ¸å¿ƒè§‚ç‚¹æ€»ç»“","slug":"æ ¸å¿ƒè§‚ç‚¹æ€»ç»“","link":"#æ ¸å¿ƒè§‚ç‚¹æ€»ç»“","children":[]},{"level":2,"title":"å¥–åŠ±æ¨¡å‹è®­ç»ƒ","slug":"å¥–åŠ±æ¨¡å‹è®­ç»ƒ","link":"#å¥–åŠ±æ¨¡å‹è®­ç»ƒ","children":[]},{"level":2,"title":"ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”","slug":"ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”","link":"#ä¸ä¼ ç»Ÿå¼ºåŒ–å­¦ä¹ çš„å¯¹æ¯”","children":[]},{"level":2,"title":"èšåˆæ“ä½œ","slug":"èšåˆæ“ä½œ","link":"#èšåˆæ“ä½œ","children":[]},{"level":2,"title":"æ“ä½œæ­¥éª¤","slug":"æ“ä½œæ­¥éª¤","link":"#æ“ä½œæ­¥éª¤","children":[]},{"level":2,"title":"å¸¸è§é”™è¯¯","slug":"å¸¸è§é”™è¯¯","link":"#å¸¸è§é”™è¯¯","children":[]},{"level":2,"title":"ğŸ’¡å¯å‘ç‚¹","slug":"ğŸ’¡å¯å‘ç‚¹","link":"#ğŸ’¡å¯å‘ç‚¹","children":[]},{"level":2,"title":"è¡ŒåŠ¨æ¸…å•","slug":"è¡ŒåŠ¨æ¸…å•","link":"#è¡ŒåŠ¨æ¸…å•","children":[]}]}}
