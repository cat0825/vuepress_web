{"content":"<p><strong>分类</strong>：自然语言处理<br>\n<strong>标签</strong>：解码策略、大模型生成、Beam Search<br>\n<strong>日期</strong>：2025年4月1日</p>\n<hr>\n<h2 id=\"核心观点总结\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#核心观点总结\"><span>核心观点总结</span></a></h2>\n<p>在自然语言处理领域，大模型生成文本时需要选择解码策略以确保生成的质量和多样性。本文主要探讨了两种主流解码策略——Greedy Search和Beam Search，并通过代码示例展示了Beam Search的具体实现细节。</p>\n<ul>\n<li><strong>Greedy Search</strong>：每次选择概率最大的词，简单但可能导致生成结果单调重复。</li>\n<li><strong>Beam Search</strong>：维护多个候选序列，通过概率平衡质量与多样性，但可能显得保守。</li>\n</ul>\n<hr>\n<h2 id=\"解码策略详解\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#解码策略详解\"><span>解码策略详解</span></a></h2>\n<h3 id=\"greedy-search\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#greedy-search\"><span>Greedy Search</span></a></h3>\n<ul>\n<li><strong>特点</strong>：<br>\n✅ 每次选择概率最高的词<br>\n⚠ 简单高效，但可能生成单调、重复的文本</li>\n</ul>\n<p>💡 <strong>启发点</strong>：适合简单任务，但对复杂生成任务效果欠佳。\n<img src=\"/img/user/附件/Pasted image 20250407180111.png\" alt=\"Pasted image 20250407180111.png\"></p>\n<hr>\n<h3 id=\"beam-search\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#beam-search\"><span>Beam Search</span></a></h3>\n<ul>\n<li>\n<p><strong>核心机制</strong>：\n✅ 维护一个大小为 $$k$$ 的候选序列集合<br>\n✅ 每一步从每个候选序列的概率分布中选择概率最高的 $$k$$ 个词<br>\n✅ 保留总概率最高的 $$k$$ 个候选序列</p>\n</li>\n<li>\n<p><strong>代码实现</strong>：</p>\n</li>\n</ul>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> process</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    batch_size </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 3</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    group_size </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 3</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    next_beam_scores </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">zeros</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">((</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> num_beams</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    next_beam_tokens </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">zeros</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">((</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> num_beams</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    next_beam_indices </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">zeros</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">((</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> num_beams</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    for</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> batch_idx </span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">in</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> range</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        beam_idx </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 0</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        for</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_token_rank</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_token</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_score</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_index</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> in</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> enumerate</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">            zip</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">],</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">],</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">])</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">        ):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            batch_beam_idx </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> batch_idx </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> num_beams </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">+</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_index</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            next_beam_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_score</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            next_beam_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_token</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            next_beam_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> batch_beam_idx</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            beam_idx </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">+=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 1</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_beam_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">view</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_beam_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">view</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_beam_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">view</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># 示例调用</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">randint</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">0</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 100</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=(</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">3</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">))</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_scores </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_search</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> max_length</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">10</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> num_beams</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">3</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">print</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>💡 <strong>启发点</strong>：通过维护多个候选序列，Beam Search能有效提升生成质量，但代价是计算复杂度更高。\n<img src=\"/img/user/附件/Pasted image 20250407180124.png\" alt=\"Pasted image 20250407180124.png\"></p>\n<hr>\n<h2 id=\"常见错误警告\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#常见错误警告\"><span>常见错误警告</span></a></h2>\n<p>⚠ <strong>注意事项</strong>：</p>\n<ol>\n<li>Beam大小（$$k$$）过小可能导致生成结果质量下降；过大则增加计算成本。</li>\n<li>Beam Search可能过于保守，导致缺乏创造性生成。</li>\n</ol>\n<hr>\n<h2 id=\"数据与公式\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#数据与公式\"><span>数据与公式</span></a></h2>\n<h3 id=\"数据表格示例\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#数据表格示例\"><span>数据表格示例</span></a></h3>\n<table>\n<thead>\n<tr>\n<th>解码策略</th>\n<th>优势</th>\n<th>劣势</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Greedy Search</td>\n<td>简单高效</td>\n<td>单调、重复</td>\n</tr>\n<tr>\n<td>Beam Search</td>\n<td>平衡质量与多样性</td>\n<td>保守、不自然</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"公式示例\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#公式示例\"><span>公式示例</span></a></h3>\n<p>Beam Search核心公式：</p>\n<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Next_Token_Scores</mtext><mo>=</mo><msub><mtext>Top</mtext><mi>k</mi></msub><mo stretchy=\"false\">(</mo><mtext>Probability Distribution</mtext><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{Next\\_Token\\_Scores} = \\text{Top}_k(\\text{Probability Distribution})\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0044em;vertical-align:-0.31em;\"></span><span class=\"mord text\"><span class=\"mord\">Next_Token_Scores</span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Top</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.242em;\"><span style=\"top:-2.4559em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2441em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord text\"><span class=\"mord\">Probability Distribution</span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n<hr>\n<h2 id=\"思考-延伸问题\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#思考-延伸问题\"><span>[思考] 延伸问题</span></a></h2>\n<ol>\n<li>如何结合两种解码策略，设计出既高效又多样化的生成算法？</li>\n<li>在实际应用中，是否可以动态调整Beam大小以适配不同任务？</li>\n<li>是否有更先进的解码策略能解决Beam Search的保守问题？</li>\n</ol>\n<hr>\n<blockquote>\n<p><strong>来源</strong>：整理自自然语言处理相关技术文档与代码示例。</p>\n</blockquote>\n<hr>\n<h2 id=\"行动清单\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#行动清单\"><span>行动清单</span></a></h2>\n<ol>\n<li>实现Greedy Search和Beam Search的代码并测试不同参数对生成效果的影响。</li>\n<li>阅读相关论文，探索改进Beam Search的技术方案，例如Top-p或Top-k采样。</li>\n<li>应用上述解码策略于实际项目，评估其性能和生成质量。</li>\n</ol>\n<hr>\n<p>📈 <strong>趋势预测</strong><br>\n未来解码策略将更注重结合概率分布与上下文语义，利用动态调整机制提升生成效果，同时减少计算开销。</p>\n<hr>\n<h2 id=\"后续追踪\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#后续追踪\"><span>后续追踪</span></a></h2>\n<ul>\n<li>研究Top-p采样和温度调节对生成质量的影响。</li>\n<li>探索基于强化学习优化解码策略的新方法。</li>\n</ul>\n","env":{"base":"/","filePath":"/Users/qianyuhe/Desktop/my-project/docs/notes_bak/大语言模型学习/Structure & Decoding Policy 结构和解码策略/解码采样策略：Greedy Search与Beam Search的实现与优化.md","filePathRelative":"notes_bak/大语言模型学习/Structure & Decoding Policy 结构和解码策略/解码采样策略：Greedy Search与Beam Search的实现与优化.md","frontmatter":{"dg-publish":true,"dg-permalink":"/大语言模型学习/Structure-&-Decoding-Policy-结构和解码策略/解码采样策略：Greedy-Search与Beam-Search的实现与优化","dg-home":false,"dg-description":"在此输入笔记的描述","dg-hide":false,"dg-hide-title":false,"dg-show-backlinks":true,"dg-show-local-graph":true,"dg-show-inline-title":true,"dg-pinned":false,"dg-passphrase":"在此输入访问密码","dg-enable-mathjax":false,"dg-enable-mermaid":false,"dg-enable-uml":false,"dg-note-icon":0,"dg-enable-dataview":false,"tags":["NLP"],"permalink":"/大语言模型学习/Structure-&-Decoding-Policy-结构和解码策略/解码采样策略：Greedy-Search与Beam-Search的实现与优化/","dgShowBacklinks":true,"dgShowLocalGraph":true,"dgShowInlineTitle":true,"dgPassFrontmatter":true,"noteIcon":0,"created":"2025-04-07T10:00:51.000Z","updated":"2025-04-13T05:06:02.000Z","title":"解码采样策略：Greedy Search与Beam Search的实现与优化","createTime":"2025/05/13 17:33:52"},"sfcBlocks":{"template":{"type":"template","content":"<template><p><strong>分类</strong>：自然语言处理<br>\n<strong>标签</strong>：解码策略、大模型生成、Beam Search<br>\n<strong>日期</strong>：2025年4月1日</p>\n<hr>\n<h2 id=\"核心观点总结\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#核心观点总结\"><span>核心观点总结</span></a></h2>\n<p>在自然语言处理领域，大模型生成文本时需要选择解码策略以确保生成的质量和多样性。本文主要探讨了两种主流解码策略——Greedy Search和Beam Search，并通过代码示例展示了Beam Search的具体实现细节。</p>\n<ul>\n<li><strong>Greedy Search</strong>：每次选择概率最大的词，简单但可能导致生成结果单调重复。</li>\n<li><strong>Beam Search</strong>：维护多个候选序列，通过概率平衡质量与多样性，但可能显得保守。</li>\n</ul>\n<hr>\n<h2 id=\"解码策略详解\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#解码策略详解\"><span>解码策略详解</span></a></h2>\n<h3 id=\"greedy-search\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#greedy-search\"><span>Greedy Search</span></a></h3>\n<ul>\n<li><strong>特点</strong>：<br>\n✅ 每次选择概率最高的词<br>\n⚠ 简单高效，但可能生成单调、重复的文本</li>\n</ul>\n<p>💡 <strong>启发点</strong>：适合简单任务，但对复杂生成任务效果欠佳。\n<img src=\"/img/user/附件/Pasted image 20250407180111.png\" alt=\"Pasted image 20250407180111.png\"></p>\n<hr>\n<h3 id=\"beam-search\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#beam-search\"><span>Beam Search</span></a></h3>\n<ul>\n<li>\n<p><strong>核心机制</strong>：\n✅ 维护一个大小为 $$k$$ 的候选序列集合<br>\n✅ 每一步从每个候选序列的概率分布中选择概率最高的 $$k$$ 个词<br>\n✅ 保留总概率最高的 $$k$$ 个候选序列</p>\n</li>\n<li>\n<p><strong>代码实现</strong>：</p>\n</li>\n</ul>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> process</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    batch_size </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 3</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    group_size </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 3</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    next_beam_scores </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">zeros</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">((</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> num_beams</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    next_beam_tokens </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">zeros</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">((</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> num_beams</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    next_beam_indices </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">zeros</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">((</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> num_beams</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    for</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> batch_idx </span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">in</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> range</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        beam_idx </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 0</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        for</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_token_rank</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_token</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_score</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_index</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> in</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> enumerate</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">            zip</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">],</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">],</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">])</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">        ):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            batch_beam_idx </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> batch_idx </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> num_beams </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">+</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_index</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            next_beam_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_score</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            next_beam_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_token</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            next_beam_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> batch_beam_idx</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            beam_idx </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">+=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 1</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_beam_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">view</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_beam_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">view</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_beam_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">view</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># 示例调用</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">randint</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">0</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 100</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=(</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">3</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">))</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_scores </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_search</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> max_length</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">10</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> num_beams</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">3</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">print</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>💡 <strong>启发点</strong>：通过维护多个候选序列，Beam Search能有效提升生成质量，但代价是计算复杂度更高。\n<img src=\"/img/user/附件/Pasted image 20250407180124.png\" alt=\"Pasted image 20250407180124.png\"></p>\n<hr>\n<h2 id=\"常见错误警告\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#常见错误警告\"><span>常见错误警告</span></a></h2>\n<p>⚠ <strong>注意事项</strong>：</p>\n<ol>\n<li>Beam大小（$$k$$）过小可能导致生成结果质量下降；过大则增加计算成本。</li>\n<li>Beam Search可能过于保守，导致缺乏创造性生成。</li>\n</ol>\n<hr>\n<h2 id=\"数据与公式\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#数据与公式\"><span>数据与公式</span></a></h2>\n<h3 id=\"数据表格示例\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#数据表格示例\"><span>数据表格示例</span></a></h3>\n<table>\n<thead>\n<tr>\n<th>解码策略</th>\n<th>优势</th>\n<th>劣势</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Greedy Search</td>\n<td>简单高效</td>\n<td>单调、重复</td>\n</tr>\n<tr>\n<td>Beam Search</td>\n<td>平衡质量与多样性</td>\n<td>保守、不自然</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"公式示例\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#公式示例\"><span>公式示例</span></a></h3>\n<p>Beam Search核心公式：</p>\n<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Next_Token_Scores</mtext><mo>=</mo><msub><mtext>Top</mtext><mi>k</mi></msub><mo stretchy=\"false\">(</mo><mtext>Probability Distribution</mtext><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{Next\\_Token\\_Scores} = \\text{Top}_k(\\text{Probability Distribution})\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0044em;vertical-align:-0.31em;\"></span><span class=\"mord text\"><span class=\"mord\">Next_Token_Scores</span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Top</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.242em;\"><span style=\"top:-2.4559em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2441em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord text\"><span class=\"mord\">Probability Distribution</span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n<hr>\n<h2 id=\"思考-延伸问题\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#思考-延伸问题\"><span>[思考] 延伸问题</span></a></h2>\n<ol>\n<li>如何结合两种解码策略，设计出既高效又多样化的生成算法？</li>\n<li>在实际应用中，是否可以动态调整Beam大小以适配不同任务？</li>\n<li>是否有更先进的解码策略能解决Beam Search的保守问题？</li>\n</ol>\n<hr>\n<blockquote>\n<p><strong>来源</strong>：整理自自然语言处理相关技术文档与代码示例。</p>\n</blockquote>\n<hr>\n<h2 id=\"行动清单\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#行动清单\"><span>行动清单</span></a></h2>\n<ol>\n<li>实现Greedy Search和Beam Search的代码并测试不同参数对生成效果的影响。</li>\n<li>阅读相关论文，探索改进Beam Search的技术方案，例如Top-p或Top-k采样。</li>\n<li>应用上述解码策略于实际项目，评估其性能和生成质量。</li>\n</ol>\n<hr>\n<p>📈 <strong>趋势预测</strong><br>\n未来解码策略将更注重结合概率分布与上下文语义，利用动态调整机制提升生成效果，同时减少计算开销。</p>\n<hr>\n<h2 id=\"后续追踪\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#后续追踪\"><span>后续追踪</span></a></h2>\n<ul>\n<li>研究Top-p采样和温度调节对生成质量的影响。</li>\n<li>探索基于强化学习优化解码策略的新方法。</li>\n</ul>\n</template>","contentStripped":"<p><strong>分类</strong>：自然语言处理<br>\n<strong>标签</strong>：解码策略、大模型生成、Beam Search<br>\n<strong>日期</strong>：2025年4月1日</p>\n<hr>\n<h2 id=\"核心观点总结\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#核心观点总结\"><span>核心观点总结</span></a></h2>\n<p>在自然语言处理领域，大模型生成文本时需要选择解码策略以确保生成的质量和多样性。本文主要探讨了两种主流解码策略——Greedy Search和Beam Search，并通过代码示例展示了Beam Search的具体实现细节。</p>\n<ul>\n<li><strong>Greedy Search</strong>：每次选择概率最大的词，简单但可能导致生成结果单调重复。</li>\n<li><strong>Beam Search</strong>：维护多个候选序列，通过概率平衡质量与多样性，但可能显得保守。</li>\n</ul>\n<hr>\n<h2 id=\"解码策略详解\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#解码策略详解\"><span>解码策略详解</span></a></h2>\n<h3 id=\"greedy-search\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#greedy-search\"><span>Greedy Search</span></a></h3>\n<ul>\n<li><strong>特点</strong>：<br>\n✅ 每次选择概率最高的词<br>\n⚠ 简单高效，但可能生成单调、重复的文本</li>\n</ul>\n<p>💡 <strong>启发点</strong>：适合简单任务，但对复杂生成任务效果欠佳。\n<img src=\"/img/user/附件/Pasted image 20250407180111.png\" alt=\"Pasted image 20250407180111.png\"></p>\n<hr>\n<h3 id=\"beam-search\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#beam-search\"><span>Beam Search</span></a></h3>\n<ul>\n<li>\n<p><strong>核心机制</strong>：\n✅ 维护一个大小为 $$k$$ 的候选序列集合<br>\n✅ 每一步从每个候选序列的概率分布中选择概率最高的 $$k$$ 个词<br>\n✅ 保留总概率最高的 $$k$$ 个候选序列</p>\n</li>\n<li>\n<p><strong>代码实现</strong>：</p>\n</li>\n</ul>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> process</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    batch_size </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 3</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    group_size </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 3</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    next_beam_scores </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">zeros</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">((</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> num_beams</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    next_beam_tokens </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">zeros</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">((</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> num_beams</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">    next_beam_indices </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">zeros</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">((</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> num_beams</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">dtype</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    for</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> batch_idx </span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">in</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> range</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        beam_idx </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 0</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        for</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_token_rank</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_token</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_score</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_index</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> in</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> enumerate</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">            zip</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">next_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">],</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">],</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">])</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">        ):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            batch_beam_idx </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> batch_idx </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> num_beams </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">+</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_index</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            next_beam_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_score</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            next_beam_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_token</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            next_beam_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_idx</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> batch_beam_idx</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            beam_idx </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">+=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 1</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">    return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_beam_scores</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">view</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_beam_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">view</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> next_beam_indices</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">view</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># 示例调用</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">randint</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">0</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 100</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=(</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">3</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">))</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_scores </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beam_search</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> max_length</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">10</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> num_beams</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">3</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">print</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">input_ids</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>💡 <strong>启发点</strong>：通过维护多个候选序列，Beam Search能有效提升生成质量，但代价是计算复杂度更高。\n<img src=\"/img/user/附件/Pasted image 20250407180124.png\" alt=\"Pasted image 20250407180124.png\"></p>\n<hr>\n<h2 id=\"常见错误警告\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#常见错误警告\"><span>常见错误警告</span></a></h2>\n<p>⚠ <strong>注意事项</strong>：</p>\n<ol>\n<li>Beam大小（$$k$$）过小可能导致生成结果质量下降；过大则增加计算成本。</li>\n<li>Beam Search可能过于保守，导致缺乏创造性生成。</li>\n</ol>\n<hr>\n<h2 id=\"数据与公式\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#数据与公式\"><span>数据与公式</span></a></h2>\n<h3 id=\"数据表格示例\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#数据表格示例\"><span>数据表格示例</span></a></h3>\n<table>\n<thead>\n<tr>\n<th>解码策略</th>\n<th>优势</th>\n<th>劣势</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Greedy Search</td>\n<td>简单高效</td>\n<td>单调、重复</td>\n</tr>\n<tr>\n<td>Beam Search</td>\n<td>平衡质量与多样性</td>\n<td>保守、不自然</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"公式示例\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#公式示例\"><span>公式示例</span></a></h3>\n<p>Beam Search核心公式：</p>\n<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Next_Token_Scores</mtext><mo>=</mo><msub><mtext>Top</mtext><mi>k</mi></msub><mo stretchy=\"false\">(</mo><mtext>Probability Distribution</mtext><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{Next\\_Token\\_Scores} = \\text{Top}_k(\\text{Probability Distribution})\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0044em;vertical-align:-0.31em;\"></span><span class=\"mord text\"><span class=\"mord\">Next_Token_Scores</span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Top</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.242em;\"><span style=\"top:-2.4559em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2441em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord text\"><span class=\"mord\">Probability Distribution</span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n<hr>\n<h2 id=\"思考-延伸问题\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#思考-延伸问题\"><span>[思考] 延伸问题</span></a></h2>\n<ol>\n<li>如何结合两种解码策略，设计出既高效又多样化的生成算法？</li>\n<li>在实际应用中，是否可以动态调整Beam大小以适配不同任务？</li>\n<li>是否有更先进的解码策略能解决Beam Search的保守问题？</li>\n</ol>\n<hr>\n<blockquote>\n<p><strong>来源</strong>：整理自自然语言处理相关技术文档与代码示例。</p>\n</blockquote>\n<hr>\n<h2 id=\"行动清单\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#行动清单\"><span>行动清单</span></a></h2>\n<ol>\n<li>实现Greedy Search和Beam Search的代码并测试不同参数对生成效果的影响。</li>\n<li>阅读相关论文，探索改进Beam Search的技术方案，例如Top-p或Top-k采样。</li>\n<li>应用上述解码策略于实际项目，评估其性能和生成质量。</li>\n</ol>\n<hr>\n<p>📈 <strong>趋势预测</strong><br>\n未来解码策略将更注重结合概率分布与上下文语义，利用动态调整机制提升生成效果，同时减少计算开销。</p>\n<hr>\n<h2 id=\"后续追踪\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#后续追踪\"><span>后续追踪</span></a></h2>\n<ul>\n<li>研究Top-p采样和温度调节对生成质量的影响。</li>\n<li>探索基于强化学习优化解码策略的新方法。</li>\n</ul>\n","tagOpen":"<template>","tagClose":"</template>"},"script":null,"scriptSetup":null,"scripts":[],"styles":[],"customBlocks":[]},"content":"**分类**：自然语言处理  \n**标签**：解码策略、大模型生成、Beam Search  \n**日期**：2025年4月1日  \n\n---\n\n\n\n## 核心观点总结\n在自然语言处理领域，大模型生成文本时需要选择解码策略以确保生成的质量和多样性。本文主要探讨了两种主流解码策略——Greedy Search和Beam Search，并通过代码示例展示了Beam Search的具体实现细节。\n\n- **Greedy Search**：每次选择概率最大的词，简单但可能导致生成结果单调重复。  \n- **Beam Search**：维护多个候选序列，通过概率平衡质量与多样性，但可能显得保守。\n\n---\n\n\n\n## 解码策略详解\n\n### Greedy Search\n- **特点**：  \n  ✅ 每次选择概率最高的词  \n  ⚠ 简单高效，但可能生成单调、重复的文本  \n\n💡 **启发点**：适合简单任务，但对复杂生成任务效果欠佳。\n![Pasted image 20250407180111.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250407180111.png)\n\n---\n\n\n### Beam Search\n- **核心机制**：\n  ✅ 维护一个大小为 $$k$$ 的候选序列集合  \n  ✅ 每一步从每个候选序列的概率分布中选择概率最高的 $$k$$ 个词  \n  ✅ 保留总概率最高的 $$k$$ 个候选序列\n\n- **代码实现**：\n\n```python\ndef process(input_ids, next_scores, next_tokens, next_indices):\n    batch_size = 3\n    group_size = 3\n    next_beam_scores = torch.zeros((batch_size, num_beams), dtype=next_scores.dtype)\n    next_beam_tokens = torch.zeros((batch_size, num_beams), dtype=next_tokens.dtype)\n    next_beam_indices = torch.zeros((batch_size, num_beams), dtype=next_indices.dtype)\n\n    for batch_idx in range(batch_size):\n        beam_idx = 0\n        for beam_token_rank, (next_token, next_score, next_index) in enumerate(\n            zip(next_tokens[batch_idx], next_scores[batch_idx], next_indices[batch_idx])\n        ):\n            batch_beam_idx = batch_idx * num_beams + next_index\n\n            next_beam_scores[batch_idx, beam_idx] = next_score\n            next_beam_tokens[batch_idx, beam_idx] = next_token\n            next_beam_indices[batch_idx, beam_idx] = batch_beam_idx\n\n            beam_idx += 1\n\n    return next_beam_scores.view(-1), next_beam_tokens.view(-1), next_beam_indices.view(-1)\n\n# 示例调用\ninput_ids = torch.randint(0, 100, size=(3, 1))\ninput_ids, beam_scores = beam_search(input_ids, max_length=10, num_beams=3)\nprint(input_ids)\n```\n\n💡 **启发点**：通过维护多个候选序列，Beam Search能有效提升生成质量，但代价是计算复杂度更高。\n![Pasted image 20250407180124.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250407180124.png)\n\n---\n\n\n\n## 常见错误警告\n⚠ **注意事项**：\n1. Beam大小（$$k$$）过小可能导致生成结果质量下降；过大则增加计算成本。\n2. Beam Search可能过于保守，导致缺乏创造性生成。\n\n---\n\n\n\n## 数据与公式\n\n### 数据表格示例\n| 解码策略   | 优势                      | 劣势               |\n|------------|---------------------------|--------------------|\n| Greedy Search | 简单高效                 | 单调、重复         |\n| Beam Search   | 平衡质量与多样性         | 保守、不自然       |\n\n\n### 公式示例\nBeam Search核心公式：\n$$\n\\text{Next\\_Token\\_Scores} = \\text{Top}_k(\\text{Probability Distribution})\n$$\n\n---\n\n\n\n## [思考] 延伸问题\n1. 如何结合两种解码策略，设计出既高效又多样化的生成算法？  \n2. 在实际应用中，是否可以动态调整Beam大小以适配不同任务？  \n3. 是否有更先进的解码策略能解决Beam Search的保守问题？\n\n---\n\n> **来源**：整理自自然语言处理相关技术文档与代码示例。\n\n---\n\n\n\n## 行动清单\n1. 实现Greedy Search和Beam Search的代码并测试不同参数对生成效果的影响。  \n2. 阅读相关论文，探索改进Beam Search的技术方案，例如Top-p或Top-k采样。  \n3. 应用上述解码策略于实际项目，评估其性能和生成质量。\n\n---\n\n📈 **趋势预测**  \n未来解码策略将更注重结合概率分布与上下文语义，利用动态调整机制提升生成效果，同时减少计算开销。\n\n---\n\n\n\n## 后续追踪\n- 研究Top-p采样和温度调节对生成质量的影响。  \n- 探索基于强化学习优化解码策略的新方法。","excerpt":"","includedFiles":[],"tasklistId":0,"title":"","headers":[{"level":2,"title":"核心观点总结","slug":"核心观点总结","link":"#核心观点总结","children":[]},{"level":2,"title":"解码策略详解","slug":"解码策略详解","link":"#解码策略详解","children":[{"level":3,"title":"Greedy Search","slug":"greedy-search","link":"#greedy-search","children":[]},{"level":3,"title":"Beam Search","slug":"beam-search","link":"#beam-search","children":[]}]},{"level":2,"title":"常见错误警告","slug":"常见错误警告","link":"#常见错误警告","children":[]},{"level":2,"title":"数据与公式","slug":"数据与公式","link":"#数据与公式","children":[{"level":3,"title":"数据表格示例","slug":"数据表格示例","link":"#数据表格示例","children":[]},{"level":3,"title":"公式示例","slug":"公式示例","link":"#公式示例","children":[]}]},{"level":2,"title":"[思考] 延伸问题","slug":"思考-延伸问题","link":"#思考-延伸问题","children":[]},{"level":2,"title":"行动清单","slug":"行动清单","link":"#行动清单","children":[]},{"level":2,"title":"后续追踪","slug":"后续追踪","link":"#后续追踪","children":[]}]}}
