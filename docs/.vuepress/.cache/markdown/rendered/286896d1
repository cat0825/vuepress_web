{"content":"<h2 id=\"å…ƒæ•°æ®\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å…ƒæ•°æ®\"><span>å…ƒæ•°æ®</span></a></h2>\n<ul>\n<li>åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ ä¼˜åŒ–</li>\n<li>æ ‡ç­¾ï¼šLoRA, é€‚é…å™¨, å­¦ä¹ ç‡, ä¼˜åŒ–å™¨, è®­ç»ƒ</li>\n<li>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</li>\n</ul>\n<h2 id=\"å†…å®¹æ‘˜è¦\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å†…å®¹æ‘˜è¦\"><span>å†…å®¹æ‘˜è¦</span></a></h2>\n<p>LoRA+æ˜¯ä¸€ç§é’ˆå¯¹LoRAé€‚é…å™¨çš„ä¼˜åŒ–æ–¹æ³•ï¼Œé€šè¿‡ä¸ºçŸ©é˜µAå’ŒBè®¾ç½®ä¸åŒçš„å­¦ä¹ ç‡æ¥æé«˜è®­ç»ƒæ•ˆç‡ã€‚æ ¸å¿ƒè§‚ç‚¹æ˜¯ä½¿ç”¨ä¸åŒçš„å­¦ä¹ ç‡ç­–ç•¥ï¼Œå…¶ä¸­Bçš„å­¦ä¹ ç‡æ˜¯Açš„6å€ã€‚è¿™ç§æ–¹æ³•ä¸ä»…æå‡äº†æ¨¡å‹çš„é€‚åº”æ€§ï¼Œè¿˜ç®€åŒ–äº†ä¼˜åŒ–è¿‡ç¨‹ã€‚</p>\n<h2 id=\"æ ¸å¿ƒå†…å®¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒå†…å®¹\"><span>æ ¸å¿ƒå†…å®¹</span></a></h2>\n<p><img src=\"/img/user/é™„ä»¶/Pasted image 20250424111627.png\" alt=\"Pasted image 20250424111627.png\"></p>\n<h3 id=\"lora-ä¼˜åŒ–å™¨åˆ›å»º\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#lora-ä¼˜åŒ–å™¨åˆ›å»º\"><span>LoRA+ä¼˜åŒ–å™¨åˆ›å»º</span></a></h3>\n<p>LoRA+ä¼˜åŒ–å™¨é€šè¿‡è®¾ç½®ä¸åŒçš„å­¦ä¹ ç‡æ¥å®ç°æ›´é«˜æ•ˆçš„è®­ç»ƒã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<p>âœ… <strong>å‚æ•°åˆ†ç»„</strong>ï¼š</p>\n<ul>\n<li>å°†æ¨¡å‹å‚æ•°åˆ†ä¸ºä¸åŒç»„ï¼Œåˆ†åˆ«è®¾ç½®å­¦ä¹ ç‡å’Œæƒé‡è¡°å‡ã€‚</li>\n<li>çŸ©é˜µAçš„å­¦ä¹ ç‡ä¸º<code v-pre>lr</code>ï¼ŒçŸ©é˜µBçš„å­¦ä¹ ç‡ä¸º<code v-pre>lr * lora_lr_ratio</code>ã€‚</li>\n</ul>\n<p>âš ï¸ <strong>æ³¨æ„äº‹é¡¹</strong>ï¼š</p>\n<ul>\n<li>ç¡®ä¿æƒé‡è¡°å‡è®¾ç½®æ­£ç¡®ï¼Œé¿å…è®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç°è¿‡æ‹Ÿåˆã€‚</li>\n</ul>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer_grouped_parameters </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> [</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">params</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> list</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">A</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">].</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">weight_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> weight_decay</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">lr</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lr</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    },</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">params</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> list</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">embedding</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">].</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">weight_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> weight_decay</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">lr</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    },</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">params</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> list</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">B</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">].</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">weight_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> weight_decay</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">lr</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lr </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_ratio</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    },</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">params</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> list</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">B_no_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">].</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">weight_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 0.0</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">lr</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lr </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_ratio</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    },</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> optimizer_cls</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer_grouped_parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> **</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer_kwargs</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3 id=\"è°ƒæ•´trainerç±»æ–¹æ³•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è°ƒæ•´trainerç±»æ–¹æ³•\"><span>è°ƒæ•´Trainerç±»æ–¹æ³•</span></a></h3>\n<p>é‡å†™Trainerç±»çš„<code v-pre>create_optimizer</code>æ–¹æ³•ä»¥æ”¯æŒLoRA+ä¼˜åŒ–å™¨ï¼š</p>\n<p>â— <strong>å®ç°æ­¥éª¤</strong>ï¼š</p>\n<ol>\n<li>æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†Sagemakerå¤šå¤„ç†ã€‚</li>\n<li>ä½¿ç”¨<code v-pre>create_lorap_optimizer</code>æ–¹æ³•åˆ›å»ºä¼˜åŒ–å™¨ã€‚</li>\n</ol>\n<p>ğŸ’¡ <strong>å¯å‘ç‚¹</strong>ï¼š\nè¿™ç§æ–¹æ³•é€šè¿‡è°ƒæ•´å­¦ä¹ ç‡æé«˜äº†è®­ç»ƒæ•ˆç‡ï¼Œå€¼å¾—åœ¨å…¶ä»–é€‚é…å™¨ä¸­å°è¯•ã€‚</p>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"--shiki-light:#2E8F82;--shiki-dark:#5DA994\"> LoraPlusTrainer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">Trainer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">    def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> create_optimizer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        opt_model </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">model_wrapped </span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> is_sagemaker_mp_enabled</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> else</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">model</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">is</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> None</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            optimizer_cls</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> optimizer_kwargs </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> Trainer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">get_optimizer_cls_and_kwargs</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">args</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            lora_lr_ratio </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> LORA_LR_RATIO</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            lora_lr_embedding </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> LORA_LR_EMBEDDING</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">            self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> create_lorap_optimizer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">opt_model</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_ratio</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> optimizer_cls</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> optimizer_kwargs</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">            if</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> is_sagemaker_mp_enabled</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">():</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">                self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> smp</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">DistributedOptimizer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        return</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3 id=\"å…¬å¼è°ƒæ•´\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å…¬å¼è°ƒæ•´\"><span>å…¬å¼è°ƒæ•´</span></a></h3>\n<p>å…¬å¼æ›´æ–°è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>\n<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>A</mi><mo>â†</mo><mi>A</mi><mo>âˆ’</mo><mi>Î·</mi><mo>Ã—</mo><msub><mi>G</mi><mi>A</mi></msub></mrow><annotation encoding=\"application/x-tex\">A \\leftarrow A - \\eta \\times G_A\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">â†</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">âˆ’</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">Î·</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">Ã—</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">G</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">A</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>B</mi><mo>â†</mo><mi>B</mi><mo>âˆ’</mo><mi>Î»</mi><mi>Î·</mi><mo>Ã—</mo><msub><mi>G</mi><mi>B</mi></msub><mo separator=\"true\">,</mo><mspace width=\"1em\"/><mi>Î»</mi><mo>â‰«</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">B \\leftarrow B - \\lambda \\eta \\times G_B, \\quad \\lambda \\gg 1\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">â†</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">âˆ’</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">Î»</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">Î·</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">Ã—</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">G</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">Î»</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">â‰«</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span></span></p>\n<h2 id=\"å¸¸è§é”™è¯¯\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¸¸è§é”™è¯¯\"><span>å¸¸è§é”™è¯¯</span></a></h2>\n<blockquote>\n<p>åœ¨è°ƒæ•´å­¦ä¹ ç‡æ—¶ï¼Œç¡®ä¿æ¯”ä¾‹å…³ç³»æ­£ç¡®ï¼Œé¿å…å› è®¾ç½®é”™è¯¯å¯¼è‡´æ¨¡å‹ä¸æ”¶æ•›ã€‚</p>\n</blockquote>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ul class=\"task-list-container\">\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-0\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-0\"> å®ç°å¹¶æµ‹è¯•LoRA+ä¼˜åŒ–å™¨åœ¨ä¸åŒæ¨¡å‹ä¸­çš„æ•ˆæœã€‚</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-1\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-1\"> è®°å½•è®­ç»ƒè¿‡ç¨‹ä¸­çš„å‚æ•°å˜åŒ–ä»¥éªŒè¯ä¼˜åŒ–æ•ˆæœã€‚</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-2\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-2\"> æ¢ç´¢å…¶ä»–é€‚é…å™¨ä¸­åº”ç”¨ç±»ä¼¼ç­–ç•¥çš„å¯è¡Œæ€§ã€‚</label></li>\n</ul>\n<blockquote>\n<p>åŸå§‹å‡ºå¤„ï¼šsimple-lora-plus/tricks/lora_plus.py</p>\n</blockquote>\n","env":{"base":"/","filePath":"/Users/qianyuhe/Desktop/my-project/docs/notes_bak/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/LoRAåŠå…¶å˜ä½“/LoRA+.md","filePathRelative":"notes_bak/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/LoRAåŠå…¶å˜ä½“/LoRA+.md","frontmatter":{"dg-publish":true,"dg-permalink":"/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/LoRAåŠå…¶å˜ä½“/LoRA+","dg-home":false,"dg-description":"åœ¨æ­¤è¾“å…¥ç¬”è®°çš„æè¿°","dg-hide":false,"dg-hide-title":false,"dg-show-backlinks":true,"dg-show-local-graph":true,"dg-show-inline-title":true,"dg-pinned":false,"dg-passphrase":"åœ¨æ­¤è¾“å…¥è®¿é—®å¯†ç ","dg-enable-mathjax":false,"dg-enable-mermaid":false,"dg-enable-uml":false,"dg-note-icon":0,"dg-enable-dataview":false,"tags":["NLP"],"permalink":"/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/LoRAåŠå…¶å˜ä½“/LoRA+/","dgShowBacklinks":true,"dgShowLocalGraph":true,"dgShowInlineTitle":true,"dgPassFrontmatter":true,"noteIcon":0,"created":"2025-04-24T03:15:41.000Z","updated":"2025-04-24T03:17:34.000Z","title":"LoRA+","createTime":"2025/05/13 17:33:52"},"sfcBlocks":{"template":{"type":"template","content":"<template><h2 id=\"å…ƒæ•°æ®\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å…ƒæ•°æ®\"><span>å…ƒæ•°æ®</span></a></h2>\n<ul>\n<li>åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ ä¼˜åŒ–</li>\n<li>æ ‡ç­¾ï¼šLoRA, é€‚é…å™¨, å­¦ä¹ ç‡, ä¼˜åŒ–å™¨, è®­ç»ƒ</li>\n<li>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</li>\n</ul>\n<h2 id=\"å†…å®¹æ‘˜è¦\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å†…å®¹æ‘˜è¦\"><span>å†…å®¹æ‘˜è¦</span></a></h2>\n<p>LoRA+æ˜¯ä¸€ç§é’ˆå¯¹LoRAé€‚é…å™¨çš„ä¼˜åŒ–æ–¹æ³•ï¼Œé€šè¿‡ä¸ºçŸ©é˜µAå’ŒBè®¾ç½®ä¸åŒçš„å­¦ä¹ ç‡æ¥æé«˜è®­ç»ƒæ•ˆç‡ã€‚æ ¸å¿ƒè§‚ç‚¹æ˜¯ä½¿ç”¨ä¸åŒçš„å­¦ä¹ ç‡ç­–ç•¥ï¼Œå…¶ä¸­Bçš„å­¦ä¹ ç‡æ˜¯Açš„6å€ã€‚è¿™ç§æ–¹æ³•ä¸ä»…æå‡äº†æ¨¡å‹çš„é€‚åº”æ€§ï¼Œè¿˜ç®€åŒ–äº†ä¼˜åŒ–è¿‡ç¨‹ã€‚</p>\n<h2 id=\"æ ¸å¿ƒå†…å®¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒå†…å®¹\"><span>æ ¸å¿ƒå†…å®¹</span></a></h2>\n<p><img src=\"/img/user/é™„ä»¶/Pasted image 20250424111627.png\" alt=\"Pasted image 20250424111627.png\"></p>\n<h3 id=\"lora-ä¼˜åŒ–å™¨åˆ›å»º\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#lora-ä¼˜åŒ–å™¨åˆ›å»º\"><span>LoRA+ä¼˜åŒ–å™¨åˆ›å»º</span></a></h3>\n<p>LoRA+ä¼˜åŒ–å™¨é€šè¿‡è®¾ç½®ä¸åŒçš„å­¦ä¹ ç‡æ¥å®ç°æ›´é«˜æ•ˆçš„è®­ç»ƒã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<p>âœ… <strong>å‚æ•°åˆ†ç»„</strong>ï¼š</p>\n<ul>\n<li>å°†æ¨¡å‹å‚æ•°åˆ†ä¸ºä¸åŒç»„ï¼Œåˆ†åˆ«è®¾ç½®å­¦ä¹ ç‡å’Œæƒé‡è¡°å‡ã€‚</li>\n<li>çŸ©é˜µAçš„å­¦ä¹ ç‡ä¸º<code v-pre>lr</code>ï¼ŒçŸ©é˜µBçš„å­¦ä¹ ç‡ä¸º<code v-pre>lr * lora_lr_ratio</code>ã€‚</li>\n</ul>\n<p>âš ï¸ <strong>æ³¨æ„äº‹é¡¹</strong>ï¼š</p>\n<ul>\n<li>ç¡®ä¿æƒé‡è¡°å‡è®¾ç½®æ­£ç¡®ï¼Œé¿å…è®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç°è¿‡æ‹Ÿåˆã€‚</li>\n</ul>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer_grouped_parameters </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> [</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">params</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> list</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">A</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">].</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">weight_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> weight_decay</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">lr</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lr</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    },</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">params</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> list</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">embedding</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">].</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">weight_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> weight_decay</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">lr</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    },</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">params</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> list</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">B</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">].</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">weight_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> weight_decay</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">lr</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lr </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_ratio</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    },</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">params</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> list</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">B_no_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">].</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">weight_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 0.0</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">lr</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lr </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_ratio</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    },</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> optimizer_cls</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer_grouped_parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> **</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer_kwargs</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3 id=\"è°ƒæ•´trainerç±»æ–¹æ³•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è°ƒæ•´trainerç±»æ–¹æ³•\"><span>è°ƒæ•´Trainerç±»æ–¹æ³•</span></a></h3>\n<p>é‡å†™Trainerç±»çš„<code v-pre>create_optimizer</code>æ–¹æ³•ä»¥æ”¯æŒLoRA+ä¼˜åŒ–å™¨ï¼š</p>\n<p>â— <strong>å®ç°æ­¥éª¤</strong>ï¼š</p>\n<ol>\n<li>æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†Sagemakerå¤šå¤„ç†ã€‚</li>\n<li>ä½¿ç”¨<code v-pre>create_lorap_optimizer</code>æ–¹æ³•åˆ›å»ºä¼˜åŒ–å™¨ã€‚</li>\n</ol>\n<p>ğŸ’¡ <strong>å¯å‘ç‚¹</strong>ï¼š\nè¿™ç§æ–¹æ³•é€šè¿‡è°ƒæ•´å­¦ä¹ ç‡æé«˜äº†è®­ç»ƒæ•ˆç‡ï¼Œå€¼å¾—åœ¨å…¶ä»–é€‚é…å™¨ä¸­å°è¯•ã€‚</p>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"--shiki-light:#2E8F82;--shiki-dark:#5DA994\"> LoraPlusTrainer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">Trainer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">    def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> create_optimizer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        opt_model </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">model_wrapped </span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> is_sagemaker_mp_enabled</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> else</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">model</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">is</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> None</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            optimizer_cls</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> optimizer_kwargs </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> Trainer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">get_optimizer_cls_and_kwargs</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">args</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            lora_lr_ratio </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> LORA_LR_RATIO</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            lora_lr_embedding </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> LORA_LR_EMBEDDING</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">            self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> create_lorap_optimizer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">opt_model</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_ratio</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> optimizer_cls</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> optimizer_kwargs</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">            if</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> is_sagemaker_mp_enabled</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">():</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">                self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> smp</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">DistributedOptimizer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        return</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3 id=\"å…¬å¼è°ƒæ•´\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å…¬å¼è°ƒæ•´\"><span>å…¬å¼è°ƒæ•´</span></a></h3>\n<p>å…¬å¼æ›´æ–°è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>\n<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>A</mi><mo>â†</mo><mi>A</mi><mo>âˆ’</mo><mi>Î·</mi><mo>Ã—</mo><msub><mi>G</mi><mi>A</mi></msub></mrow><annotation encoding=\"application/x-tex\">A \\leftarrow A - \\eta \\times G_A\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">â†</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">âˆ’</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">Î·</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">Ã—</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">G</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">A</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>B</mi><mo>â†</mo><mi>B</mi><mo>âˆ’</mo><mi>Î»</mi><mi>Î·</mi><mo>Ã—</mo><msub><mi>G</mi><mi>B</mi></msub><mo separator=\"true\">,</mo><mspace width=\"1em\"/><mi>Î»</mi><mo>â‰«</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">B \\leftarrow B - \\lambda \\eta \\times G_B, \\quad \\lambda \\gg 1\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">â†</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">âˆ’</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">Î»</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">Î·</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">Ã—</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">G</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">Î»</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">â‰«</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span></span></p>\n<h2 id=\"å¸¸è§é”™è¯¯\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¸¸è§é”™è¯¯\"><span>å¸¸è§é”™è¯¯</span></a></h2>\n<blockquote>\n<p>åœ¨è°ƒæ•´å­¦ä¹ ç‡æ—¶ï¼Œç¡®ä¿æ¯”ä¾‹å…³ç³»æ­£ç¡®ï¼Œé¿å…å› è®¾ç½®é”™è¯¯å¯¼è‡´æ¨¡å‹ä¸æ”¶æ•›ã€‚</p>\n</blockquote>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ul class=\"task-list-container\">\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-0\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-0\"> å®ç°å¹¶æµ‹è¯•LoRA+ä¼˜åŒ–å™¨åœ¨ä¸åŒæ¨¡å‹ä¸­çš„æ•ˆæœã€‚</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-1\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-1\"> è®°å½•è®­ç»ƒè¿‡ç¨‹ä¸­çš„å‚æ•°å˜åŒ–ä»¥éªŒè¯ä¼˜åŒ–æ•ˆæœã€‚</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-2\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-2\"> æ¢ç´¢å…¶ä»–é€‚é…å™¨ä¸­åº”ç”¨ç±»ä¼¼ç­–ç•¥çš„å¯è¡Œæ€§ã€‚</label></li>\n</ul>\n<blockquote>\n<p>åŸå§‹å‡ºå¤„ï¼šsimple-lora-plus/tricks/lora_plus.py</p>\n</blockquote>\n</template>","contentStripped":"<h2 id=\"å…ƒæ•°æ®\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å…ƒæ•°æ®\"><span>å…ƒæ•°æ®</span></a></h2>\n<ul>\n<li>åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ ä¼˜åŒ–</li>\n<li>æ ‡ç­¾ï¼šLoRA, é€‚é…å™¨, å­¦ä¹ ç‡, ä¼˜åŒ–å™¨, è®­ç»ƒ</li>\n<li>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</li>\n</ul>\n<h2 id=\"å†…å®¹æ‘˜è¦\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å†…å®¹æ‘˜è¦\"><span>å†…å®¹æ‘˜è¦</span></a></h2>\n<p>LoRA+æ˜¯ä¸€ç§é’ˆå¯¹LoRAé€‚é…å™¨çš„ä¼˜åŒ–æ–¹æ³•ï¼Œé€šè¿‡ä¸ºçŸ©é˜µAå’ŒBè®¾ç½®ä¸åŒçš„å­¦ä¹ ç‡æ¥æé«˜è®­ç»ƒæ•ˆç‡ã€‚æ ¸å¿ƒè§‚ç‚¹æ˜¯ä½¿ç”¨ä¸åŒçš„å­¦ä¹ ç‡ç­–ç•¥ï¼Œå…¶ä¸­Bçš„å­¦ä¹ ç‡æ˜¯Açš„6å€ã€‚è¿™ç§æ–¹æ³•ä¸ä»…æå‡äº†æ¨¡å‹çš„é€‚åº”æ€§ï¼Œè¿˜ç®€åŒ–äº†ä¼˜åŒ–è¿‡ç¨‹ã€‚</p>\n<h2 id=\"æ ¸å¿ƒå†…å®¹\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒå†…å®¹\"><span>æ ¸å¿ƒå†…å®¹</span></a></h2>\n<p><img src=\"/img/user/é™„ä»¶/Pasted image 20250424111627.png\" alt=\"Pasted image 20250424111627.png\"></p>\n<h3 id=\"lora-ä¼˜åŒ–å™¨åˆ›å»º\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#lora-ä¼˜åŒ–å™¨åˆ›å»º\"><span>LoRA+ä¼˜åŒ–å™¨åˆ›å»º</span></a></h3>\n<p>LoRA+ä¼˜åŒ–å™¨é€šè¿‡è®¾ç½®ä¸åŒçš„å­¦ä¹ ç‡æ¥å®ç°æ›´é«˜æ•ˆçš„è®­ç»ƒã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<p>âœ… <strong>å‚æ•°åˆ†ç»„</strong>ï¼š</p>\n<ul>\n<li>å°†æ¨¡å‹å‚æ•°åˆ†ä¸ºä¸åŒç»„ï¼Œåˆ†åˆ«è®¾ç½®å­¦ä¹ ç‡å’Œæƒé‡è¡°å‡ã€‚</li>\n<li>çŸ©é˜µAçš„å­¦ä¹ ç‡ä¸º<code v-pre>lr</code>ï¼ŒçŸ©é˜µBçš„å­¦ä¹ ç‡ä¸º<code v-pre>lr * lora_lr_ratio</code>ã€‚</li>\n</ul>\n<p>âš ï¸ <strong>æ³¨æ„äº‹é¡¹</strong>ï¼š</p>\n<ul>\n<li>ç¡®ä¿æƒé‡è¡°å‡è®¾ç½®æ­£ç¡®ï¼Œé¿å…è®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç°è¿‡æ‹Ÿåˆã€‚</li>\n</ul>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer_grouped_parameters </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> [</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">params</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> list</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">A</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">].</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">weight_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> weight_decay</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">lr</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lr</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    },</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">params</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> list</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">embedding</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">].</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">weight_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> weight_decay</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">lr</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    },</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">params</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> list</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">B</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">].</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">weight_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> weight_decay</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">lr</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lr </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_ratio</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    },</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">params</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> list</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">B_no_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">].</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">weight_decay</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 0.0</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">lr</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lr </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_ratio</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    },</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> optimizer_cls</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer_grouped_parameters</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> **</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer_kwargs</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3 id=\"è°ƒæ•´trainerç±»æ–¹æ³•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è°ƒæ•´trainerç±»æ–¹æ³•\"><span>è°ƒæ•´Trainerç±»æ–¹æ³•</span></a></h3>\n<p>é‡å†™Trainerç±»çš„<code v-pre>create_optimizer</code>æ–¹æ³•ä»¥æ”¯æŒLoRA+ä¼˜åŒ–å™¨ï¼š</p>\n<p>â— <strong>å®ç°æ­¥éª¤</strong>ï¼š</p>\n<ol>\n<li>æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†Sagemakerå¤šå¤„ç†ã€‚</li>\n<li>ä½¿ç”¨<code v-pre>create_lorap_optimizer</code>æ–¹æ³•åˆ›å»ºä¼˜åŒ–å™¨ã€‚</li>\n</ol>\n<p>ğŸ’¡ <strong>å¯å‘ç‚¹</strong>ï¼š\nè¿™ç§æ–¹æ³•é€šè¿‡è°ƒæ•´å­¦ä¹ ç‡æé«˜äº†è®­ç»ƒæ•ˆç‡ï¼Œå€¼å¾—åœ¨å…¶ä»–é€‚é…å™¨ä¸­å°è¯•ã€‚</p>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"--shiki-light:#2E8F82;--shiki-dark:#5DA994\"> LoraPlusTrainer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">Trainer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">    def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> create_optimizer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        opt_model </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">model_wrapped </span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> is_sagemaker_mp_enabled</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> else</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">model</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">is</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> None</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            optimizer_cls</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> optimizer_kwargs </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> Trainer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">get_optimizer_cls_and_kwargs</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">args</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            lora_lr_ratio </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> LORA_LR_RATIO</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            lora_lr_embedding </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> LORA_LR_EMBEDDING</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">            self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> create_lorap_optimizer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">opt_model</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_ratio</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> optimizer_cls</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> optimizer_kwargs</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> lora_lr_embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">            if</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> is_sagemaker_mp_enabled</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">():</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">                self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> smp</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">DistributedOptimizer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        return</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">optimizer</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3 id=\"å…¬å¼è°ƒæ•´\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å…¬å¼è°ƒæ•´\"><span>å…¬å¼è°ƒæ•´</span></a></h3>\n<p>å…¬å¼æ›´æ–°è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>\n<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>A</mi><mo>â†</mo><mi>A</mi><mo>âˆ’</mo><mi>Î·</mi><mo>Ã—</mo><msub><mi>G</mi><mi>A</mi></msub></mrow><annotation encoding=\"application/x-tex\">A \\leftarrow A - \\eta \\times G_A\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">â†</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">âˆ’</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">Î·</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">Ã—</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">G</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">A</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>B</mi><mo>â†</mo><mi>B</mi><mo>âˆ’</mo><mi>Î»</mi><mi>Î·</mi><mo>Ã—</mo><msub><mi>G</mi><mi>B</mi></msub><mo separator=\"true\">,</mo><mspace width=\"1em\"/><mi>Î»</mi><mo>â‰«</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">B \\leftarrow B - \\lambda \\eta \\times G_B, \\quad \\lambda \\gg 1\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">â†</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">âˆ’</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">Î»</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">Î·</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">Ã—</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">G</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">Î»</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">â‰«</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span></span></p>\n<h2 id=\"å¸¸è§é”™è¯¯\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¸¸è§é”™è¯¯\"><span>å¸¸è§é”™è¯¯</span></a></h2>\n<blockquote>\n<p>åœ¨è°ƒæ•´å­¦ä¹ ç‡æ—¶ï¼Œç¡®ä¿æ¯”ä¾‹å…³ç³»æ­£ç¡®ï¼Œé¿å…å› è®¾ç½®é”™è¯¯å¯¼è‡´æ¨¡å‹ä¸æ”¶æ•›ã€‚</p>\n</blockquote>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ul class=\"task-list-container\">\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-0\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-0\"> å®ç°å¹¶æµ‹è¯•LoRA+ä¼˜åŒ–å™¨åœ¨ä¸åŒæ¨¡å‹ä¸­çš„æ•ˆæœã€‚</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-1\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-1\"> è®°å½•è®­ç»ƒè¿‡ç¨‹ä¸­çš„å‚æ•°å˜åŒ–ä»¥éªŒè¯ä¼˜åŒ–æ•ˆæœã€‚</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" class=\"task-list-item-checkbox\" id=\"task-item-2\" disabled=\"disabled\"><label class=\"task-list-item-label\" for=\"task-item-2\"> æ¢ç´¢å…¶ä»–é€‚é…å™¨ä¸­åº”ç”¨ç±»ä¼¼ç­–ç•¥çš„å¯è¡Œæ€§ã€‚</label></li>\n</ul>\n<blockquote>\n<p>åŸå§‹å‡ºå¤„ï¼šsimple-lora-plus/tricks/lora_plus.py</p>\n</blockquote>\n","tagOpen":"<template>","tagClose":"</template>"},"script":null,"scriptSetup":null,"scripts":[],"styles":[],"customBlocks":[]},"content":"\n## å…ƒæ•°æ®\n- åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ ä¼˜åŒ–\n- æ ‡ç­¾ï¼šLoRA, é€‚é…å™¨, å­¦ä¹ ç‡, ä¼˜åŒ–å™¨, è®­ç»ƒ\n- æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥\n\n\n## å†…å®¹æ‘˜è¦\nLoRA+æ˜¯ä¸€ç§é’ˆå¯¹LoRAé€‚é…å™¨çš„ä¼˜åŒ–æ–¹æ³•ï¼Œé€šè¿‡ä¸ºçŸ©é˜µAå’ŒBè®¾ç½®ä¸åŒçš„å­¦ä¹ ç‡æ¥æé«˜è®­ç»ƒæ•ˆç‡ã€‚æ ¸å¿ƒè§‚ç‚¹æ˜¯ä½¿ç”¨ä¸åŒçš„å­¦ä¹ ç‡ç­–ç•¥ï¼Œå…¶ä¸­Bçš„å­¦ä¹ ç‡æ˜¯Açš„6å€ã€‚è¿™ç§æ–¹æ³•ä¸ä»…æå‡äº†æ¨¡å‹çš„é€‚åº”æ€§ï¼Œè¿˜ç®€åŒ–äº†ä¼˜åŒ–è¿‡ç¨‹ã€‚\n\n\n## æ ¸å¿ƒå†…å®¹\n![Pasted image 20250424111627.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250424111627.png)\n\n### LoRA+ä¼˜åŒ–å™¨åˆ›å»º\nLoRA+ä¼˜åŒ–å™¨é€šè¿‡è®¾ç½®ä¸åŒçš„å­¦ä¹ ç‡æ¥å®ç°æ›´é«˜æ•ˆçš„è®­ç»ƒã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š\n\nâœ… **å‚æ•°åˆ†ç»„**ï¼š\n- å°†æ¨¡å‹å‚æ•°åˆ†ä¸ºä¸åŒç»„ï¼Œåˆ†åˆ«è®¾ç½®å­¦ä¹ ç‡å’Œæƒé‡è¡°å‡ã€‚\n- çŸ©é˜µAçš„å­¦ä¹ ç‡ä¸º`lr`ï¼ŒçŸ©é˜µBçš„å­¦ä¹ ç‡ä¸º`lr * lora_lr_ratio`ã€‚\n\nâš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š\n- ç¡®ä¿æƒé‡è¡°å‡è®¾ç½®æ­£ç¡®ï¼Œé¿å…è®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç°è¿‡æ‹Ÿåˆã€‚\n\n```python\noptimizer_grouped_parameters = [\n    {\n        \"params\": list(parameters[\"A\"].values()),\n        \"weight_decay\": weight_decay,\n        \"lr\": lr,\n    },\n    {\n        \"params\": list(parameters[\"embedding\"].values()),\n        \"weight_decay\": weight_decay,\n        \"lr\": lora_lr_embedding,\n    },\n    {\n        \"params\": list(parameters[\"B\"].values()),\n        \"weight_decay\": weight_decay,\n        \"lr\": lr * lora_lr_ratio,\n    },\n    {\n        \"params\": list(parameters[\"B_no_decay\"].values()),\n        \"weight_decay\": 0.0,\n        \"lr\": lr * lora_lr_ratio,\n    },\n]\noptimizer = optimizer_cls(optimizer_grouped_parameters, **optimizer_kwargs)\n```\n\n\n### è°ƒæ•´Trainerç±»æ–¹æ³•\né‡å†™Trainerç±»çš„`create_optimizer`æ–¹æ³•ä»¥æ”¯æŒLoRA+ä¼˜åŒ–å™¨ï¼š\n\nâ— **å®ç°æ­¥éª¤**ï¼š\n1. æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†Sagemakerå¤šå¤„ç†ã€‚\n2. ä½¿ç”¨`create_lorap_optimizer`æ–¹æ³•åˆ›å»ºä¼˜åŒ–å™¨ã€‚\n\nğŸ’¡ **å¯å‘ç‚¹**ï¼š\nè¿™ç§æ–¹æ³•é€šè¿‡è°ƒæ•´å­¦ä¹ ç‡æé«˜äº†è®­ç»ƒæ•ˆç‡ï¼Œå€¼å¾—åœ¨å…¶ä»–é€‚é…å™¨ä¸­å°è¯•ã€‚\n\n```python\nclass LoraPlusTrainer(Trainer):\n    def create_optimizer(self):\n        opt_model = self.model_wrapped if is_sagemaker_mp_enabled() else self.model\n\n        if self.optimizer is None:\n            optimizer_cls, optimizer_kwargs = Trainer.get_optimizer_cls_and_kwargs(self.args)\n\n            lora_lr_ratio = LORA_LR_RATIO\n            lora_lr_embedding = LORA_LR_EMBEDDING\n\n            self.optimizer = create_lorap_optimizer(opt_model, lora_lr_ratio, optimizer_cls, optimizer_kwargs, lora_lr_embedding)\n            if is_sagemaker_mp_enabled():\n                self.optimizer = smp.DistributedOptimizer(self.optimizer)\n\n        return self.optimizer\n```\n\n\n### å…¬å¼è°ƒæ•´\nå…¬å¼æ›´æ–°è¿‡ç¨‹å¦‚ä¸‹ï¼š\n$$\nA \\leftarrow A - \\eta \\times G_A\n$$\n$$\nB \\leftarrow B - \\lambda \\eta \\times G_B, \\quad \\lambda \\gg 1\n$$\n\n\n## å¸¸è§é”™è¯¯\n> åœ¨è°ƒæ•´å­¦ä¹ ç‡æ—¶ï¼Œç¡®ä¿æ¯”ä¾‹å…³ç³»æ­£ç¡®ï¼Œé¿å…å› è®¾ç½®é”™è¯¯å¯¼è‡´æ¨¡å‹ä¸æ”¶æ•›ã€‚\n\n\n## è¡ŒåŠ¨æ¸…å•\n- [ ] å®ç°å¹¶æµ‹è¯•LoRA+ä¼˜åŒ–å™¨åœ¨ä¸åŒæ¨¡å‹ä¸­çš„æ•ˆæœã€‚\n- [ ] è®°å½•è®­ç»ƒè¿‡ç¨‹ä¸­çš„å‚æ•°å˜åŒ–ä»¥éªŒè¯ä¼˜åŒ–æ•ˆæœã€‚\n- [ ] æ¢ç´¢å…¶ä»–é€‚é…å™¨ä¸­åº”ç”¨ç±»ä¼¼ç­–ç•¥çš„å¯è¡Œæ€§ã€‚\n\n> åŸå§‹å‡ºå¤„ï¼šsimple-lora-plus/tricks/lora_plus.py","excerpt":"","includedFiles":[],"tasklistId":3,"title":"","headers":[{"level":2,"title":"å…ƒæ•°æ®","slug":"å…ƒæ•°æ®","link":"#å…ƒæ•°æ®","children":[]},{"level":2,"title":"å†…å®¹æ‘˜è¦","slug":"å†…å®¹æ‘˜è¦","link":"#å†…å®¹æ‘˜è¦","children":[]},{"level":2,"title":"æ ¸å¿ƒå†…å®¹","slug":"æ ¸å¿ƒå†…å®¹","link":"#æ ¸å¿ƒå†…å®¹","children":[{"level":3,"title":"LoRA+ä¼˜åŒ–å™¨åˆ›å»º","slug":"lora-ä¼˜åŒ–å™¨åˆ›å»º","link":"#lora-ä¼˜åŒ–å™¨åˆ›å»º","children":[]},{"level":3,"title":"è°ƒæ•´Trainerç±»æ–¹æ³•","slug":"è°ƒæ•´trainerç±»æ–¹æ³•","link":"#è°ƒæ•´trainerç±»æ–¹æ³•","children":[]},{"level":3,"title":"å…¬å¼è°ƒæ•´","slug":"å…¬å¼è°ƒæ•´","link":"#å…¬å¼è°ƒæ•´","children":[]}]},{"level":2,"title":"å¸¸è§é”™è¯¯","slug":"å¸¸è§é”™è¯¯","link":"#å¸¸è§é”™è¯¯","children":[]},{"level":2,"title":"è¡ŒåŠ¨æ¸…å•","slug":"è¡ŒåŠ¨æ¸…å•","link":"#è¡ŒåŠ¨æ¸…å•","children":[]}]}}
