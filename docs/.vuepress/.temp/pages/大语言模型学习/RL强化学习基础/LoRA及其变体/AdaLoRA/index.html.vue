<template><div><h2 id="å…ƒæ•°æ®" tabindex="-1"><a class="header-anchor" href="#å…ƒæ•°æ®"><span>å…ƒæ•°æ®</span></a></h2>
<p>åˆ†ç±»ï¼šè‡ªåŠ¨æ¨æ–­</p>
<p>æ ‡ç­¾ï¼šåŠ¨æ€é€‚é…ã€ä½ç§©åˆ†è§£ã€å¥‡å¼‚å€¼ã€æ·±åº¦å­¦ä¹ ã€AdaLoRA</p>
<p>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</p>
<h2 id="æ ¸å¿ƒè§‚ç‚¹" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒè§‚ç‚¹"><span>æ ¸å¿ƒè§‚ç‚¹</span></a></h2>
<p>AdaLoRAæ˜¯ä¸€ç§åˆ›æ–°çš„æ·±åº¦å­¦ä¹ æŠ€æœ¯ï¼Œå®ƒé€šè¿‡åŠ¨æ€è°ƒæ•´ä¸åŒå±‚å’Œå‚æ•°ç±»å‹çš„ç§©ï¼Œæ ¹æ®ä¸‹æ¸¸ä»»åŠ¡éœ€æ±‚è¿›è¡Œä¼˜åŒ–ã€‚è¿™ç§æ–¹æ³•é‡‡ç”¨åŸºäºSVDï¼ˆå¥‡å¼‚å€¼åˆ†è§£ï¼‰çš„å‚æ•°åŒ–å½¢å¼ï¼Œå¯ä»¥æœ‰æ•ˆè£å‰ªä¸é‡è¦çš„å¥‡å¼‚å€¼ï¼Œé™ä½è®¡ç®—å¤æ‚åº¦ã€‚
<img src="/img/user/é™„ä»¶/Pasted image 20250424111842.png" alt="Pasted image 20250424111842.png">
ğŸ’¡å¯å‘ç‚¹ï¼šé€šè¿‡åŠ¨æ€åˆ†é…ç§©å’Œä½¿ç”¨SVDå‚æ•°åŒ–ï¼ŒAdaLoRAå®ç°äº†è®¡ç®—æ•ˆç‡ä¸æ€§èƒ½ä¼˜åŒ–çš„å¹³è¡¡ã€‚</p>
<h2 id="é‡ç‚¹æ®µè½" tabindex="-1"><a class="header-anchor" href="#é‡ç‚¹æ®µè½"><span>é‡ç‚¹æ®µè½</span></a></h2>
<h3 id="åŠ¨æ€ç§©åˆ†é…" tabindex="-1"><a class="header-anchor" href="#åŠ¨æ€ç§©åˆ†é…"><span>åŠ¨æ€ç§©åˆ†é…</span></a></h3>
<p>AdaLoRAä¸ä»…ä¸ºæ¯ä¸ªAdapteråˆ†é…ç›¸åŒçš„ç§©ï¼Œè€Œæ˜¯æ ¹æ®ä»»åŠ¡éœ€æ±‚åŠ¨æ€è°ƒæ•´å„å±‚å’Œå‚æ•°ç±»å‹çš„ç§©ã€‚è¿™ç§çµæ´»æ€§ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿæ›´åŠ é«˜æ•ˆåœ°å¤„ç†ä¸åŒçš„ä»»åŠ¡ã€‚</p>
<h3 id="svdå‚æ•°åŒ–å¢é‡æ›´æ–°" tabindex="-1"><a class="header-anchor" href="#svdå‚æ•°åŒ–å¢é‡æ›´æ–°"><span>SVDå‚æ•°åŒ–å¢é‡æ›´æ–°</span></a></h3>
<p>é‡‡ç”¨SVDå½¢å¼å‚æ•°åŒ–å¢é‡æ›´æ–°ï¼Œèƒ½å¤Ÿåœ¨è§„é¿å¤æ‚è®¡ç®—çš„åŒæ—¶é«˜æ•ˆè£å‰ªä¸é‡è¦çš„å¥‡å¼‚å€¼ã€‚è¿™ç§æ–¹æ³•å¤§å¤§é™ä½äº†è®¡ç®—é‡ï¼Œå¹¶æé«˜äº†æ¨¡å‹çš„é€‚åº”èƒ½åŠ›ã€‚</p>
<h3 id="æ ¸å¿ƒä»£ç è§£æ" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒä»£ç è§£æ"><span>æ ¸å¿ƒä»£ç è§£æ</span></a></h3>
<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code" v-pre=""><code><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676">class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994"> AdaLoraLayer</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665">LoraLayer</span><span style="--shiki-light:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676">    def</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665"> update_layer</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">self</span><span style="--shiki-light:#999999;--shiki-dark:#666666">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE"> adapter_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE"> r</span><span style="--shiki-light:#999999;--shiki-dark:#666666">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE"> lora_alpha</span><span style="--shiki-light:#999999;--shiki-dark:#666666">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE"> lora_dropout</span><span style="--shiki-light:#999999;--shiki-dark:#666666">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE"> init_lora_weights</span><span style="--shiki-light:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076">        self</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">lora_A</span><span style="--shiki-light:#999999;--shiki-dark:#666666">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">adapter_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE"> nn</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">Parameter</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">torch</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">randn</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">r</span><span style="--shiki-light:#999999;--shiki-dark:#666666">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076"> self</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">in_features</span><span style="--shiki-light:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD">        # Singular values</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076">        self</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">lora_E</span><span style="--shiki-light:#999999;--shiki-dark:#666666">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">adapter_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE"> nn</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">Parameter</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">torch</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">randn</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">r</span><span style="--shiki-light:#999999;--shiki-dark:#666666">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD">        # Left singular vectors</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076">        self</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">lora_B</span><span style="--shiki-light:#999999;--shiki-dark:#666666">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">adapter_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE"> nn</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">Parameter</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">torch</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">randn</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076">self</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">out_features</span><span style="--shiki-light:#999999;--shiki-dark:#666666">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE"> r</span><span style="--shiki-light:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD">        # The current rank</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076">        self</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">ranknum</span><span style="--shiki-light:#999999;--shiki-dark:#666666">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">adapter_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE"> nn</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">Parameter</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">torch</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">randn</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666">),</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A"> requires_grad</span><span style="--shiki-light:#999999;--shiki-dark:#666666">=</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375">False</span><span style="--shiki-light:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076">        self</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">ranknum</span><span style="--shiki-light:#999999;--shiki-dark:#666666">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">adapter_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666">].</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">data</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">fill_</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965">float</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">r</span><span style="--shiki-light:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076">        self</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">ranknum</span><span style="--shiki-light:#999999;--shiki-dark:#666666">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">adapter_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666">].</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">requires_grad </span><span style="--shiki-light:#999999;--shiki-dark:#666666">=</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375"> False</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076">        self</span><span style="--shiki-light:#999999;--shiki-dark:#666666">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">scaling</span><span style="--shiki-light:#999999;--shiki-dark:#666666">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">adapter_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE"> lora_alpha </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375">if</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE"> lora_alpha </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676">></span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375"> else</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965"> float</span><span style="--shiki-light:#999999;--shiki-dark:#666666">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE">r</span><span style="--shiki-light:#999999;--shiki-dark:#666666">)</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æ“ä½œæ­¥éª¤" tabindex="-1"><a class="header-anchor" href="#æ“ä½œæ­¥éª¤"><span>æ“ä½œæ­¥éª¤</span></a></h2>
<ol>
<li>âœ… åˆå§‹åŒ–å‚æ•°çŸ©é˜µå¹¶åˆ†é…ç§©ã€‚</li>
<li>âš  ä½¿ç”¨SVDè¿›è¡Œå¥‡å¼‚å€¼è£å‰ªã€‚</li>
<li>â— æ ¹æ®ä»»åŠ¡éœ€æ±‚åŠ¨æ€è°ƒæ•´é€‚é…å™¨æƒé‡ã€‚</li>
</ol>
<h2 id="å¸¸è§é”™è¯¯" tabindex="-1"><a class="header-anchor" href="#å¸¸è§é”™è¯¯"><span>å¸¸è§é”™è¯¯</span></a></h2>
<blockquote>
<p>âš  åœ¨è°ƒæ•´ç§©æ—¶ï¼Œå¯èƒ½ä¼šå¿½ç•¥ç‰¹å®šä»»åŠ¡å¯¹å‚æ•°çš„ç‰¹æ®Šéœ€æ±‚ï¼Œå¯¼è‡´æ¨¡å‹æ€§èƒ½ä¸‹é™ã€‚</p>
</blockquote>
<h2 id="è¡ŒåŠ¨æ¸…å•" tabindex="-1"><a class="header-anchor" href="#è¡ŒåŠ¨æ¸…å•"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>
<ul>
<li>ç ”ç©¶AdaLoRAåœ¨ä¸åŒä»»åŠ¡ä¸­çš„è¡¨ç°ã€‚</li>
<li>æ¢ç´¢å…¶ä»–åŸºäºSVDçš„ä¼˜åŒ–æŠ€æœ¯ã€‚</li>
<li>å®éªŒä¸åŒå‚æ•°è®¾ç½®å¯¹æ¨¡å‹æ€§èƒ½çš„å½±å“ã€‚</li>
</ul>
<h2 id="æ•°æ®è½¬æ¢" tabindex="-1"><a class="header-anchor" href="#æ•°æ®è½¬æ¢"><span>æ•°æ®è½¬æ¢</span></a></h2>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>r</td>
<td>å½“å‰ç§©</td>
</tr>
<tr>
<td>lora_alpha</td>
<td>è°ƒæ•´å› å­</td>
</tr>
</tbody>
</table>
<h2 id="å…¬å¼æ˜¾ç¤º" tabindex="-1"><a class="header-anchor" href="#å…¬å¼æ˜¾ç¤º"><span>å…¬å¼æ˜¾ç¤º</span></a></h2>
<p>ä½¿ç”¨å…¬å¼è¡¨ç¤ºå¥‡å¼‚å€¼ä¸ç§©å…³ç³»ï¼š</p>
<p v-pre class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>ranknum</mtext><mo>=</mo><mi>Î±</mi><mo>â‹…</mo><mtext>scaling</mtext></mrow><annotation encoding="application/x-tex">\text{ranknum} = \alpha \cdot \text{scaling} 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">ranknum</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">scaling</span></span></span></span></span></span></p>
<blockquote>
<p>åŸå§‹å†…å®¹æ¥è‡ªPEFT/src/peft/tuners/adalora/layer.pyã€‚</p>
</blockquote>
</div></template>


