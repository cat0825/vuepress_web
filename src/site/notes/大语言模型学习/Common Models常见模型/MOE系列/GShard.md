---
{"dg-publish":true,"dg-permalink":"/å¤§è¯­è¨€æ¨¡åž‹å­¦ä¹ /Common-Modelså¸¸è§æ¨¡åž‹/MOEç³»åˆ—/GShard","dg-home":false,"dg-description":"åœ¨æ­¤è¾“å…¥ç¬”è®°çš„æè¿°","dg-hide":false,"dg-hide-title":false,"dg-show-backlinks":true,"dg-show-local-graph":true,"dg-show-inline-title":true,"dg-pinned":false,"dg-passphrase":"åœ¨æ­¤è¾“å…¥è®¿é—®å¯†ç ","dg-enable-mathjax":false,"dg-enable-mermaid":false,"dg-enable-uml":false,"dg-note-icon":0,"dg-enable-dataview":false,"tags":["NLP"],"permalink":"/å¤§è¯­è¨€æ¨¡åž‹å­¦ä¹ /Common-Modelså¸¸è§æ¨¡åž‹/MOEç³»åˆ—/GShard/","dgShowBacklinks":true,"dgShowLocalGraph":true,"dgShowInlineTitle":true,"dgPassFrontmatter":true,"noteIcon":0,"created":"2025-04-27T22:19:27.000+08:00","updated":"2025-04-27T22:54:38.000+08:00"}
---



## å…ƒæ•°æ®
åˆ†ç±»ï¼šæœºå™¨å­¦ä¹ æž¶æž„

æ ‡ç­¾ï¼šGShard, æ¡ä»¶è®¡ç®—, è‡ªåŠ¨åˆ†ç‰‡, ä¸“å®¶æ¨¡åž‹, è´Ÿè½½å‡è¡¡

æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥



## å†…å®¹å¤„ç†

### æ ¸å¿ƒè§‚ç‚¹æ€»ç»“
GShardæ˜¯ä¸€ä¸ªç”¨äºŽæ‰©å±•å·¨åž‹æ¨¡åž‹çš„æž¶æž„ï¼Œé€šè¿‡æ¡ä»¶è®¡ç®—å’Œè‡ªåŠ¨åˆ†ç‰‡å®žçŽ°é«˜æ•ˆçš„æ¨¡åž‹è®­ç»ƒã€‚å…¶æ ¸å¿ƒåœ¨äºŽä½¿ç”¨Gateæ¥åˆ¤æ–­æ¯ä¸ªtokenåº”è¯¥å‘é€åˆ°å“ªä¸ªexpertï¼Œå¹¶é‡‡ç”¨top2Expertç­–ç•¥æ¥ç¡®ä¿è®¡ç®—æ•ˆçŽ‡ã€‚ä¸ºäº†å¤„ç†tokenæº¢å‡ºï¼ŒGShardå¼•å…¥äº†drop tokenså’Œzero paddingæœºåˆ¶ã€‚æ­¤å¤–ï¼Œä¸ºäº†ä¿è¯ä¸“å®¶è´Ÿè½½å‡è¡¡ï¼Œè¿˜ä½¿ç”¨äº†ä¸€ç§è¾…åŠ©æŸå¤±å‡½æ•°ã€‚
![Pasted image 20250427222046.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250427222046.png)


### é‡ç‚¹æ®µè½æå–
1. **Gateæœºåˆ¶**ï¼šä½¿ç”¨çº¿å½¢å±‚Gateåˆ¤æ–­tokenåº”è¯¥é€åŽ»å“ªä¸ªexpertï¼Œå°ºå¯¸å¤§å°ä¸º $(M, E)$ï¼Œå…¶ä¸­$E$è¡¨ç¤ºexpertæ•°é‡ã€‚è¾“å…¥æ•°æ® $(S, M)$ è¿‡GateåŽï¼Œå¾—åˆ°probæ•°æ® $(S, E)$ï¼Œè¡¨ç¤ºæ¯ä¸ªtokenåŽ»å‘æ¯ä¸ªexpertçš„æ¦‚çŽ‡ã€‚

2. **Expertä¸Žæº¢å‡ºå¤„ç†**ï¼šè®¾ç½®expert bufferæ¥å¤„ç†tokenæº¢å‡ºï¼Œæ¯ä¸ªexpertæŽ¥æ”¶çš„tokenä¸Šé™ä¸º $(8/4)*2 = 4$ã€‚å¦‚æžœå•ä¸ªexpertæº¢å‡ºï¼Œåˆ™è°ƒæ•´æƒé‡å€¼ä¸º1ï¼›è‹¥ä¸¤ä¸ªexpertéƒ½æº¢å‡ºï¼Œåˆ™é€šè¿‡æ®‹å·®è¿žæŽ¥ç›´æŽ¥é€è‡³ä¸‹ä¸€å±‚ã€‚

3. **éšæœºè·¯ç”±ä¸Žè¾…åŠ©æŸå¤±å‡½æ•°**ï¼šåœ¨é€‰æ‹©ç¬¬äºŒä¸ªexpertæ—¶ï¼Œé€šè¿‡åŠ å™ªå¤„ç†å’Œmaskæ“ä½œæ¥ç¡®å®šæœ€ç»ˆçš„top2Expertï¼Œå¹¶é€šè¿‡è¾…åŠ©æŸå¤±å‡½æ•°æ¥ä¿è¯è´Ÿè½½å‡è¡¡ã€‚


### æŠ€æœ¯æœ¯è¯­è½¬è¿°
- **Gate**ï¼šç±»ä¼¼äºŽè·¯ç”±å™¨ï¼Œå†³å®šæ•°æ®æµå‘å“ªä¸ªä¸“å®¶ã€‚
- **Expert Buffer**ï¼šä¸“å®¶çš„ç¼“å­˜åŒºï¼Œç”¨äºŽå­˜å‚¨å¾…å¤„ç†çš„tokenã€‚
- **Drop Tokens**ï¼šä¸¢å¼ƒæ— æ³•æ­£å¸¸å¤„ç†çš„æº¢å‡ºtokenã€‚
- **Zero Padding**ï¼šç”¨é›¶å¡«å……æœªä½¿ç”¨çš„ç¼“å­˜åŒºä½ç½®ã€‚
- **Random Routing**ï¼šé€šè¿‡éšæœºå™ªå£°å½±å“é€‰æ‹©ç¬¬äºŒä¸ªä¸“å®¶ã€‚



## æ“ä½œæ­¥éª¤
1. âœ… ä½¿ç”¨Gateç¡®å®šæ¯ä¸ªtokençš„åŽ»å‘ã€‚
2. âš  è®¾ç½®expert bufferä»¥å¤„ç†æº¢å‡ºæƒ…å†µã€‚
3. â— åœ¨å‘ç”Ÿæº¢å‡ºæ—¶ï¼Œè°ƒæ•´æƒé‡æˆ–é€šè¿‡æ®‹å·®è¿žæŽ¥å‘é€è‡³ä¸‹ä¸€å±‚ã€‚
4. âœ… ä½¿ç”¨éšæœºè·¯ç”±ç­–ç•¥é€‰æ‹©ç¬¬äºŒä¸ªä¸“å®¶ã€‚
5. â— å¼•å…¥è¾…åŠ©æŸå¤±å‡½æ•°ä»¥ç¡®ä¿è´Ÿè½½å‡è¡¡ã€‚
![Pasted image 20250427222059.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250427222059.png)



## å¸¸è§é”™è¯¯
> æ³¨æ„åœ¨è®¾ç½®expert bufferæ—¶ï¼Œç¡®ä¿å…¶å®¹é‡è®¡ç®—æ­£ç¡®ï¼Œä»¥é¿å…è¿‡å¤štokenæº¢å‡ºå¯¼è‡´æ¨¡åž‹æ€§èƒ½ä¸‹é™ã€‚



## ðŸ’¡å¯å‘ç‚¹
GShardé€šè¿‡æ¡ä»¶è®¡ç®—å’Œè‡ªåŠ¨åˆ†ç‰‡çš„ç»“åˆï¼Œæä¾›äº†ä¸€ç§æœ‰æ•ˆæ‰©å±•å·¨åž‹æ¨¡åž‹çš„æ–¹æ³•ï¼ŒåŒæ—¶é€šè¿‡è´Ÿè½½å‡è¡¡æœºåˆ¶æé«˜äº†è®¡ç®—æ•ˆçŽ‡ã€‚



## è¡ŒåŠ¨æ¸…å•
- ç ”ç©¶GShardåœ¨ä¸åŒä»»åŠ¡ä¸Šçš„æ€§èƒ½è¡¨çŽ°ã€‚
- æŽ¢ç´¢å…¶ä»–MoEæž¶æž„ä¸­çš„è·¯ç”±æœºåˆ¶ã€‚
- å®žéªŒä¸åŒçš„è¾…åŠ©æŸå¤±å‡½æ•°å¯¹è´Ÿè½½å‡è¡¡çš„å½±å“ã€‚



## æ•°æ®è½¬æ¢
| Token æ•°é‡ | Expert æ•°é‡ | æ¯ä¸ª Expert æŽ¥æ”¶ Token ä¸Šé™ |
|------------|-------------|-----------------------------|
| 8          | 4           | 4                           |



## å…¬å¼æ˜¾ç¤º
$$
capacity = \max(E \times S \times K \times capacity\_factor, min\_capacity)
$$

$$
l_{aux} = \sum_{e=1}^{E} \frac{S}{c_e} \times m_e
$$

> åŽŸå§‹å‡ºå¤„ï¼šè®ºæ–‡ã€ŠGShard: Scaling Giant Models with Conditional Computation and Automatic Shardingã€‹
