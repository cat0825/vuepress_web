{"content":"<h2 id=\"åˆ†ç±»\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#åˆ†ç±»\"><span>åˆ†ç±»</span></a></h2>\n<p>è‡ªåŠ¨æ¨æ–­</p>\n<h2 id=\"æ ‡ç­¾\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ‡ç­¾\"><span>æ ‡ç­¾</span></a></h2>\n<p>æ·±åº¦å­¦ä¹ , æŸå¤±å‡½æ•°, ä¼˜åŒ–ç®—æ³•, å¯¹æ¯”å­¦ä¹ , äººç±»åå¥½</p>\n<h2 id=\"æ—¥æœŸ\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ—¥æœŸ\"><span>æ—¥æœŸ</span></a></h2>\n<p>2025å¹´4æœˆ12æ—¥</p>\n<h2 id=\"å†…å®¹æ¦‚è¦\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å†…å®¹æ¦‚è¦\"><span>å†…å®¹æ¦‚è¦</span></a></h2>\n<p>æ·±åº¦åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰æ˜¯ä¸€ç§æ—¨åœ¨ä½¿æ¨¡å‹è¾“å‡ºä¸äººç±»åå¥½å¯¹é½çš„æŠ€æœ¯ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡å¯¹æ¯”å­¦ä¹ çš„æ–¹å¼ï¼Œä¼˜åŒ–æ¨¡å‹åœ¨é€‰æ‹©ä¸æ‹’ç»å›ç­”çš„æ¦‚ç‡å·®å¼‚ã€‚æœ¬æ–‡å°†è¯¦ç»†è§£æDPOæŸå¤±å‡½æ•°çš„åŸç†ï¼Œå¹¶æä¾›ç›¸å…³ä»£ç ç¤ºä¾‹ã€‚</p>\n<p><img src=\"/img/user/é™„ä»¶/Pasted image 20250422224044.png\" alt=\"Pasted image 20250422224044.png\">\n<img src=\"/img/user/é™„ä»¶/Pasted image 20250422224104.png\" alt=\"Pasted image 20250422224104.png\"><img src=\"/img/user/é™„ä»¶/Pasted image 20250422224109.png\" alt=\"Pasted image 20250422224109.png\"></p>\n<h2 id=\"ç†è§£dpoæŸå¤±å‡½æ•°\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ç†è§£dpoæŸå¤±å‡½æ•°\"><span>ç†è§£DPOæŸå¤±å‡½æ•°</span></a></h2>\n<p>DPOæŸå¤±å‡½æ•°çš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–åå¥½å›ç­”ä¸ä¸åå¥½å›ç­”ä¹‹é—´çš„æ¦‚ç‡å·®å€¼ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåå¥½å›ç­”çš„æ¦‚ç‡ä¼šå¢åŠ ï¼Œè€Œä¸åå¥½å›ç­”çš„æ¦‚ç‡ä¼šå‡å°‘ï¼Œä»è€Œå®ç°ä¸äººç±»åå¥½çš„å¯¹é½ã€‚</p>\n<p>ğŸ’¡å¯å‘ç‚¹ï¼šDPOé€šè¿‡çº¦æŸæ¦‚ç‡å·®å€¼è€Œéç»å¯¹æ¦‚ç‡ï¼Œæä¾›äº†çµæ´»çš„ä¼˜åŒ–æ–¹å¼ã€‚</p>\n<h2 id=\"æ ¸å¿ƒä»£ç è§£æ\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒä»£ç è§£æ\"><span>æ ¸å¿ƒä»£ç è§£æ</span></a></h2>\n<p>ä¸‹é¢æ˜¯DPOæŸå¤±å‡½æ•°çš„ä»£ç ç¤ºä¾‹ï¼š</p>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"--shiki-light:#2E8F82;--shiki-dark:#5DA994\"> DPOLoss</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">Module</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">    \"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">    DPO Loss</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">    \"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">    def</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> __init__</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beta</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> float</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> label_smoothing</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> float</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 0.0</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> ipo</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> bool</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> False</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> -></span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> None</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">        super</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">().</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">__init__</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">        self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beta</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">        self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">label_smoothing </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> label_smoothing</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">        self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">ipo </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> ipo</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">    def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> forward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        policy_chosen_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        policy_rejected_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        reference_chosen_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        reference_rejected_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    )</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> -></span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> Tuple</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        pi_logratios </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> policy_chosen_logps </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> policy_rejected_logps</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        ref_logratios </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reference_chosen_logps </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reference_rejected_logps</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        logits </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> pi_logratios </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> ref_logratios</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">ipo</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            losses </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logits </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> /</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">2</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> *</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">))</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> **</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 2</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        else</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            losses </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">                -</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">F</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logsigmoid</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> logits</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> *</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">label_smoothing</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">                -</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> F</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logsigmoid</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> logits</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> *</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">label_smoothing</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">            )</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        loss </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> losses</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">mean</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        chosen_rewards </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">policy_chosen_logps </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reference_chosen_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">).</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">detach</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        rejected_rewards </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">policy_rejected_logps </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reference_rejected_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">).</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">detach</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> loss</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> chosen_rewards</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> rejected_rewards</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2 id=\"æ“ä½œæ­¥éª¤\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ“ä½œæ­¥éª¤\"><span>æ“ä½œæ­¥éª¤</span></a></h2>\n<p>âœ… ç†è§£æŸå¤±å‡½æ•°å…¬å¼ï¼šé€šè¿‡å¯¹æ¯”å­¦ä¹ æœ€å¤§åŒ–æ¦‚ç‡å·®å€¼ã€‚</p>\n<p>âš  æ³¨æ„å‚æ•°è®¾ç½®ï¼š<span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Î²</mi></mrow><annotation encoding=\"application/x-tex\">\\beta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²</span></span></span></span> å’Œæ ‡ç­¾å¹³æ»‘å‚æ•°å¯èƒ½å½±å“ä¼˜åŒ–ç»“æœã€‚</p>\n<p>â— æ£€æŸ¥ä»£ç å®ç°ï¼šç¡®ä¿ä»£ç é€»è¾‘ä¸ç†è®ºä¸€è‡´ã€‚</p>\n<h2 id=\"å¸¸è§é”™è¯¯\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¸¸è§é”™è¯¯\"><span>å¸¸è§é”™è¯¯</span></a></h2>\n<blockquote>\n<p>è­¦å‘Šï¼šåœ¨å®è·µä¸­å¯èƒ½å‡ºç°é€‰æ‹©å’Œæ‹’ç»æ¦‚ç‡åŒæ—¶ä¸‹é™çš„æƒ…å†µï¼Œå› ä¸ºDPOä»…çº¦æŸå·®å€¼ã€‚</p>\n</blockquote>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ol>\n<li>æ¢ç´¢ä¸åŒçš„æ­£åˆ™åŒ–æ‰‹æ®µä»¥ä¼˜åŒ–DPOã€‚</li>\n<li>æµ‹è¯•ä¸åŒçš„ <span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Î²</mi></mrow><annotation encoding=\"application/x-tex\">\\beta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²</span></span></span></span> å€¼å¯¹æ¨¡å‹è¾“å‡ºçš„å½±å“ã€‚</li>\n<li>ç ”ç©¶å…¶ä»–å¯¹æ¯”å­¦ä¹ æ–¹æ³•ä¸DPOç»“åˆçš„æ•ˆæœã€‚</li>\n</ol>\n<h2 id=\"æ•°æ®è½¬æ¢\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ•°æ®è½¬æ¢\"><span>æ•°æ®è½¬æ¢</span></a></h2>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Î²</mi></mrow><annotation encoding=\"application/x-tex\">\\beta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²</span></span></span></span></td>\n<td>æ§åˆ¶æŸå¤±å‡½æ•°æ•æ„Ÿåº¦</td>\n</tr>\n<tr>\n<td>æ ‡ç­¾å¹³æ»‘</td>\n<td>å‡å°‘è¿‡æ‹Ÿåˆé£é™©</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"å…¬å¼æ˜¾ç¤º\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å…¬å¼æ˜¾ç¤º\"><span>å…¬å¼æ˜¾ç¤º</span></a></h2>\n<p>å…¬å¼åœ¨ä»£ç ä¸­ä½¿ç”¨ï¼š</p>\n<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi><mi>e</mi><mi>s</mi><mo>=</mo><mo stretchy=\"false\">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>t</mi><mi>s</mi><mo>âˆ’</mo><mfrac><mn>1</mn><mrow><mn>2</mn><mi>Î²</mi></mrow></mfrac><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">losses = (logits - \\frac{1}{2 \\beta})^2\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">osses</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">âˆ’</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.2019em;vertical-align:-0.8804em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3214em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8804em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span></p>\n<h2 id=\"æ¥æºæ ‡æ³¨\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ¥æºæ ‡æ³¨\"><span>æ¥æºæ ‡æ³¨</span></a></h2>\n<blockquote>\n<p>åŸå§‹å‡ºå¤„ï¼š<a href=\"https://arxiv.org/pdf/2310.12036v2.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">æ·±åº¦å­¦ä¹ æŸå¤±å‡½æ•°è§£æ</a></p>\n</blockquote>\n","env":{"base":"/","filePath":"/Users/qianyuhe/Desktop/my-project/docs/notes_bak/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/DPOç›´æ¥åå¥½ä¼˜åŒ–/æ·±åº¦åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰æŸå¤±å‡½æ•°è§£æä¸ä»£ç ç¤ºä¾‹.md","filePathRelative":"notes_bak/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/DPOç›´æ¥åå¥½ä¼˜åŒ–/æ·±åº¦åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰æŸå¤±å‡½æ•°è§£æä¸ä»£ç ç¤ºä¾‹.md","frontmatter":{"dg-publish":true,"dg-permalink":"/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/DPOç›´æ¥åå¥½ä¼˜åŒ–/æ·±åº¦åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰æŸå¤±å‡½æ•°è§£æä¸ä»£ç ç¤ºä¾‹","dg-home":false,"dg-description":"åœ¨æ­¤è¾“å…¥ç¬”è®°çš„æè¿°","dg-hide":false,"dg-hide-title":false,"dg-show-backlinks":true,"dg-show-local-graph":true,"dg-show-inline-title":true,"dg-pinned":false,"dg-passphrase":"åœ¨æ­¤è¾“å…¥è®¿é—®å¯†ç ","dg-enable-mathjax":false,"dg-enable-mermaid":false,"dg-enable-uml":false,"dg-note-icon":0,"dg-enable-dataview":false,"tags":["NLP"],"permalink":"/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/DPOç›´æ¥åå¥½ä¼˜åŒ–/æ·±åº¦åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰æŸå¤±å‡½æ•°è§£æä¸ä»£ç ç¤ºä¾‹/","dgShowBacklinks":true,"dgShowLocalGraph":true,"dgShowInlineTitle":true,"dgPassFrontmatter":true,"noteIcon":0,"created":"2025-04-22T14:40:01.000Z","updated":"2025-04-22T14:46:13.000Z","title":"æ·±åº¦åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰æŸå¤±å‡½æ•°è§£æä¸ä»£ç ç¤ºä¾‹","createTime":"2025/05/13 17:33:52"},"sfcBlocks":{"template":{"type":"template","content":"<template><h2 id=\"åˆ†ç±»\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#åˆ†ç±»\"><span>åˆ†ç±»</span></a></h2>\n<p>è‡ªåŠ¨æ¨æ–­</p>\n<h2 id=\"æ ‡ç­¾\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ‡ç­¾\"><span>æ ‡ç­¾</span></a></h2>\n<p>æ·±åº¦å­¦ä¹ , æŸå¤±å‡½æ•°, ä¼˜åŒ–ç®—æ³•, å¯¹æ¯”å­¦ä¹ , äººç±»åå¥½</p>\n<h2 id=\"æ—¥æœŸ\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ—¥æœŸ\"><span>æ—¥æœŸ</span></a></h2>\n<p>2025å¹´4æœˆ12æ—¥</p>\n<h2 id=\"å†…å®¹æ¦‚è¦\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å†…å®¹æ¦‚è¦\"><span>å†…å®¹æ¦‚è¦</span></a></h2>\n<p>æ·±åº¦åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰æ˜¯ä¸€ç§æ—¨åœ¨ä½¿æ¨¡å‹è¾“å‡ºä¸äººç±»åå¥½å¯¹é½çš„æŠ€æœ¯ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡å¯¹æ¯”å­¦ä¹ çš„æ–¹å¼ï¼Œä¼˜åŒ–æ¨¡å‹åœ¨é€‰æ‹©ä¸æ‹’ç»å›ç­”çš„æ¦‚ç‡å·®å¼‚ã€‚æœ¬æ–‡å°†è¯¦ç»†è§£æDPOæŸå¤±å‡½æ•°çš„åŸç†ï¼Œå¹¶æä¾›ç›¸å…³ä»£ç ç¤ºä¾‹ã€‚</p>\n<p><img src=\"/img/user/é™„ä»¶/Pasted image 20250422224044.png\" alt=\"Pasted image 20250422224044.png\">\n<img src=\"/img/user/é™„ä»¶/Pasted image 20250422224104.png\" alt=\"Pasted image 20250422224104.png\"><img src=\"/img/user/é™„ä»¶/Pasted image 20250422224109.png\" alt=\"Pasted image 20250422224109.png\"></p>\n<h2 id=\"ç†è§£dpoæŸå¤±å‡½æ•°\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ç†è§£dpoæŸå¤±å‡½æ•°\"><span>ç†è§£DPOæŸå¤±å‡½æ•°</span></a></h2>\n<p>DPOæŸå¤±å‡½æ•°çš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–åå¥½å›ç­”ä¸ä¸åå¥½å›ç­”ä¹‹é—´çš„æ¦‚ç‡å·®å€¼ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåå¥½å›ç­”çš„æ¦‚ç‡ä¼šå¢åŠ ï¼Œè€Œä¸åå¥½å›ç­”çš„æ¦‚ç‡ä¼šå‡å°‘ï¼Œä»è€Œå®ç°ä¸äººç±»åå¥½çš„å¯¹é½ã€‚</p>\n<p>ğŸ’¡å¯å‘ç‚¹ï¼šDPOé€šè¿‡çº¦æŸæ¦‚ç‡å·®å€¼è€Œéç»å¯¹æ¦‚ç‡ï¼Œæä¾›äº†çµæ´»çš„ä¼˜åŒ–æ–¹å¼ã€‚</p>\n<h2 id=\"æ ¸å¿ƒä»£ç è§£æ\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒä»£ç è§£æ\"><span>æ ¸å¿ƒä»£ç è§£æ</span></a></h2>\n<p>ä¸‹é¢æ˜¯DPOæŸå¤±å‡½æ•°çš„ä»£ç ç¤ºä¾‹ï¼š</p>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"--shiki-light:#2E8F82;--shiki-dark:#5DA994\"> DPOLoss</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">Module</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">    \"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">    DPO Loss</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">    \"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">    def</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> __init__</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beta</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> float</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> label_smoothing</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> float</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 0.0</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> ipo</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> bool</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> False</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> -></span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> None</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">        super</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">().</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">__init__</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">        self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beta</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">        self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">label_smoothing </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> label_smoothing</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">        self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">ipo </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> ipo</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">    def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> forward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        policy_chosen_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        policy_rejected_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        reference_chosen_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        reference_rejected_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    )</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> -></span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> Tuple</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        pi_logratios </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> policy_chosen_logps </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> policy_rejected_logps</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        ref_logratios </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reference_chosen_logps </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reference_rejected_logps</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        logits </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> pi_logratios </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> ref_logratios</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">ipo</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            losses </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logits </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> /</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">2</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> *</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">))</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> **</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 2</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        else</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            losses </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">                -</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">F</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logsigmoid</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> logits</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> *</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">label_smoothing</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">                -</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> F</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logsigmoid</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> logits</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> *</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">label_smoothing</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">            )</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        loss </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> losses</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">mean</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        chosen_rewards </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">policy_chosen_logps </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reference_chosen_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">).</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">detach</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        rejected_rewards </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">policy_rejected_logps </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reference_rejected_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">).</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">detach</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> loss</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> chosen_rewards</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> rejected_rewards</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2 id=\"æ“ä½œæ­¥éª¤\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ“ä½œæ­¥éª¤\"><span>æ“ä½œæ­¥éª¤</span></a></h2>\n<p>âœ… ç†è§£æŸå¤±å‡½æ•°å…¬å¼ï¼šé€šè¿‡å¯¹æ¯”å­¦ä¹ æœ€å¤§åŒ–æ¦‚ç‡å·®å€¼ã€‚</p>\n<p>âš  æ³¨æ„å‚æ•°è®¾ç½®ï¼š<span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Î²</mi></mrow><annotation encoding=\"application/x-tex\">\\beta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²</span></span></span></span> å’Œæ ‡ç­¾å¹³æ»‘å‚æ•°å¯èƒ½å½±å“ä¼˜åŒ–ç»“æœã€‚</p>\n<p>â— æ£€æŸ¥ä»£ç å®ç°ï¼šç¡®ä¿ä»£ç é€»è¾‘ä¸ç†è®ºä¸€è‡´ã€‚</p>\n<h2 id=\"å¸¸è§é”™è¯¯\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¸¸è§é”™è¯¯\"><span>å¸¸è§é”™è¯¯</span></a></h2>\n<blockquote>\n<p>è­¦å‘Šï¼šåœ¨å®è·µä¸­å¯èƒ½å‡ºç°é€‰æ‹©å’Œæ‹’ç»æ¦‚ç‡åŒæ—¶ä¸‹é™çš„æƒ…å†µï¼Œå› ä¸ºDPOä»…çº¦æŸå·®å€¼ã€‚</p>\n</blockquote>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ol>\n<li>æ¢ç´¢ä¸åŒçš„æ­£åˆ™åŒ–æ‰‹æ®µä»¥ä¼˜åŒ–DPOã€‚</li>\n<li>æµ‹è¯•ä¸åŒçš„ <span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Î²</mi></mrow><annotation encoding=\"application/x-tex\">\\beta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²</span></span></span></span> å€¼å¯¹æ¨¡å‹è¾“å‡ºçš„å½±å“ã€‚</li>\n<li>ç ”ç©¶å…¶ä»–å¯¹æ¯”å­¦ä¹ æ–¹æ³•ä¸DPOç»“åˆçš„æ•ˆæœã€‚</li>\n</ol>\n<h2 id=\"æ•°æ®è½¬æ¢\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ•°æ®è½¬æ¢\"><span>æ•°æ®è½¬æ¢</span></a></h2>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Î²</mi></mrow><annotation encoding=\"application/x-tex\">\\beta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²</span></span></span></span></td>\n<td>æ§åˆ¶æŸå¤±å‡½æ•°æ•æ„Ÿåº¦</td>\n</tr>\n<tr>\n<td>æ ‡ç­¾å¹³æ»‘</td>\n<td>å‡å°‘è¿‡æ‹Ÿåˆé£é™©</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"å…¬å¼æ˜¾ç¤º\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å…¬å¼æ˜¾ç¤º\"><span>å…¬å¼æ˜¾ç¤º</span></a></h2>\n<p>å…¬å¼åœ¨ä»£ç ä¸­ä½¿ç”¨ï¼š</p>\n<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi><mi>e</mi><mi>s</mi><mo>=</mo><mo stretchy=\"false\">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>t</mi><mi>s</mi><mo>âˆ’</mo><mfrac><mn>1</mn><mrow><mn>2</mn><mi>Î²</mi></mrow></mfrac><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">losses = (logits - \\frac{1}{2 \\beta})^2\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">osses</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">âˆ’</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.2019em;vertical-align:-0.8804em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3214em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8804em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span></p>\n<h2 id=\"æ¥æºæ ‡æ³¨\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ¥æºæ ‡æ³¨\"><span>æ¥æºæ ‡æ³¨</span></a></h2>\n<blockquote>\n<p>åŸå§‹å‡ºå¤„ï¼š<a href=\"https://arxiv.org/pdf/2310.12036v2.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">æ·±åº¦å­¦ä¹ æŸå¤±å‡½æ•°è§£æ</a></p>\n</blockquote>\n</template>","contentStripped":"<h2 id=\"åˆ†ç±»\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#åˆ†ç±»\"><span>åˆ†ç±»</span></a></h2>\n<p>è‡ªåŠ¨æ¨æ–­</p>\n<h2 id=\"æ ‡ç­¾\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ‡ç­¾\"><span>æ ‡ç­¾</span></a></h2>\n<p>æ·±åº¦å­¦ä¹ , æŸå¤±å‡½æ•°, ä¼˜åŒ–ç®—æ³•, å¯¹æ¯”å­¦ä¹ , äººç±»åå¥½</p>\n<h2 id=\"æ—¥æœŸ\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ—¥æœŸ\"><span>æ—¥æœŸ</span></a></h2>\n<p>2025å¹´4æœˆ12æ—¥</p>\n<h2 id=\"å†…å®¹æ¦‚è¦\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å†…å®¹æ¦‚è¦\"><span>å†…å®¹æ¦‚è¦</span></a></h2>\n<p>æ·±åº¦åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰æ˜¯ä¸€ç§æ—¨åœ¨ä½¿æ¨¡å‹è¾“å‡ºä¸äººç±»åå¥½å¯¹é½çš„æŠ€æœ¯ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡å¯¹æ¯”å­¦ä¹ çš„æ–¹å¼ï¼Œä¼˜åŒ–æ¨¡å‹åœ¨é€‰æ‹©ä¸æ‹’ç»å›ç­”çš„æ¦‚ç‡å·®å¼‚ã€‚æœ¬æ–‡å°†è¯¦ç»†è§£æDPOæŸå¤±å‡½æ•°çš„åŸç†ï¼Œå¹¶æä¾›ç›¸å…³ä»£ç ç¤ºä¾‹ã€‚</p>\n<p><img src=\"/img/user/é™„ä»¶/Pasted image 20250422224044.png\" alt=\"Pasted image 20250422224044.png\">\n<img src=\"/img/user/é™„ä»¶/Pasted image 20250422224104.png\" alt=\"Pasted image 20250422224104.png\"><img src=\"/img/user/é™„ä»¶/Pasted image 20250422224109.png\" alt=\"Pasted image 20250422224109.png\"></p>\n<h2 id=\"ç†è§£dpoæŸå¤±å‡½æ•°\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ç†è§£dpoæŸå¤±å‡½æ•°\"><span>ç†è§£DPOæŸå¤±å‡½æ•°</span></a></h2>\n<p>DPOæŸå¤±å‡½æ•°çš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–åå¥½å›ç­”ä¸ä¸åå¥½å›ç­”ä¹‹é—´çš„æ¦‚ç‡å·®å€¼ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåå¥½å›ç­”çš„æ¦‚ç‡ä¼šå¢åŠ ï¼Œè€Œä¸åå¥½å›ç­”çš„æ¦‚ç‡ä¼šå‡å°‘ï¼Œä»è€Œå®ç°ä¸äººç±»åå¥½çš„å¯¹é½ã€‚</p>\n<p>ğŸ’¡å¯å‘ç‚¹ï¼šDPOé€šè¿‡çº¦æŸæ¦‚ç‡å·®å€¼è€Œéç»å¯¹æ¦‚ç‡ï¼Œæä¾›äº†çµæ´»çš„ä¼˜åŒ–æ–¹å¼ã€‚</p>\n<h2 id=\"æ ¸å¿ƒä»£ç è§£æ\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒä»£ç è§£æ\"><span>æ ¸å¿ƒä»£ç è§£æ</span></a></h2>\n<p>ä¸‹é¢æ˜¯DPOæŸå¤±å‡½æ•°çš„ä»£ç ç¤ºä¾‹ï¼š</p>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"--shiki-light:#2E8F82;--shiki-dark:#5DA994\"> DPOLoss</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">Module</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">    \"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">    DPO Loss</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">    \"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">    def</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> __init__</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beta</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> float</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> label_smoothing</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> float</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 0.0</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> ipo</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> bool</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> False</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> -></span><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\"> None</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">        super</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">().</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">__init__</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">        self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> beta</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">        self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">label_smoothing </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> label_smoothing</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">        self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">ipo </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> ipo</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">    def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> forward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        policy_chosen_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        policy_rejected_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        reference_chosen_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        reference_rejected_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">    )</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> -></span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> Tuple</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        pi_logratios </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> policy_chosen_logps </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> policy_rejected_logps</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        ref_logratios </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reference_chosen_logps </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reference_rejected_logps</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        logits </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> pi_logratios </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> ref_logratios</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">ipo</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            losses </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logits </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> /</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">2</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> *</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">))</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> **</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 2</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        else</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">            losses </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">                -</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">F</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logsigmoid</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> logits</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> *</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">label_smoothing</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">                -</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> F</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">logsigmoid</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> logits</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> *</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">label_smoothing</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">            )</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        loss </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> losses</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">mean</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        chosen_rewards </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">policy_chosen_logps </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reference_chosen_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">).</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">detach</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">        rejected_rewards </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">beta </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">policy_rejected_logps </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">-</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> reference_rejected_logps</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">).</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">detach</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">        return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> loss</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> chosen_rewards</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> rejected_rewards</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2 id=\"æ“ä½œæ­¥éª¤\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ“ä½œæ­¥éª¤\"><span>æ“ä½œæ­¥éª¤</span></a></h2>\n<p>âœ… ç†è§£æŸå¤±å‡½æ•°å…¬å¼ï¼šé€šè¿‡å¯¹æ¯”å­¦ä¹ æœ€å¤§åŒ–æ¦‚ç‡å·®å€¼ã€‚</p>\n<p>âš  æ³¨æ„å‚æ•°è®¾ç½®ï¼š<span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Î²</mi></mrow><annotation encoding=\"application/x-tex\">\\beta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²</span></span></span></span> å’Œæ ‡ç­¾å¹³æ»‘å‚æ•°å¯èƒ½å½±å“ä¼˜åŒ–ç»“æœã€‚</p>\n<p>â— æ£€æŸ¥ä»£ç å®ç°ï¼šç¡®ä¿ä»£ç é€»è¾‘ä¸ç†è®ºä¸€è‡´ã€‚</p>\n<h2 id=\"å¸¸è§é”™è¯¯\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¸¸è§é”™è¯¯\"><span>å¸¸è§é”™è¯¯</span></a></h2>\n<blockquote>\n<p>è­¦å‘Šï¼šåœ¨å®è·µä¸­å¯èƒ½å‡ºç°é€‰æ‹©å’Œæ‹’ç»æ¦‚ç‡åŒæ—¶ä¸‹é™çš„æƒ…å†µï¼Œå› ä¸ºDPOä»…çº¦æŸå·®å€¼ã€‚</p>\n</blockquote>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ol>\n<li>æ¢ç´¢ä¸åŒçš„æ­£åˆ™åŒ–æ‰‹æ®µä»¥ä¼˜åŒ–DPOã€‚</li>\n<li>æµ‹è¯•ä¸åŒçš„ <span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Î²</mi></mrow><annotation encoding=\"application/x-tex\">\\beta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²</span></span></span></span> å€¼å¯¹æ¨¡å‹è¾“å‡ºçš„å½±å“ã€‚</li>\n<li>ç ”ç©¶å…¶ä»–å¯¹æ¯”å­¦ä¹ æ–¹æ³•ä¸DPOç»“åˆçš„æ•ˆæœã€‚</li>\n</ol>\n<h2 id=\"æ•°æ®è½¬æ¢\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ•°æ®è½¬æ¢\"><span>æ•°æ®è½¬æ¢</span></a></h2>\n<table>\n<thead>\n<tr>\n<th>å‚æ•°</th>\n<th>æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><span v-pre class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Î²</mi></mrow><annotation encoding=\"application/x-tex\">\\beta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²</span></span></span></span></td>\n<td>æ§åˆ¶æŸå¤±å‡½æ•°æ•æ„Ÿåº¦</td>\n</tr>\n<tr>\n<td>æ ‡ç­¾å¹³æ»‘</td>\n<td>å‡å°‘è¿‡æ‹Ÿåˆé£é™©</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"å…¬å¼æ˜¾ç¤º\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å…¬å¼æ˜¾ç¤º\"><span>å…¬å¼æ˜¾ç¤º</span></a></h2>\n<p>å…¬å¼åœ¨ä»£ç ä¸­ä½¿ç”¨ï¼š</p>\n<p v-pre class='katex-block'><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi><mi>e</mi><mi>s</mi><mo>=</mo><mo stretchy=\"false\">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>t</mi><mi>s</mi><mo>âˆ’</mo><mfrac><mn>1</mn><mrow><mn>2</mn><mi>Î²</mi></mrow></mfrac><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">losses = (logits - \\frac{1}{2 \\beta})^2\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">osses</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">âˆ’</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.2019em;vertical-align:-0.8804em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3214em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8804em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span></p>\n<h2 id=\"æ¥æºæ ‡æ³¨\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ¥æºæ ‡æ³¨\"><span>æ¥æºæ ‡æ³¨</span></a></h2>\n<blockquote>\n<p>åŸå§‹å‡ºå¤„ï¼š<a href=\"https://arxiv.org/pdf/2310.12036v2.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">æ·±åº¦å­¦ä¹ æŸå¤±å‡½æ•°è§£æ</a></p>\n</blockquote>\n","tagOpen":"<template>","tagClose":"</template>"},"script":null,"scriptSetup":null,"scripts":[],"styles":[],"customBlocks":[]},"content":"## åˆ†ç±»\nè‡ªåŠ¨æ¨æ–­\n\n\n\n## æ ‡ç­¾\næ·±åº¦å­¦ä¹ , æŸå¤±å‡½æ•°, ä¼˜åŒ–ç®—æ³•, å¯¹æ¯”å­¦ä¹ , äººç±»åå¥½\n\n\n\n## æ—¥æœŸ\n2025å¹´4æœˆ12æ—¥\n\n\n\n## å†…å®¹æ¦‚è¦\næ·±åº¦åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰æ˜¯ä¸€ç§æ—¨åœ¨ä½¿æ¨¡å‹è¾“å‡ºä¸äººç±»åå¥½å¯¹é½çš„æŠ€æœ¯ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡å¯¹æ¯”å­¦ä¹ çš„æ–¹å¼ï¼Œä¼˜åŒ–æ¨¡å‹åœ¨é€‰æ‹©ä¸æ‹’ç»å›ç­”çš„æ¦‚ç‡å·®å¼‚ã€‚æœ¬æ–‡å°†è¯¦ç»†è§£æDPOæŸå¤±å‡½æ•°çš„åŸç†ï¼Œå¹¶æä¾›ç›¸å…³ä»£ç ç¤ºä¾‹ã€‚\n\n![Pasted image 20250422224044.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250422224044.png)\n![Pasted image 20250422224104.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250422224104.png)![Pasted image 20250422224109.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250422224109.png)\n\n\n\n## ç†è§£DPOæŸå¤±å‡½æ•°\nDPOæŸå¤±å‡½æ•°çš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–åå¥½å›ç­”ä¸ä¸åå¥½å›ç­”ä¹‹é—´çš„æ¦‚ç‡å·®å€¼ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåå¥½å›ç­”çš„æ¦‚ç‡ä¼šå¢åŠ ï¼Œè€Œä¸åå¥½å›ç­”çš„æ¦‚ç‡ä¼šå‡å°‘ï¼Œä»è€Œå®ç°ä¸äººç±»åå¥½çš„å¯¹é½ã€‚\n\nğŸ’¡å¯å‘ç‚¹ï¼šDPOé€šè¿‡çº¦æŸæ¦‚ç‡å·®å€¼è€Œéç»å¯¹æ¦‚ç‡ï¼Œæä¾›äº†çµæ´»çš„ä¼˜åŒ–æ–¹å¼ã€‚\n\n\n\n## æ ¸å¿ƒä»£ç è§£æ\nä¸‹é¢æ˜¯DPOæŸå¤±å‡½æ•°çš„ä»£ç ç¤ºä¾‹ï¼š\n\n```python\nclass DPOLoss(nn.Module):\n    \"\"\"\n    DPO Loss\n    \"\"\"\n    def __init__(self, beta: float, label_smoothing: float = 0.0, ipo: bool = False) -> None:\n        super().__init__()\n        self.beta = beta\n        self.label_smoothing = label_smoothing\n        self.ipo = ipo\n\n    def forward(\n        self,\n        policy_chosen_logps: torch.Tensor,\n        policy_rejected_logps: torch.Tensor,\n        reference_chosen_logps: torch.Tensor,\n        reference_rejected_logps: torch.Tensor,\n    ) -> Tuple[torch.Tensor, torch.Tensor, torch.Tensor]:\n        pi_logratios = policy_chosen_logps - policy_rejected_logps\n        ref_logratios = reference_chosen_logps - reference_rejected_logps\n        logits = pi_logratios - ref_logratios\n\n        if self.ipo:\n            losses = (logits - 1 / (2 * self.beta)) ** 2\n        else:\n            losses = (\n                -F.logsigmoid(self.beta * logits) * (1 - self.label_smoothing)\n                - F.logsigmoid(-self.beta * logits) * self.label_smoothing\n            )\n\n        loss = losses.mean()\n        chosen_rewards = self.beta * (policy_chosen_logps - reference_chosen_logps).detach()\n        rejected_rewards = self.beta * (policy_rejected_logps - reference_rejected_logps).detach()\n\n        return loss, chosen_rewards, rejected_rewards\n```\n\n\n\n## æ“ä½œæ­¥éª¤\nâœ… ç†è§£æŸå¤±å‡½æ•°å…¬å¼ï¼šé€šè¿‡å¯¹æ¯”å­¦ä¹ æœ€å¤§åŒ–æ¦‚ç‡å·®å€¼ã€‚\n\nâš  æ³¨æ„å‚æ•°è®¾ç½®ï¼š$\\beta$ å’Œæ ‡ç­¾å¹³æ»‘å‚æ•°å¯èƒ½å½±å“ä¼˜åŒ–ç»“æœã€‚\n\nâ— æ£€æŸ¥ä»£ç å®ç°ï¼šç¡®ä¿ä»£ç é€»è¾‘ä¸ç†è®ºä¸€è‡´ã€‚\n\n\n\n## å¸¸è§é”™è¯¯\n> è­¦å‘Šï¼šåœ¨å®è·µä¸­å¯èƒ½å‡ºç°é€‰æ‹©å’Œæ‹’ç»æ¦‚ç‡åŒæ—¶ä¸‹é™çš„æƒ…å†µï¼Œå› ä¸ºDPOä»…çº¦æŸå·®å€¼ã€‚\n\n\n\n## è¡ŒåŠ¨æ¸…å•\n1. æ¢ç´¢ä¸åŒçš„æ­£åˆ™åŒ–æ‰‹æ®µä»¥ä¼˜åŒ–DPOã€‚\n2. æµ‹è¯•ä¸åŒçš„ $\\beta$ å€¼å¯¹æ¨¡å‹è¾“å‡ºçš„å½±å“ã€‚\n3. ç ”ç©¶å…¶ä»–å¯¹æ¯”å­¦ä¹ æ–¹æ³•ä¸DPOç»“åˆçš„æ•ˆæœã€‚\n\n\n\n## æ•°æ®è½¬æ¢\n| å‚æ•° | æè¿° |\n|------|------|\n| $\\beta$ | æ§åˆ¶æŸå¤±å‡½æ•°æ•æ„Ÿåº¦ |\n| æ ‡ç­¾å¹³æ»‘ | å‡å°‘è¿‡æ‹Ÿåˆé£é™© |\n\n\n\n## å…¬å¼æ˜¾ç¤º\nå…¬å¼åœ¨ä»£ç ä¸­ä½¿ç”¨ï¼š\n\n$$\nlosses = (logits - \\frac{1}{2 \\beta})^2\n$$\n\n\n\n## æ¥æºæ ‡æ³¨\n> åŸå§‹å‡ºå¤„ï¼š[æ·±åº¦å­¦ä¹ æŸå¤±å‡½æ•°è§£æ](https://arxiv.org/pdf/2310.12036v2.pdf)","excerpt":"","includedFiles":[],"tasklistId":0,"title":"","headers":[{"level":2,"title":"åˆ†ç±»","slug":"åˆ†ç±»","link":"#åˆ†ç±»","children":[]},{"level":2,"title":"æ ‡ç­¾","slug":"æ ‡ç­¾","link":"#æ ‡ç­¾","children":[]},{"level":2,"title":"æ—¥æœŸ","slug":"æ—¥æœŸ","link":"#æ—¥æœŸ","children":[]},{"level":2,"title":"å†…å®¹æ¦‚è¦","slug":"å†…å®¹æ¦‚è¦","link":"#å†…å®¹æ¦‚è¦","children":[]},{"level":2,"title":"ç†è§£DPOæŸå¤±å‡½æ•°","slug":"ç†è§£dpoæŸå¤±å‡½æ•°","link":"#ç†è§£dpoæŸå¤±å‡½æ•°","children":[]},{"level":2,"title":"æ ¸å¿ƒä»£ç è§£æ","slug":"æ ¸å¿ƒä»£ç è§£æ","link":"#æ ¸å¿ƒä»£ç è§£æ","children":[]},{"level":2,"title":"æ“ä½œæ­¥éª¤","slug":"æ“ä½œæ­¥éª¤","link":"#æ“ä½œæ­¥éª¤","children":[]},{"level":2,"title":"å¸¸è§é”™è¯¯","slug":"å¸¸è§é”™è¯¯","link":"#å¸¸è§é”™è¯¯","children":[]},{"level":2,"title":"è¡ŒåŠ¨æ¸…å•","slug":"è¡ŒåŠ¨æ¸…å•","link":"#è¡ŒåŠ¨æ¸…å•","children":[]},{"level":2,"title":"æ•°æ®è½¬æ¢","slug":"æ•°æ®è½¬æ¢","link":"#æ•°æ®è½¬æ¢","children":[]},{"level":2,"title":"å…¬å¼æ˜¾ç¤º","slug":"å…¬å¼æ˜¾ç¤º","link":"#å…¬å¼æ˜¾ç¤º","children":[]},{"level":2,"title":"æ¥æºæ ‡æ³¨","slug":"æ¥æºæ ‡æ³¨","link":"#æ¥æºæ ‡æ³¨","children":[]}]}}
