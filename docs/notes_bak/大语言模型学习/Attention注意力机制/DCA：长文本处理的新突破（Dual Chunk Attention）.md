---
dg-publish: true
dg-permalink: /å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /Attentionæ³¨æ„åŠ›æœºåˆ¶/DCAï¼šé•¿æ–‡æœ¬å¤„ç†çš„æ–°çªç ´ï¼ˆDual-Chunk-Attentionï¼‰
dg-home: false
dg-description: åœ¨æ­¤è¾“å…¥ç¬”è®°çš„æè¿°
dg-hide: false
dg-hide-title: false
dg-show-backlinks: true
dg-show-local-graph: true
dg-show-inline-title: true
dg-pinned: false
dg-passphrase: åœ¨æ­¤è¾“å…¥è®¿é—®å¯†ç 
dg-enable-mathjax: false
dg-enable-mermaid: false
dg-enable-uml: false
dg-note-icon: 0
dg-enable-dataview: false
tags:
  - NLP
permalink: /å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /Attentionæ³¨æ„åŠ›æœºåˆ¶/DCAï¼šé•¿æ–‡æœ¬å¤„ç†çš„æ–°çªç ´ï¼ˆDual-Chunk-Attentionï¼‰/
dgShowBacklinks: true
dgShowLocalGraph: true
dgShowInlineTitle: true
dgPassFrontmatter: true
noteIcon: 0
created: 2025-04-04T11:16:42.000+08:00
updated: 2025-04-13T13:06:02.000+08:00
title: DCAï¼šé•¿æ–‡æœ¬å¤„ç†çš„æ–°çªç ´ï¼ˆDual Chunk Attentionï¼‰
createTime: 2025/05/13 17:33:53
---



## å…ƒæ•°æ®  
- **åˆ†ç±»**ï¼šè‡ªç„¶è¯­è¨€å¤„ç† (NLP)  
- **æ ‡ç­¾**ï¼šé•¿æ–‡æœ¬å¤„ç†ã€æ³¨æ„åŠ›æœºåˆ¶ã€DCAã€æ·±åº¦å­¦ä¹ ã€Chunkæ¨¡å‹  
- **æ—¥æœŸ**ï¼š2024å¹´10æœˆ2æ—¥    

---



## ä»€ä¹ˆæ˜¯DCAï¼Ÿ  
Dual Chunk Attention (DCA) æ˜¯ä¸€ç§é’ˆå¯¹é•¿æ–‡æœ¬å¤„ç†çš„åˆ›æ–°æŠ€æœ¯ï¼Œé‡ç‚¹è§£å†³äº†ä¼ ç»Ÿæ³¨æ„åŠ›æœºåˆ¶åœ¨å¤„ç†é•¿æ–‡æœ¬æ—¶çš„è®¡ç®—æ•ˆç‡å’Œå†…å­˜å ç”¨é—®é¢˜ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†é•¿æ–‡æœ¬æ‹†åˆ†ä¸ºå¤šä¸ªå°å—ï¼Œå¹¶åˆ†åˆ«åœ¨å—å†…å’Œå—é—´åº”ç”¨æ³¨æ„åŠ›æœºåˆ¶ï¼Œä»è€Œå®ç°é«˜æ•ˆçš„å…¨å±€ä¿¡æ¯æ•æ‰ã€‚  

---



## æ ¸å¿ƒæ€æƒ³ä¸å®ç°  

### 1ï¸âƒ£ DCAçš„å·¥ä½œæµç¨‹  
âœ… **åˆ†å—å¤„ç†**ï¼šå°†é•¿æ–‡æœ¬åˆ†å‰²æˆè‹¥å¹²è¾ƒå°çš„â€œå—â€ï¼ˆchunksï¼‰ï¼Œæ¯ä¸ªå—åŒ…å«ä¸€éƒ¨åˆ†æ–‡æœ¬ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª2000è¯çš„æ–‡æœ¬å¯ä»¥åˆ†æˆ4ä¸ªï¼Œæ¯å—500è¯ã€‚  
âœ… **å—å†…æ³¨æ„åŠ›**ï¼šå•ç‹¬å¯¹æ¯ä¸ªå—åº”ç”¨æ³¨æ„åŠ›æœºåˆ¶ï¼Œæ¯ä¸ªå—å†…çš„å•è¯ä»…ä¸åŒå—å†…å…¶ä»–å•è¯äº¤äº’ï¼Œæ˜¾è‘—å‡å°‘è®¡ç®—é‡ã€‚  
âœ… **å—é—´æ³¨æ„åŠ›**ï¼šåœ¨å®Œæˆå—å†…æ³¨æ„åŠ›åï¼Œå—ä¹‹é—´é€šè¿‡å…¨å±€äº¤äº’æ•æ‰ä¸Šä¸‹æ–‡å…³ç³»ï¼Œå®ç°ä¿¡æ¯æ•´åˆã€‚  

---


### 2ï¸âƒ£ DCAä»£ç å®ç°  
ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•å®ç°ä¸¤ä¸ªå—ä¹‹é—´çš„è·¨å—æ³¨æ„åŠ›ï¼š

```python
# æŸ¥è¯¢å—
q_chunk = Q_chunks[:, i, :, :] 

# è®¡ç®—æŸ¥è¯¢å—ä¸é”®å—çš„æ³¨æ„åŠ›
attn_scores = torch.matmul(q_chunk, K_chunks.transpose(2, 3)) / (self.embed_size ** 0.5)
attn_probs = torch.nn.functional.softmax(attn_scores, dim=-1)

# æ³¨æ„åŠ›åŠ æƒåˆ°å€¼å—ä¸Š
cross_attn_out.append(torch.matmul(attn_probs, V_chunks[:, i, :, :]))

# æ‹¼æ¥è·¨å—æ³¨æ„åŠ›è¾“å‡º
cross_attn_out = torch.cat(cross_attn_out, dim=1)
return cross_attn_out
```

---


### ğŸ“ˆ æ•°æ®æ€»ç»“ä¸ä¼˜åŠ¿  
| ç‰¹æ€§           | æè¿°                                                                 |
|----------------|----------------------------------------------------------------------|
| **è®¡ç®—æ•ˆç‡**   | å—å†…æ³¨æ„åŠ›æ˜¾è‘—å‡å°‘è®¡ç®—å¤æ‚åº¦ï¼Œé€‚åˆå¤„ç†è¶…é•¿æ–‡æœ¬ã€‚                     |
| **å†…å­˜å ç”¨**   | åˆ†å—å¤„ç†é™ä½äº†æ˜¾å­˜éœ€æ±‚ï¼Œä¼˜åŒ–äº†èµ„æºä½¿ç”¨ã€‚                             |
| **å…¨å±€ä¿¡æ¯æ•æ‰**| å—é—´æ³¨æ„åŠ›ç¡®ä¿æ¨¡å‹ä»èƒ½ç†è§£æ•´ä½“ä¸Šä¸‹æ–‡å…³ç³»ã€‚                          |

ğŸ’¡ **å¯å‘ç‚¹**ï¼šè¿™ç§åˆ†å—ä¸è·¨å—ç»“åˆçš„æ–¹æ³•ä¸ºé•¿æ–‡æœ¬å¤„ç†å¼€è¾Ÿäº†æ–°æ–¹å‘ï¼Œå°¤å…¶é€‚ç”¨äºè¶…é•¿è¾“å…¥åœºæ™¯ï¼ˆå¦‚æ³•å¾‹æ–‡æœ¬ã€åŒ»å­¦æ–‡çŒ®ç­‰ï¼‰ã€‚  

---



## å¸¸è§é”™è¯¯  
âš ï¸ **åˆ†å—ç­–ç•¥ä¸åˆç†**ï¼šå¦‚æœåˆ†å—æ–¹å¼å¯¼è‡´è¯­ä¹‰æ–­è£‚ï¼Œä¼šå½±å“è·¨å—æ³¨æ„åŠ›æ•ˆæœã€‚  
âš ï¸ **è¶…å‚æ•°è®¾ç½®é—®é¢˜**ï¼šä¾‹å¦‚å—å¤§å°é€‰æ‹©ä¸å½“å¯èƒ½å¯¼è‡´è®¡ç®—æ•ˆç‡ä¸‹é™æˆ–ä¿¡æ¯ä¸¢å¤±ã€‚  

---



## è¡ŒåŠ¨æ¸…å•  
- ğŸ” æ¢ç´¢ä¸åŒåˆ†å—ç®—æ³•å¯¹DCAæ€§èƒ½çš„å½±å“ã€‚  
- ğŸ§ª åœ¨ç‰¹å®šé¢†åŸŸï¼ˆå¦‚æ³•å¾‹ã€åŒ»å­¦ï¼‰æµ‹è¯•DCAçš„åº”ç”¨æ½œåŠ›ã€‚  
- ğŸš€ ä¼˜åŒ–è·¨å—æ³¨æ„åŠ›çš„è®¡ç®—æ•ˆç‡ï¼Œå°è¯•å¼•å…¥ç¨€ç–çŸ©é˜µæŠ€æœ¯ã€‚  

---



## [æ€è€ƒ] å»¶ä¼¸é—®é¢˜  
1. å¦‚ä½•è¿›ä¸€æ­¥ä¼˜åŒ–å—é—´æ³¨æ„åŠ›ï¼Œä½¿å…¶åœ¨ä¿è¯ä¿¡æ¯å®Œæ•´æ€§çš„åŒæ—¶é™ä½è®¡ç®—æˆæœ¬ï¼Ÿ  
2. æ˜¯å¦å¯ä»¥ç»“åˆå…¶ä»–æ¨¡å‹ï¼ˆå¦‚Transformerï¼‰çš„ç‰¹æ€§ï¼Œå¢å¼ºDCAåœ¨é•¿æ–‡æœ¬ä¸Šçš„è¡¨ç°ï¼Ÿ  
3. åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒDCAæ˜¯å¦èƒ½æ›¿ä»£ä¼ ç»Ÿé•¿æ–‡æœ¬å¤„ç†æ–¹å¼ï¼Ÿå…¶å±€é™æ€§åœ¨å“ªé‡Œï¼Ÿ  

---



## åç»­è¿½è¸ªç ”ç©¶è®¡åˆ’  
- ğŸ“š **ç ”ç©¶æ–¹å‘**ï¼šæ·±å…¥æ¢ç´¢DCAåœ¨ä¸åŒé¢†åŸŸï¼ˆå¦‚æœºå™¨ç¿»è¯‘ã€é—®ç­”ç³»ç»Ÿï¼‰çš„é€‚é…æ€§ã€‚  
- ğŸŒ **å®éªŒç›®æ ‡**ï¼šéªŒè¯DCAåœ¨è¶…é•¿æ–‡æœ¬åœºæ™¯ä¸­æ˜¯å¦èƒ½æ˜¾è‘—æå‡æ¨¡å‹è¡¨ç°ï¼ŒåŒæ—¶é™ä½èµ„æºæ¶ˆè€—ã€‚  
- ğŸ› ï¸ **å·¥å…·é€‰æ‹©**ï¼šç»“åˆPyTorchå’ŒHugging Faceæ¡†æ¶ï¼Œå¼€å‘æ›´é«˜æ•ˆçš„DCAå®ç°ã€‚  

---

> åŸå§‹å‡ºå¤„ï¼š[Training-Free Long-Context Scaling of Large Language Models](https://arxiv.org/pdf/2402.17463)  
> å®˜æ–¹ä»£ç é“¾æ¥ï¼š[ChunkLlama GitHubä»“åº“](https://github.com/HKUNLP/ChunkLlama/blob/main/chunkqwen_attn_replace.py)
