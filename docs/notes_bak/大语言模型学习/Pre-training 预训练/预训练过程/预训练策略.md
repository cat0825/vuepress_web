---
dg-publish: true
dg-permalink: /å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /Pre-training-é¢„è®­ç»ƒ/é¢„è®­ç»ƒè¿‡ç¨‹/é¢„è®­ç»ƒç­–ç•¥
dg-home: false
dg-description: åœ¨æ­¤è¾“å…¥ç¬”è®°çš„æè¿°
dg-hide: false
dg-hide-title: false
dg-show-backlinks: true
dg-show-local-graph: true
dg-show-inline-title: true
dg-pinned: false
dg-passphrase: åœ¨æ­¤è¾“å…¥è®¿é—®å¯†ç 
dg-enable-mathjax: false
dg-enable-mermaid: false
dg-enable-uml: false
dg-note-icon: 0
dg-enable-dataview: false
tags:
  - NLP
permalink: /å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /Pre-training-é¢„è®­ç»ƒ/é¢„è®­ç»ƒè¿‡ç¨‹/é¢„è®­ç»ƒç­–ç•¥/
dgShowBacklinks: true
dgShowLocalGraph: true
dgShowInlineTitle: true
dgPassFrontmatter: true
noteIcon: 0
created: 2025-04-09T22:02:28.000+08:00
updated: 2025-04-13T13:06:02.000+08:00
title: é¢„è®­ç»ƒç­–ç•¥
createTime: 2025/05/13 17:33:53
---



## å…ƒæ•°æ®
- åˆ†ç±»ï¼šæ·±åº¦å­¦ä¹ 
- æ ‡ç­¾ï¼šé¢„è®­ç»ƒç­–ç•¥ï¼Œå­¦ä¹ ç‡è°ƒåº¦ï¼Œæ¨¡å‹ä¼˜åŒ–
- æ—¥æœŸï¼š2023å¹´10æœˆ25æ—¥

---



## æ ¸å¿ƒè§‚ç‚¹æ€»ç»“
åœ¨æ·±åº¦å­¦ä¹ æ¨¡å‹çš„é¢„è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä¼˜åŒ–ç­–ç•¥è‡³å…³é‡è¦ã€‚æœ¬æ–‡æ¢è®¨äº†å¦‚ä½•é€šè¿‡è°ƒæ•´ **batch_size**ã€é‡‡ç”¨ **WSDè°ƒåº¦å™¨** å’Œ **é¢„è®­ç»ƒTrick** æ¥æå‡æ¨¡å‹è®­ç»ƒæ•ˆç‡ï¼ŒåŒæ—¶æ€»ç»“äº†å››é˜¶æ®µé¢„è®­ç»ƒè®¾ç½®çš„å…·ä½“æµç¨‹ã€‚

---



## é‡ç‚¹å†…å®¹

### æœ€ä¼˜ Batch Size çš„é€‰æ‹©
- **å…³é”®ç‚¹**ï¼šBatch size å½±å“æ¨¡å‹æ”¶æ•›é€Ÿåº¦ä¸èµ„æºæ¶ˆè€—çš„å¹³è¡¡ã€‚
- æ•°æ®å®éªŒè¡¨æ˜ï¼š
  - Batch size è¿‡å¤§ï¼Œæ•°æ®å’Œè®¡ç®—é‡å¢åŠ ã€‚
  - Batch size è¿‡å°ï¼Œè®­ç»ƒæ­¥æ•°å¢å¤šä¸”æŸå¤±å‡½æ•°ä¸‹é™å—é™ã€‚
- C4 Loss çš„è§„å¾‹å…¬å¼ï¼š
  $$
  BS = L \cdot 6.2393 / (1.2110 \times 10^9)
  $$
- ![Pasted image 20250409220613.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250409220613.png)


### WSD è°ƒåº¦å™¨çš„ä¸‰é˜¶æ®µå­¦ä¹ ç‡ç­–ç•¥
- **åˆ†é˜¶æ®µç‰¹ç‚¹**ï¼š
  1. **å¿«é€Ÿæ”¶æ•›é˜¶æ®µ**ï¼ˆWarmupï¼‰ï¼šå­¦ä¹ ç‡çº¿æ€§ä¸Šå‡ã€‚
  2. **ç¨³å®šé˜¶æ®µ**ï¼ˆStableï¼‰ï¼šä¿æŒæœ€å¤§å­¦ä¹ ç‡ã€‚
  3. **é€€ç«é˜¶æ®µ**ï¼ˆDecayï¼‰ï¼šé‡‡ç”¨ä½™å¼¦é€€ç«ç®—æ³•é€æ­¥é™ä½å­¦ä¹ ç‡ã€‚
- å­¦ä¹ ç‡å…¬å¼ï¼š
  $$
  lr(s) =
  \begin{cases} 
    \frac{s}{W} \cdot \eta, & s < W \\ 
    \eta, & W \leq s < S \\ 
    f(s - S) \cdot \eta, & S \leq s < S + D
  \end{cases}
  $$
  - $$\eta$$ï¼šæœ€å¤§å­¦ä¹ ç‡  
  - $$f(s - S)$$ï¼šå…³äº $$s$$ çš„å‡å‡½æ•°ï¼ŒèŒƒå›´ $$0 < f(s - S) \leq 1$$


### æé«˜æ•ˆç‡çš„é¢„è®­ç»ƒæŠ€å·§
- **æ˜¾å­˜ä¼˜åŒ–**ï¼š
  - è‹¥æ˜¾å­˜å……è¶³ï¼Œå°½é‡é¿å…å¼•å…¥å¤æ‚å¹¶è¡ŒæŠ€æœ¯ï¼ˆå¦‚ tensor_parallelï¼‰ã€‚
  - ä¸å¼€å¯ **offload** å’Œ **é‡ç®—** å¯èŠ‚çœæ—¶é—´ã€‚
- **æŒ‡ä»¤æ•°æ®**ï¼š
  - åŠ å…¥æ›´å¤šæŒ‡ä»¤æ•°æ®æœ‰åŠ©äºæå‡æ¨¡å‹æ€§èƒ½ã€‚

---



## âœ… å››é˜¶æ®µé¢„è®­ç»ƒè®¾ç½®æµç¨‹
1. **Warmup é˜¶æ®µ**ï¼š
   - å­¦ä¹ ç‡ç¼“æ…¢ä¸Šå‡åˆ°æœ€å¤§å€¼ã€‚
2. **ä¸­æœŸç¨³å®šé˜¶æ®µ**ï¼š
   - ä½¿ç”¨è¾ƒå¤§çš„å­¦ä¹ ç‡ï¼Œæ˜¯å¦å¼•å…¥è¡°å‡éœ€è§†å®éªŒè€Œå®šã€‚
3. **åæœŸé€‚åº”é˜¶æ®µ**ï¼š
   - æ”¹å˜ RoPE çš„ base é¢‘ç‡ï¼Œå¢åŠ æ–‡æœ¬é•¿åº¦ï¼Œè®©æ¨¡å‹é€‚åº”é•¿æ–‡æœ¬ä»»åŠ¡ã€‚
4. **æ”¶å°¾é€€ç«é˜¶æ®µ**ï¼š
   - ä½¿ç”¨é«˜è´¨é‡æ•°æ®ï¼ˆå¦‚ IFT æ•°æ®ï¼‰å¼ºåŒ–æ¨¡å‹èƒ½åŠ›ï¼Œä¸º benchmark æµ‹è¯•åšå‡†å¤‡ã€‚

---



## âš  å¸¸è§é”™è¯¯ä¸æ³¨æ„äº‹é¡¹
> **è­¦å‘ŠåŒºå—**  
- å¿½è§† batch size å¯¹è®­ç»ƒæ•ˆç‡çš„å½±å“ï¼Œå¯èƒ½å¯¼è‡´èµ„æºæµªè´¹æˆ–æ€§èƒ½ä¸è¶³ã€‚  
- åœ¨æ˜¾å­˜ä¸è¶³æ—¶å¼ºè¡Œå¼•å…¥å¤æ‚å¹¶è¡ŒæŠ€æœ¯ï¼Œå¯èƒ½å¼•å‘è°ƒè¯•å›°éš¾å’Œæ€§èƒ½ä¸‹é™ã€‚

---



## ğŸ“ˆ è¶‹åŠ¿é¢„æµ‹
æœªæ¥é¢„è®­ç»ƒç­–ç•¥å¯èƒ½ä¼šæ›´åŠ æ³¨é‡ä»¥ä¸‹æ–¹å‘ï¼š
1. è‡ªåŠ¨åŒ–è°ƒå‚å·¥å…·çš„æ™®åŠï¼Œå‡å°‘äººå·¥è°ƒæ•´æˆæœ¬ã€‚
2. æ›´æ™ºèƒ½çš„æ•°æ®é‡‡æ ·æ–¹æ³•ï¼Œæå‡é«˜è´¨é‡æ•°æ®ä½¿ç”¨æ¯”ä¾‹ã€‚
3. å¤šæ¨¡å‹ååŒè®­ç»ƒç­–ç•¥ï¼ˆå¦‚å¤šä»»åŠ¡è”åˆè®­ç»ƒï¼‰çš„è¿›ä¸€æ­¥å‘å±•ã€‚

---



## [æ€è€ƒ] å»¶ä¼¸é—®é¢˜
1. å¦‚ä½•åœ¨ä¸åŒç¡¬ä»¶æ¡ä»¶ä¸‹çµæ´»è°ƒæ•´ batch size å’Œå­¦ä¹ ç‡ï¼Ÿ
2. æ˜¯å¦å­˜åœ¨æ›´é«˜æ•ˆçš„è°ƒåº¦å™¨æ›¿ä»£ WSD è°ƒåº¦å™¨ï¼Ÿ
3. é•¿æ–‡æœ¬é€‚åº”æ€§ä¼˜åŒ–æ˜¯å¦èƒ½è¿ç§»è‡³å¤šæ¨¡æ€ä»»åŠ¡ä¸­ï¼Ÿ

---

> åŸæ–‡å‡ºå¤„ï¼šæ·±åº¦å­¦ä¹ é¢„è®­ç»ƒç­–ç•¥æ–‡æ¡£

---



## è¡ŒåŠ¨æ¸…å•
- [ ] å®éªŒä¸åŒ batch size å¯¹å°æ¨¡å‹çš„å½±å“ã€‚
- [ ] æµ‹è¯• WSD è°ƒåº¦å™¨ä¸ä½™å¼¦é€€ç«ç®—æ³•åœ¨å¤§è§„æ¨¡ä»»åŠ¡ä¸­çš„æ€§èƒ½å·®å¼‚ã€‚
- [ ] æ¢ç´¢é«˜æ•ˆçš„æ˜¾å­˜ç®¡ç†æŠ€æœ¯ä»¥æ”¯æŒæ›´å¤§è§„æ¨¡çš„é¢„è®­ç»ƒã€‚
