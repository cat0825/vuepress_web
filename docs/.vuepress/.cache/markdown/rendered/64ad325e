{"content":"<p>å…ƒæ•°æ®ï¼š</p>\n<p>åˆ†ç±»ï¼šè‡ªç„¶è¯­è¨€å¤„ç†</p>\n<p>æ ‡ç­¾ï¼šP-Tuning V2, è‡ªç„¶è¯­è¨€ç†è§£, æç¤ºä¼˜åŒ–</p>\n<p>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</p>\n<h2 id=\"æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\"><span>æ ¸å¿ƒè§‚ç‚¹æ€»ç»“</span></a></h2>\n<p>P-Tuning V2 æ˜¯ä¸€ç§æ”¹è¿›çš„æç¤ºä¼˜åŒ–æŠ€æœ¯ï¼Œæ—¨åœ¨è§£å†³ä¹‹å‰æ–¹æ³•ä¸­å­˜åœ¨çš„æ¨¡å‹å‚æ•°è§„æ¨¡å’Œä»»åŠ¡é€šç”¨æ€§é—®é¢˜ã€‚é€šè¿‡åœ¨æ¯ä¸€å±‚åŠ å…¥æç¤ºï¼ˆPromptsï¼‰è€Œä¸ä»…ä»…æ˜¯è¾“å…¥å±‚ï¼ŒP-Tuning V2 æä¾›äº†æ›´å¤šå¯å­¦ä¹ çš„å‚æ•°ï¼Œå¹¶èƒ½æ›´ç›´æ¥å½±å“æ¨¡å‹é¢„æµ‹ã€‚ğŸ’¡è¿™ä½¿å¾—æç¤ºä¼˜åŒ–åœ¨è¾ƒå°æ¨¡å‹å’Œå¤šä»»åŠ¡å­¦ä¹ ä¸­è¡¨ç°æ›´ä¸ºä¼˜å¼‚ã€‚</p>\n<h2 id=\"é‡ç‚¹æ®µè½\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#é‡ç‚¹æ®µè½\"><span>é‡ç‚¹æ®µè½</span></a></h2>\n<ol>\n<li>\n<p><strong>ç¼ºä¹æ¨¡å‹å‚æ•°è§„æ¨¡å’Œä»»åŠ¡é€šç”¨æ€§</strong><br>\nä¹‹å‰çš„æç¤ºä¼˜åŒ–æ–¹æ³•åœ¨å¤§è§„æ¨¡æ¨¡å‹ä¸­è¡¨ç°è‰¯å¥½ï¼Œä½†åœ¨è¾ƒå°æ¨¡å‹ï¼ˆ100Måˆ°1Bå‚æ•°ï¼‰ä¸Šä¸å…¨é‡å¾®è°ƒå·®å¼‚æ˜¾è‘—ï¼Œé™åˆ¶äº†å…¶é€‚ç”¨æ€§ã€‚</p>\n</li>\n<li>\n<p><strong>æ·±åº¦æç¤ºä¼˜åŒ–çš„å¼•å…¥</strong><br>\nåœ¨æ¯ä¸€å±‚åŠ å…¥æç¤ºä»¤å¯å­¦ä¹ å‚æ•°å¢åŠ ï¼Œä»è€Œæå‡äº†å‚æ•°æ•ˆç‡å’Œæ¨¡å‹é¢„æµ‹çš„ç›´æ¥å½±å“ã€‚</p>\n</li>\n<li>\n<p><strong>å¤šä»»åŠ¡å­¦ä¹ å’Œæç¤ºé•¿åº¦ä¼˜åŒ–</strong><br>\né’ˆå¯¹ä¸åŒä»»åŠ¡é‡‡ç”¨ä¸åŒæç¤ºé•¿åº¦ï¼Œå¹¶é€šè¿‡å¤šä»»åŠ¡å­¦ä¹ è¿›è¡Œé¢„è®­ç»ƒï¼Œä»¥ç¼“è§£ä¼˜åŒ–å›°éš¾ã€‚</p>\n</li>\n</ol>\n<h2 id=\"æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°\"><span>æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°</span></a></h2>\n<ul>\n<li><strong>æç¤ºä¼˜åŒ–ï¼ˆPrompt Tuningï¼‰</strong>ï¼šä¸€ç§é€šè¿‡åœ¨è¾“å…¥ä¸­æ’å…¥ç‰¹æ®Šæç¤ºæ¥å¼•å¯¼æ¨¡å‹å­¦ä¹ çš„æŠ€æœ¯ã€‚</li>\n<li><strong>å…¨é‡å¾®è°ƒ</strong>ï¼šå¯¹æ•´ä¸ªæ¨¡å‹è¿›è¡Œå‚æ•°è°ƒæ•´ä»¥æé«˜æ€§èƒ½çš„æ–¹æ³•ã€‚</li>\n<li><strong>å¤šä»»åŠ¡å­¦ä¹ </strong>ï¼šåŒæ—¶å­¦ä¹ å¤šä¸ªç›¸å…³ä»»åŠ¡ï¼Œä»¥æé«˜æ¨¡å‹åœ¨å„ä¸ªä»»åŠ¡ä¸Šçš„è¡¨ç°ã€‚</li>\n</ul>\n<h2 id=\"å®æ–½æ­¥éª¤\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å®æ–½æ­¥éª¤\"><span>å®æ–½æ­¥éª¤</span></a></h2>\n<ol>\n<li>âœ… åœ¨æ¯ä¸€å±‚åŠ å…¥ Prompts tokens ä½œä¸ºè¾“å…¥ã€‚</li>\n<li>âš  ç§»é™¤é‡å‚æ•°åŒ–çš„ç¼–ç å™¨ä»¥æé«˜è®­ç»ƒé€Ÿåº¦å’Œé²æ£’æ€§ã€‚</li>\n<li>â— é’ˆå¯¹ä¸åŒä»»åŠ¡é€‰æ‹©åˆé€‚çš„æç¤ºé•¿åº¦ã€‚</li>\n<li>âœ… å¼•å…¥å¤šä»»åŠ¡å­¦ä¹ è¿›è¡Œé¢„è®­ç»ƒã€‚\n<img src=\"/img/user/é™„ä»¶/Pasted image 20250424105959.png\" alt=\"Pasted image 20250424105959.png\"></li>\n</ol>\n<h2 id=\"ä»£ç å®ç°\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ä»£ç å®ç°\"><span>ä»£ç å®ç°</span></a></h2>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\">#è®¾ç½®virtual_tokençš„æ•°é‡åŠpast_key_valuesç»´åº¦</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prompt_tokens </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> prompt_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[:,</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_virtual_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">past_key_values </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> past_key_values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">view</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_virtual_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_layers </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> ,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_attention_heads</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">token_dim </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">//</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_attention_heads</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># prefix encoderç±»çš„å®šä¹‰</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"--shiki-light:#2E8F82;--shiki-dark:#5DA994\"> PrefixEncoder</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">Module</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">The torch.nn model to encode the prefix Input shape: (batch-size, prefix-length) Output shape: (batch-size, prefix-length, 2*layers*hidden) </span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">def</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> __init__</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> ChatGLMConfig </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">super</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> ().</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">__init__</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_projection </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_projection</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># self.prefix_projection=True-->prefix tuning</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># self.prefix_projection=False-->p-tuning v2</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_projection</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># Use a two-layer MLP to encode the prefix</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">kv_size </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_layers </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">kv_channels </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">multi_query_group_num </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 2</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">embedding </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">pre_seq_len</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> kv_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">trans </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Sequential</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Linear</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">kv_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">hidden_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tanh</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Linear</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">hidden_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> kv_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">else</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">embedding </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">pre_seq_len</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_layers </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">kv_channels </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">multi_query_group_num </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> )</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> forward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> prefix</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_projection</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_tokens </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">past_key_values </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">trans</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">else</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">past_key_values </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> past_key_values</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2 id=\"å¸¸è§é”™è¯¯\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¸¸è§é”™è¯¯\"><span>å¸¸è§é”™è¯¯</span></a></h2>\n<blockquote>\n<p>âš  ä½¿ç”¨ä¸åˆé€‚çš„æç¤ºé•¿åº¦å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ç¡®ä¿æ ¹æ®å…·ä½“ä»»åŠ¡è°ƒæ•´æç¤ºé•¿åº¦ã€‚</p>\n</blockquote>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ul>\n<li>ç ”ç©¶å¦‚ä½•åœ¨ç°æœ‰é¡¹ç›®ä¸­é›†æˆ P-Tuning V2ã€‚</li>\n<li>é’ˆå¯¹ç‰¹å®šä»»åŠ¡æµ‹è¯•ä¸åŒçš„æç¤ºé•¿åº¦ã€‚</li>\n<li>æ¢ç´¢å¤šä»»åŠ¡å­¦ä¹ åœ¨å…¶ä»–é¢†åŸŸçš„åº”ç”¨æ½œåŠ›ã€‚</li>\n</ul>\n<blockquote>\n<p>æ¥æºï¼šæœ¬æ–‡å†…å®¹æ¥æºäºå¯¹ P-Tuning V2 æŠ€æœ¯çš„æ€»ç»“ä¸åˆ†æã€‚</p>\n</blockquote>\n","env":{"base":"/","filePath":"/Users/qianyuhe/Desktop/my-project/docs/notes_bak/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/PEFTå‚æ•°é«˜æ•ˆå¾®è°ƒ/P-Tuning V2 2.md","filePathRelative":"notes_bak/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/PEFTå‚æ•°é«˜æ•ˆå¾®è°ƒ/P-Tuning V2 2.md","frontmatter":{"dg-publish":true,"dg-permalink":"/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/PEFTå‚æ•°é«˜æ•ˆå¾®è°ƒ/P-Tuning-V2","dg-home":false,"dg-description":"åœ¨æ­¤è¾“å…¥ç¬”è®°çš„æè¿°","dg-hide":false,"dg-hide-title":false,"dg-show-backlinks":true,"dg-show-local-graph":true,"dg-show-inline-title":true,"dg-pinned":false,"dg-passphrase":"åœ¨æ­¤è¾“å…¥è®¿é—®å¯†ç ","dg-enable-mathjax":false,"dg-enable-mermaid":false,"dg-enable-uml":false,"dg-note-icon":0,"dg-enable-dataview":false,"tags":["NLP"],"permalink":"/å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ /RLå¼ºåŒ–å­¦ä¹ åŸºç¡€/PEFTå‚æ•°é«˜æ•ˆå¾®è°ƒ/P-Tuning-V2/","dgShowBacklinks":true,"dgShowLocalGraph":true,"dgShowInlineTitle":true,"dgPassFrontmatter":true,"noteIcon":0,"created":"2025-04-23T14:55:47.000Z","updated":"2025-04-24T03:10:28.000Z","title":"P-Tuning V2","createTime":"2025/05/13 17:33:52"},"sfcBlocks":{"template":{"type":"template","content":"<template><p>å…ƒæ•°æ®ï¼š</p>\n<p>åˆ†ç±»ï¼šè‡ªç„¶è¯­è¨€å¤„ç†</p>\n<p>æ ‡ç­¾ï¼šP-Tuning V2, è‡ªç„¶è¯­è¨€ç†è§£, æç¤ºä¼˜åŒ–</p>\n<p>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</p>\n<h2 id=\"æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\"><span>æ ¸å¿ƒè§‚ç‚¹æ€»ç»“</span></a></h2>\n<p>P-Tuning V2 æ˜¯ä¸€ç§æ”¹è¿›çš„æç¤ºä¼˜åŒ–æŠ€æœ¯ï¼Œæ—¨åœ¨è§£å†³ä¹‹å‰æ–¹æ³•ä¸­å­˜åœ¨çš„æ¨¡å‹å‚æ•°è§„æ¨¡å’Œä»»åŠ¡é€šç”¨æ€§é—®é¢˜ã€‚é€šè¿‡åœ¨æ¯ä¸€å±‚åŠ å…¥æç¤ºï¼ˆPromptsï¼‰è€Œä¸ä»…ä»…æ˜¯è¾“å…¥å±‚ï¼ŒP-Tuning V2 æä¾›äº†æ›´å¤šå¯å­¦ä¹ çš„å‚æ•°ï¼Œå¹¶èƒ½æ›´ç›´æ¥å½±å“æ¨¡å‹é¢„æµ‹ã€‚ğŸ’¡è¿™ä½¿å¾—æç¤ºä¼˜åŒ–åœ¨è¾ƒå°æ¨¡å‹å’Œå¤šä»»åŠ¡å­¦ä¹ ä¸­è¡¨ç°æ›´ä¸ºä¼˜å¼‚ã€‚</p>\n<h2 id=\"é‡ç‚¹æ®µè½\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#é‡ç‚¹æ®µè½\"><span>é‡ç‚¹æ®µè½</span></a></h2>\n<ol>\n<li>\n<p><strong>ç¼ºä¹æ¨¡å‹å‚æ•°è§„æ¨¡å’Œä»»åŠ¡é€šç”¨æ€§</strong><br>\nä¹‹å‰çš„æç¤ºä¼˜åŒ–æ–¹æ³•åœ¨å¤§è§„æ¨¡æ¨¡å‹ä¸­è¡¨ç°è‰¯å¥½ï¼Œä½†åœ¨è¾ƒå°æ¨¡å‹ï¼ˆ100Måˆ°1Bå‚æ•°ï¼‰ä¸Šä¸å…¨é‡å¾®è°ƒå·®å¼‚æ˜¾è‘—ï¼Œé™åˆ¶äº†å…¶é€‚ç”¨æ€§ã€‚</p>\n</li>\n<li>\n<p><strong>æ·±åº¦æç¤ºä¼˜åŒ–çš„å¼•å…¥</strong><br>\nåœ¨æ¯ä¸€å±‚åŠ å…¥æç¤ºä»¤å¯å­¦ä¹ å‚æ•°å¢åŠ ï¼Œä»è€Œæå‡äº†å‚æ•°æ•ˆç‡å’Œæ¨¡å‹é¢„æµ‹çš„ç›´æ¥å½±å“ã€‚</p>\n</li>\n<li>\n<p><strong>å¤šä»»åŠ¡å­¦ä¹ å’Œæç¤ºé•¿åº¦ä¼˜åŒ–</strong><br>\né’ˆå¯¹ä¸åŒä»»åŠ¡é‡‡ç”¨ä¸åŒæç¤ºé•¿åº¦ï¼Œå¹¶é€šè¿‡å¤šä»»åŠ¡å­¦ä¹ è¿›è¡Œé¢„è®­ç»ƒï¼Œä»¥ç¼“è§£ä¼˜åŒ–å›°éš¾ã€‚</p>\n</li>\n</ol>\n<h2 id=\"æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°\"><span>æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°</span></a></h2>\n<ul>\n<li><strong>æç¤ºä¼˜åŒ–ï¼ˆPrompt Tuningï¼‰</strong>ï¼šä¸€ç§é€šè¿‡åœ¨è¾“å…¥ä¸­æ’å…¥ç‰¹æ®Šæç¤ºæ¥å¼•å¯¼æ¨¡å‹å­¦ä¹ çš„æŠ€æœ¯ã€‚</li>\n<li><strong>å…¨é‡å¾®è°ƒ</strong>ï¼šå¯¹æ•´ä¸ªæ¨¡å‹è¿›è¡Œå‚æ•°è°ƒæ•´ä»¥æé«˜æ€§èƒ½çš„æ–¹æ³•ã€‚</li>\n<li><strong>å¤šä»»åŠ¡å­¦ä¹ </strong>ï¼šåŒæ—¶å­¦ä¹ å¤šä¸ªç›¸å…³ä»»åŠ¡ï¼Œä»¥æé«˜æ¨¡å‹åœ¨å„ä¸ªä»»åŠ¡ä¸Šçš„è¡¨ç°ã€‚</li>\n</ul>\n<h2 id=\"å®æ–½æ­¥éª¤\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å®æ–½æ­¥éª¤\"><span>å®æ–½æ­¥éª¤</span></a></h2>\n<ol>\n<li>âœ… åœ¨æ¯ä¸€å±‚åŠ å…¥ Prompts tokens ä½œä¸ºè¾“å…¥ã€‚</li>\n<li>âš  ç§»é™¤é‡å‚æ•°åŒ–çš„ç¼–ç å™¨ä»¥æé«˜è®­ç»ƒé€Ÿåº¦å’Œé²æ£’æ€§ã€‚</li>\n<li>â— é’ˆå¯¹ä¸åŒä»»åŠ¡é€‰æ‹©åˆé€‚çš„æç¤ºé•¿åº¦ã€‚</li>\n<li>âœ… å¼•å…¥å¤šä»»åŠ¡å­¦ä¹ è¿›è¡Œé¢„è®­ç»ƒã€‚\n<img src=\"/img/user/é™„ä»¶/Pasted image 20250424105959.png\" alt=\"Pasted image 20250424105959.png\"></li>\n</ol>\n<h2 id=\"ä»£ç å®ç°\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ä»£ç å®ç°\"><span>ä»£ç å®ç°</span></a></h2>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\">#è®¾ç½®virtual_tokençš„æ•°é‡åŠpast_key_valuesç»´åº¦</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prompt_tokens </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> prompt_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[:,</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_virtual_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">past_key_values </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> past_key_values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">view</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_virtual_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_layers </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> ,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_attention_heads</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">token_dim </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">//</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_attention_heads</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># prefix encoderç±»çš„å®šä¹‰</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"--shiki-light:#2E8F82;--shiki-dark:#5DA994\"> PrefixEncoder</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">Module</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">The torch.nn model to encode the prefix Input shape: (batch-size, prefix-length) Output shape: (batch-size, prefix-length, 2*layers*hidden) </span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">def</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> __init__</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> ChatGLMConfig </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">super</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> ().</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">__init__</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_projection </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_projection</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># self.prefix_projection=True-->prefix tuning</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># self.prefix_projection=False-->p-tuning v2</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_projection</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># Use a two-layer MLP to encode the prefix</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">kv_size </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_layers </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">kv_channels </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">multi_query_group_num </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 2</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">embedding </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">pre_seq_len</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> kv_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">trans </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Sequential</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Linear</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">kv_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">hidden_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tanh</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Linear</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">hidden_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> kv_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">else</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">embedding </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">pre_seq_len</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_layers </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">kv_channels </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">multi_query_group_num </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> )</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> forward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> prefix</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_projection</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_tokens </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">past_key_values </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">trans</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">else</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">past_key_values </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> past_key_values</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2 id=\"å¸¸è§é”™è¯¯\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¸¸è§é”™è¯¯\"><span>å¸¸è§é”™è¯¯</span></a></h2>\n<blockquote>\n<p>âš  ä½¿ç”¨ä¸åˆé€‚çš„æç¤ºé•¿åº¦å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ç¡®ä¿æ ¹æ®å…·ä½“ä»»åŠ¡è°ƒæ•´æç¤ºé•¿åº¦ã€‚</p>\n</blockquote>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ul>\n<li>ç ”ç©¶å¦‚ä½•åœ¨ç°æœ‰é¡¹ç›®ä¸­é›†æˆ P-Tuning V2ã€‚</li>\n<li>é’ˆå¯¹ç‰¹å®šä»»åŠ¡æµ‹è¯•ä¸åŒçš„æç¤ºé•¿åº¦ã€‚</li>\n<li>æ¢ç´¢å¤šä»»åŠ¡å­¦ä¹ åœ¨å…¶ä»–é¢†åŸŸçš„åº”ç”¨æ½œåŠ›ã€‚</li>\n</ul>\n<blockquote>\n<p>æ¥æºï¼šæœ¬æ–‡å†…å®¹æ¥æºäºå¯¹ P-Tuning V2 æŠ€æœ¯çš„æ€»ç»“ä¸åˆ†æã€‚</p>\n</blockquote>\n</template>","contentStripped":"<p>å…ƒæ•°æ®ï¼š</p>\n<p>åˆ†ç±»ï¼šè‡ªç„¶è¯­è¨€å¤„ç†</p>\n<p>æ ‡ç­¾ï¼šP-Tuning V2, è‡ªç„¶è¯­è¨€ç†è§£, æç¤ºä¼˜åŒ–</p>\n<p>æ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥</p>\n<h2 id=\"æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\"><span>æ ¸å¿ƒè§‚ç‚¹æ€»ç»“</span></a></h2>\n<p>P-Tuning V2 æ˜¯ä¸€ç§æ”¹è¿›çš„æç¤ºä¼˜åŒ–æŠ€æœ¯ï¼Œæ—¨åœ¨è§£å†³ä¹‹å‰æ–¹æ³•ä¸­å­˜åœ¨çš„æ¨¡å‹å‚æ•°è§„æ¨¡å’Œä»»åŠ¡é€šç”¨æ€§é—®é¢˜ã€‚é€šè¿‡åœ¨æ¯ä¸€å±‚åŠ å…¥æç¤ºï¼ˆPromptsï¼‰è€Œä¸ä»…ä»…æ˜¯è¾“å…¥å±‚ï¼ŒP-Tuning V2 æä¾›äº†æ›´å¤šå¯å­¦ä¹ çš„å‚æ•°ï¼Œå¹¶èƒ½æ›´ç›´æ¥å½±å“æ¨¡å‹é¢„æµ‹ã€‚ğŸ’¡è¿™ä½¿å¾—æç¤ºä¼˜åŒ–åœ¨è¾ƒå°æ¨¡å‹å’Œå¤šä»»åŠ¡å­¦ä¹ ä¸­è¡¨ç°æ›´ä¸ºä¼˜å¼‚ã€‚</p>\n<h2 id=\"é‡ç‚¹æ®µè½\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#é‡ç‚¹æ®µè½\"><span>é‡ç‚¹æ®µè½</span></a></h2>\n<ol>\n<li>\n<p><strong>ç¼ºä¹æ¨¡å‹å‚æ•°è§„æ¨¡å’Œä»»åŠ¡é€šç”¨æ€§</strong><br>\nä¹‹å‰çš„æç¤ºä¼˜åŒ–æ–¹æ³•åœ¨å¤§è§„æ¨¡æ¨¡å‹ä¸­è¡¨ç°è‰¯å¥½ï¼Œä½†åœ¨è¾ƒå°æ¨¡å‹ï¼ˆ100Måˆ°1Bå‚æ•°ï¼‰ä¸Šä¸å…¨é‡å¾®è°ƒå·®å¼‚æ˜¾è‘—ï¼Œé™åˆ¶äº†å…¶é€‚ç”¨æ€§ã€‚</p>\n</li>\n<li>\n<p><strong>æ·±åº¦æç¤ºä¼˜åŒ–çš„å¼•å…¥</strong><br>\nåœ¨æ¯ä¸€å±‚åŠ å…¥æç¤ºä»¤å¯å­¦ä¹ å‚æ•°å¢åŠ ï¼Œä»è€Œæå‡äº†å‚æ•°æ•ˆç‡å’Œæ¨¡å‹é¢„æµ‹çš„ç›´æ¥å½±å“ã€‚</p>\n</li>\n<li>\n<p><strong>å¤šä»»åŠ¡å­¦ä¹ å’Œæç¤ºé•¿åº¦ä¼˜åŒ–</strong><br>\né’ˆå¯¹ä¸åŒä»»åŠ¡é‡‡ç”¨ä¸åŒæç¤ºé•¿åº¦ï¼Œå¹¶é€šè¿‡å¤šä»»åŠ¡å­¦ä¹ è¿›è¡Œé¢„è®­ç»ƒï¼Œä»¥ç¼“è§£ä¼˜åŒ–å›°éš¾ã€‚</p>\n</li>\n</ol>\n<h2 id=\"æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°\"><span>æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°</span></a></h2>\n<ul>\n<li><strong>æç¤ºä¼˜åŒ–ï¼ˆPrompt Tuningï¼‰</strong>ï¼šä¸€ç§é€šè¿‡åœ¨è¾“å…¥ä¸­æ’å…¥ç‰¹æ®Šæç¤ºæ¥å¼•å¯¼æ¨¡å‹å­¦ä¹ çš„æŠ€æœ¯ã€‚</li>\n<li><strong>å…¨é‡å¾®è°ƒ</strong>ï¼šå¯¹æ•´ä¸ªæ¨¡å‹è¿›è¡Œå‚æ•°è°ƒæ•´ä»¥æé«˜æ€§èƒ½çš„æ–¹æ³•ã€‚</li>\n<li><strong>å¤šä»»åŠ¡å­¦ä¹ </strong>ï¼šåŒæ—¶å­¦ä¹ å¤šä¸ªç›¸å…³ä»»åŠ¡ï¼Œä»¥æé«˜æ¨¡å‹åœ¨å„ä¸ªä»»åŠ¡ä¸Šçš„è¡¨ç°ã€‚</li>\n</ul>\n<h2 id=\"å®æ–½æ­¥éª¤\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å®æ–½æ­¥éª¤\"><span>å®æ–½æ­¥éª¤</span></a></h2>\n<ol>\n<li>âœ… åœ¨æ¯ä¸€å±‚åŠ å…¥ Prompts tokens ä½œä¸ºè¾“å…¥ã€‚</li>\n<li>âš  ç§»é™¤é‡å‚æ•°åŒ–çš„ç¼–ç å™¨ä»¥æé«˜è®­ç»ƒé€Ÿåº¦å’Œé²æ£’æ€§ã€‚</li>\n<li>â— é’ˆå¯¹ä¸åŒä»»åŠ¡é€‰æ‹©åˆé€‚çš„æç¤ºé•¿åº¦ã€‚</li>\n<li>âœ… å¼•å…¥å¤šä»»åŠ¡å­¦ä¹ è¿›è¡Œé¢„è®­ç»ƒã€‚\n<img src=\"/img/user/é™„ä»¶/Pasted image 20250424105959.png\" alt=\"Pasted image 20250424105959.png\"></li>\n</ol>\n<h2 id=\"ä»£ç å®ç°\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#ä»£ç å®ç°\"><span>ä»£ç å®ç°</span></a></h2>\n<div class=\"language-python line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"python\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code><span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\">#è®¾ç½®virtual_tokençš„æ•°é‡åŠpast_key_valuesç»´åº¦</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prompt_tokens </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> prompt_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">[:,</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_virtual_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">]</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">past_key_values </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> past_key_values</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">view</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">batch_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_virtual_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_layers </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> ,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_attention_heads</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">token_dim </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">//</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> peft_config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_attention_heads</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># prefix encoderç±»çš„å®šä¹‰</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"--shiki-light:#2E8F82;--shiki-dark:#5DA994\"> PrefixEncoder</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">Module</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">The torch.nn model to encode the prefix Input shape: (batch-size, prefix-length) Output shape: (batch-size, prefix-length, 2*layers*hidden) </span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"\"\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">def</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\"> __init__</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> ChatGLMConfig </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">super</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> ().</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">__init__</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_projection </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_projection</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># self.prefix_projection=True-->prefix tuning</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># self.prefix_projection=False-->p-tuning v2</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_projection</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"># Use a two-layer MLP to encode the prefix</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">kv_size </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_layers </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">kv_channels </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">multi_query_group_num </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 2</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">embedding </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">pre_seq_len</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> kv_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">trans </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Sequential</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Linear</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">kv_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">hidden_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tanh</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(),</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Linear</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">hidden_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> kv_size</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">else</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">embedding </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">nn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">pre_seq_len</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">num_layers </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">kv_channels </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> config</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">multi_query_group_num </span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> )</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">def</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\"> forward</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">,</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> prefix</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> torch</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">Tensor </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">):</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_projection</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_tokens </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">past_key_values </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">trans</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix_tokens</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">else</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> :</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">past_key_values </span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">=</span><span style=\"--shiki-light:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">embedding</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\">prefix</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">return</span><span style=\"--shiki-light:#393A34;--shiki-dark:#DBD7CAEE\"> past_key_values</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2 id=\"å¸¸è§é”™è¯¯\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#å¸¸è§é”™è¯¯\"><span>å¸¸è§é”™è¯¯</span></a></h2>\n<blockquote>\n<p>âš  ä½¿ç”¨ä¸åˆé€‚çš„æç¤ºé•¿åº¦å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ç¡®ä¿æ ¹æ®å…·ä½“ä»»åŠ¡è°ƒæ•´æç¤ºé•¿åº¦ã€‚</p>\n</blockquote>\n<h2 id=\"è¡ŒåŠ¨æ¸…å•\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#è¡ŒåŠ¨æ¸…å•\"><span>è¡ŒåŠ¨æ¸…å•</span></a></h2>\n<ul>\n<li>ç ”ç©¶å¦‚ä½•åœ¨ç°æœ‰é¡¹ç›®ä¸­é›†æˆ P-Tuning V2ã€‚</li>\n<li>é’ˆå¯¹ç‰¹å®šä»»åŠ¡æµ‹è¯•ä¸åŒçš„æç¤ºé•¿åº¦ã€‚</li>\n<li>æ¢ç´¢å¤šä»»åŠ¡å­¦ä¹ åœ¨å…¶ä»–é¢†åŸŸçš„åº”ç”¨æ½œåŠ›ã€‚</li>\n</ul>\n<blockquote>\n<p>æ¥æºï¼šæœ¬æ–‡å†…å®¹æ¥æºäºå¯¹ P-Tuning V2 æŠ€æœ¯çš„æ€»ç»“ä¸åˆ†æã€‚</p>\n</blockquote>\n","tagOpen":"<template>","tagClose":"</template>"},"script":null,"scriptSetup":null,"scripts":[],"styles":[],"customBlocks":[]},"content":"å…ƒæ•°æ®ï¼š\n\nåˆ†ç±»ï¼šè‡ªç„¶è¯­è¨€å¤„ç†\n\næ ‡ç­¾ï¼šP-Tuning V2, è‡ªç„¶è¯­è¨€ç†è§£, æç¤ºä¼˜åŒ–\n\næ—¥æœŸï¼š2025å¹´4æœˆ12æ—¥\n\n## æ ¸å¿ƒè§‚ç‚¹æ€»ç»“\nP-Tuning V2 æ˜¯ä¸€ç§æ”¹è¿›çš„æç¤ºä¼˜åŒ–æŠ€æœ¯ï¼Œæ—¨åœ¨è§£å†³ä¹‹å‰æ–¹æ³•ä¸­å­˜åœ¨çš„æ¨¡å‹å‚æ•°è§„æ¨¡å’Œä»»åŠ¡é€šç”¨æ€§é—®é¢˜ã€‚é€šè¿‡åœ¨æ¯ä¸€å±‚åŠ å…¥æç¤ºï¼ˆPromptsï¼‰è€Œä¸ä»…ä»…æ˜¯è¾“å…¥å±‚ï¼ŒP-Tuning V2 æä¾›äº†æ›´å¤šå¯å­¦ä¹ çš„å‚æ•°ï¼Œå¹¶èƒ½æ›´ç›´æ¥å½±å“æ¨¡å‹é¢„æµ‹ã€‚ğŸ’¡è¿™ä½¿å¾—æç¤ºä¼˜åŒ–åœ¨è¾ƒå°æ¨¡å‹å’Œå¤šä»»åŠ¡å­¦ä¹ ä¸­è¡¨ç°æ›´ä¸ºä¼˜å¼‚ã€‚\n\n\n## é‡ç‚¹æ®µè½\n1. **ç¼ºä¹æ¨¡å‹å‚æ•°è§„æ¨¡å’Œä»»åŠ¡é€šç”¨æ€§**  \n   ä¹‹å‰çš„æç¤ºä¼˜åŒ–æ–¹æ³•åœ¨å¤§è§„æ¨¡æ¨¡å‹ä¸­è¡¨ç°è‰¯å¥½ï¼Œä½†åœ¨è¾ƒå°æ¨¡å‹ï¼ˆ100Måˆ°1Bå‚æ•°ï¼‰ä¸Šä¸å…¨é‡å¾®è°ƒå·®å¼‚æ˜¾è‘—ï¼Œé™åˆ¶äº†å…¶é€‚ç”¨æ€§ã€‚\n\n2. **æ·±åº¦æç¤ºä¼˜åŒ–çš„å¼•å…¥**  \n   åœ¨æ¯ä¸€å±‚åŠ å…¥æç¤ºä»¤å¯å­¦ä¹ å‚æ•°å¢åŠ ï¼Œä»è€Œæå‡äº†å‚æ•°æ•ˆç‡å’Œæ¨¡å‹é¢„æµ‹çš„ç›´æ¥å½±å“ã€‚\n\n3. **å¤šä»»åŠ¡å­¦ä¹ å’Œæç¤ºé•¿åº¦ä¼˜åŒ–**  \n   é’ˆå¯¹ä¸åŒä»»åŠ¡é‡‡ç”¨ä¸åŒæç¤ºé•¿åº¦ï¼Œå¹¶é€šè¿‡å¤šä»»åŠ¡å­¦ä¹ è¿›è¡Œé¢„è®­ç»ƒï¼Œä»¥ç¼“è§£ä¼˜åŒ–å›°éš¾ã€‚\n\n\n## æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°\n- **æç¤ºä¼˜åŒ–ï¼ˆPrompt Tuningï¼‰**ï¼šä¸€ç§é€šè¿‡åœ¨è¾“å…¥ä¸­æ’å…¥ç‰¹æ®Šæç¤ºæ¥å¼•å¯¼æ¨¡å‹å­¦ä¹ çš„æŠ€æœ¯ã€‚\n- **å…¨é‡å¾®è°ƒ**ï¼šå¯¹æ•´ä¸ªæ¨¡å‹è¿›è¡Œå‚æ•°è°ƒæ•´ä»¥æé«˜æ€§èƒ½çš„æ–¹æ³•ã€‚\n- **å¤šä»»åŠ¡å­¦ä¹ **ï¼šåŒæ—¶å­¦ä¹ å¤šä¸ªç›¸å…³ä»»åŠ¡ï¼Œä»¥æé«˜æ¨¡å‹åœ¨å„ä¸ªä»»åŠ¡ä¸Šçš„è¡¨ç°ã€‚\n\n\n## å®æ–½æ­¥éª¤\n1. âœ… åœ¨æ¯ä¸€å±‚åŠ å…¥ Prompts tokens ä½œä¸ºè¾“å…¥ã€‚\n2. âš  ç§»é™¤é‡å‚æ•°åŒ–çš„ç¼–ç å™¨ä»¥æé«˜è®­ç»ƒé€Ÿåº¦å’Œé²æ£’æ€§ã€‚\n3. â— é’ˆå¯¹ä¸åŒä»»åŠ¡é€‰æ‹©åˆé€‚çš„æç¤ºé•¿åº¦ã€‚\n4. âœ… å¼•å…¥å¤šä»»åŠ¡å­¦ä¹ è¿›è¡Œé¢„è®­ç»ƒã€‚\n![Pasted image 20250424105959.png](/img/user/%E9%99%84%E4%BB%B6/Pasted%20image%2020250424105959.png)\n\n\n## ä»£ç å®ç°\n```Python\n#è®¾ç½®virtual_tokençš„æ•°é‡åŠpast_key_valuesç»´åº¦\nprompt_tokens = prompt_tokens[:, : peft_config.num_virtual_tokens]\npast_key_values = past_key_values.view(\nbatch_size,peft_config.num_virtual_tokens,\npeft_config.num_layers * 2 ,\npeft_config.num_attention_heads,\npeft_config.token_dim // peft_config.num_attention_heads,\n)\n# prefix encoderç±»çš„å®šä¹‰\nclass PrefixEncoder (torch.nn.Module):\n\"\"\"\nThe torch.nn model to encode the prefix Input shape: (batch-size, prefix-length) Output shape: (batch-size, prefix-length, 2*layers*hidden) \"\"\"\ndef __init__ ( self, config: ChatGLMConfig ):\nsuper ().__init__()\nself.prefix_projection = config.prefix_projection\n# self.prefix_projection=True-->prefix tuning\n# self.prefix_projection=False-->p-tuning v2\nif self.prefix_projection:\n# Use a two-layer MLP to encode the prefix\nkv_size = config.num_layers * config.kv_channels * config.multi_query_group_num * 2\nself.embedding = torch.nn.Embedding(config.pre_seq_len, kv_size)\nself.trans = torch.nn.Sequential(\ntorch.nn.Linear(kv_size, config.hidden_size),\ntorch.nn.Tanh(),\ntorch.nn.Linear(config.hidden_size, kv_size)\n)\nelse :\nself.embedding = torch.nn.Embedding(config.pre_seq_len,\nconfig.num_layers * config.kv_channels * config.multi_query_group_num * 2 )\ndef forward ( self, prefix: torch.Tensor ):\nif self.prefix_projection:\nprefix_tokens = self.embedding(prefix)\npast_key_values = self.trans(prefix_tokens)\nelse :\npast_key_values = self.embedding(prefix)\nreturn past_key_values\n\n```\n\n\n## å¸¸è§é”™è¯¯\n> âš  ä½¿ç”¨ä¸åˆé€‚çš„æç¤ºé•¿åº¦å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ç¡®ä¿æ ¹æ®å…·ä½“ä»»åŠ¡è°ƒæ•´æç¤ºé•¿åº¦ã€‚\n\n\n## è¡ŒåŠ¨æ¸…å•\n- ç ”ç©¶å¦‚ä½•åœ¨ç°æœ‰é¡¹ç›®ä¸­é›†æˆ P-Tuning V2ã€‚\n- é’ˆå¯¹ç‰¹å®šä»»åŠ¡æµ‹è¯•ä¸åŒçš„æç¤ºé•¿åº¦ã€‚\n- æ¢ç´¢å¤šä»»åŠ¡å­¦ä¹ åœ¨å…¶ä»–é¢†åŸŸçš„åº”ç”¨æ½œåŠ›ã€‚\n\n> æ¥æºï¼šæœ¬æ–‡å†…å®¹æ¥æºäºå¯¹ P-Tuning V2 æŠ€æœ¯çš„æ€»ç»“ä¸åˆ†æã€‚","excerpt":"","includedFiles":[],"tasklistId":0,"title":"","headers":[{"level":2,"title":"æ ¸å¿ƒè§‚ç‚¹æ€»ç»“","slug":"æ ¸å¿ƒè§‚ç‚¹æ€»ç»“","link":"#æ ¸å¿ƒè§‚ç‚¹æ€»ç»“","children":[]},{"level":2,"title":"é‡ç‚¹æ®µè½","slug":"é‡ç‚¹æ®µè½","link":"#é‡ç‚¹æ®µè½","children":[]},{"level":2,"title":"æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°","slug":"æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°","link":"#æŠ€æœ¯æœ¯è¯­é€šä¿—è½¬è¿°","children":[]},{"level":2,"title":"å®æ–½æ­¥éª¤","slug":"å®æ–½æ­¥éª¤","link":"#å®æ–½æ­¥éª¤","children":[]},{"level":2,"title":"ä»£ç å®ç°","slug":"ä»£ç å®ç°","link":"#ä»£ç å®ç°","children":[]},{"level":2,"title":"å¸¸è§é”™è¯¯","slug":"å¸¸è§é”™è¯¯","link":"#å¸¸è§é”™è¯¯","children":[]},{"level":2,"title":"è¡ŒåŠ¨æ¸…å•","slug":"è¡ŒåŠ¨æ¸…å•","link":"#è¡ŒåŠ¨æ¸…å•","children":[]}]}}
